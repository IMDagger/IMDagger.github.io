Клонирование образов
====================
:date: 2009-09-28 14:16:11
:tags: clonezilla, samba4, восстановление, boot, drbl
:category: text
:author: IMDagger
:yaru-link: http://imdagger.ya.ru/replies.xml?item_no=262

В моей ситуации PDC сервером является **Samba 4.0.0-alpha9** из GIT.
А клиентские компьютеры под управлением Window$ XP. Был сделан новый
образ с одного компьютера, чтобы поставить его на все остальные
(разметка таже, только операционная система обновлена). Я решил, что
удобнее хранить на сервере одну копию образа и восстанавливать её по
сети, используя PXE для загрузки.

Первая проблема, которая встала передо мной — при попытке
восстановления образа выпадала ошибка, что не удалось клонировать sda2
(но mbr :del:`сволочь` всё таки Clonezilla заменила). Забавно было, что
разбивка на компьютерах одна и также, но я заметил, что создавал образ с
**sda1**, а пытался восстановить на **sda2** такой же по размеру и
:underline:`начинающийся в тех же секторах`. Тогда я залез в папку с образом (у меня
/home/partimag) и поправил файлы:

    | /home/partimag/имя-образа/parts:
    | было **sda1** стало **sda2**
    | /home/partimag/имя-образа/sda-pt.parted
    | Поменял номера разделов (поле Number) 
    | **1** <-> **2**
    | /home/partimag/имя-образа/sda-pt.sf
    | Обменял **sda1** <-> **sda2** (**sda1** - это диск D:)

После этих хитрых манипуляций образ поставился, но система наотрез
отказалась запускаться ссылаясь на «повреждённый hal.dll». Снова
поразмыслив, я написал небольшой скрипт и положил его в
**/opt/drbl/share/drbl/postrun**, чтобы после успешного клонирования был
он вызван и исправил в boot.ini на диске строки partition(1) на
partition(\ **id**), где id — номер раздела, который загрузочный.


.. alert-danger::
   **Осторожно!** Если не понятно, что делает этот скрипт, то не при каких
   обстоятельствах его не использовать, т.к. он производит слишком
   мало проверок на корректность своих действий (и обрабатывает только
   sda1, sda2, hda1, hda2 и только ntfs), а также пользуется пакетом
   ntfsprogs, который должен быть **обязательно установлен**

.. cut:: хочу узреть программу!
   :paragraph: yes

   .. code-block:: bash

      #! /bin/sh
      for id in 1 2; do
         for hdd in hda sda; do
            disk=$hdd$id
            echo "Trying $disk ..."

            if [ ! -z `ntfsls -f /dev/$disk \| grep boot.ini` ]; then
               echo "Found primary boot disk ..."
               ntfscat -f /dev/$disk boot.ini >/root/boot.ini
               if [ -z `cat /root/boot.ini` ]; then
                  echo "Error!"
                  exit 1;
               fi

               echo "Try to fix disk ..."
               ntfsfix /dev/$disk
               sed "s/\(.*\)partition([01234]\?)\(.*\)/\1partition($id)\2/" /root/boot.ini >/root/boot_new.ini
               echo "Replace boot.ini by new"
               ntfscp -f /dev/$disk /root/boot_new.ini boot.ini
            else
               echo "Not found boot.ini"
            fi
         done
      done

Вуаля и о чудо, винда загрузилась… Но… при попытке ввести в домен
выпала ошибка «Именам пользователей не сопоставлены коды защиты данных».
Я заглянул на сервер в LDAP-директорию и обнаружил компьютер 2-5-9 с
CN=2-5-0, а именем 2-5-9. Ясно, что из-за одинакового имени всех
компьютеров из образа — 2-5-0 (можно было раздавать имена средствами
Clonezilla, там есть даже галочка для этого, но мне было лень делать
список MAC-адресов). Тогда, чтобы эта ошибка не выпадала, я:

#. Удалил запись 2-5-0 из LDAP от Samba4;
#. Переименовывал машины без ввода в домен и с перезагрузкой;
#. Только после перезагрузки вводил в домен.
#. И вот всё заработало как надо.
