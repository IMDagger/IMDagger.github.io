Samba4 и копирование ACL
========================
:date: 2009-12-24 18:10:32
:tags: samba4, acl, копирование
:category: text
:author: IMDagger
:yaru-link: http://imdagger.ya.ru/replies.xml?item_no=547

Samba4 сохраняет ACL права файлов и папок в их расширенные атрибуты
файловой системы, если включён параметр *user\_xattr* у неё при
монтировании. Два основных расширенных атрибута, которые появляются:
**user.DosAttrib**, **security.NTACL**. Список атрибутов можно получить
при помощи :code:`attr -l файл` (для этого должна быть установлена libattr).
Проблема в том, что у меня не получилось прочитать при помощи *getfattr*
атрибут из раздела security. Да и хотелось утилиту, которая сама
скопирует все параметры файла. Мне это нужно, чтобы переместить на
другой раздел другого LVM все папки пользователей с правами, которые
были. Простой *cp* не хочет копировать эти атрибуты. А среди всех
программ не нашлось подходящей. И только, когда я скачал исходники
libattr, то нашёл в папке examples файл :code:`copyattr.c`. Я его
скомпилировал таким способом (это после компиляции самой библиотеки и
приложений attr, getfattr и setfattr):

    **gcc** -DHAVE\_ATTR\_ERROR\_CONTEXT\_H -DHAVE\_ATTR\_LIBATTR\_H
    -I../include -DHAVE\_ATTR\_COPY\_FILE **copyattr.c**
    ../libattr/.libs/libattr.a -o **copyattr**

Не забываем подправить исходный код утилиты, т.к. она копирует только
user.\*, а нужно всё. Для этого в файле исправил функцию
**is\_user\_attr**, пусть она возвращает всегда 1. Получившийся бинарный
файл необходимо положить в /usr/bin к остальным программам. Сначала я
скопировал все файлы обычным способом, а затем рекурсивно перекопировал
атрибуты используя утилиту find и её параметр -exec:

    **find** директория\_для\_копирования **-exec** /usr/bin/copyattr
    \\{\\} путь\_на\_другом\_винчестере\_к\_такой\_же\_дирекотрии/\\{\\} \\;
