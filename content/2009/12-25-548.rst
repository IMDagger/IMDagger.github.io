Квотирование
============
:date: 2009-12-25 21:23:19
:tags: samba4, квотирование, квота
:category: text
:author: IMDagger
:yaru-link: http://imdagger.ya.ru/replies.xml?item_no=548

Создал отдельный LVM раздел, где хранятся директории пользователей.
Включил квотирование для раздела. Но я копировал эти папки со старого
сервера и естественно владельцы не могли сохраниться в Unix-правах, т.к.
предыдущий сервер был не на Samba :). Поэтому я написал скрипт, который
получает по UID пользователя его SID в AD Samba4, затем по SID получает
его домашнюю директорию, а после этих всех операций выполяет :code:`chown -R
код\_пользователя домашняя\_директория`. После этого файлами, которыми
владел root, и ему они засчитывались в квоту, начали обладать настоящие
хозяева. Samba4 у меня установлена в /opt, поэтому все связанные с ней в
примере начинаются на /opt. Скрипт *sidbyid.sh*, который по UID
определяет SID пользователя:

    **/opt/bin/ldbsearch** -H **/opt/private/idmap.ldb** "(xidNumber=$1)" \|
    grep "objectSid:" \| sed 's/objectSid: //'

Другой сценарий homebysid.sh определяет каталог пользователя:

   **/opt/bin/ldbsearch** -H **/opt/private/sam.ldb** "(objectSid=$1)" \|
   grep "homeDirectory:" \| sed 's/homeDirectory: //'

При помощи этих утилит можно получить домашнюю директорию
пользователя с UID равным *3000016*: :code:`./homebysid.sh \`./sidbyid.sh 3000016\``.

Возможно они не достаточно эффективны и можно сделать лучше, но мне
они потребовались всего один раз для ~1000 пользователей. Думаю
пригодятся ещё но только эпизодически и уже не для больших групп.
