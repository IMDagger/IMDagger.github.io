Нарушенная Samba4
=================
:date: 2010-08-08 12:12:42
:tags: ошибка, исправление, радость, работает, samba4, Я, повезло, работа
:category: text
:author: IMDagger
:yaru-link: http://imdagger.ya.ru/replies.xml?item_no=1054

Ни с того ни с сего сдохла Samba4. Но перестала работать по
особенному, что дало мне время подумать и спокойно решить проблему.
Хорошо, что проблема выявилась быстро, нужно было ввести машину в домен,
а получили отказ. Взглянув в логи я чуть не поседел:

  | [Wed Aug 4 11:23:07 2010 EEST, 0
    lib/ldb\_wrap.c:66:ldb\_wrap\_debug()]
  | ldb: ltdb: tdb(/opt/private/users.ldb): tdb\_rec\_read bad magic
    **0xd9fee666** at offset=42488496

Я понял, что база пользователей нарушена, а там же 70 мегов инфы.
Решил отложить разборки на выходные, благо авторизация работала и база
была испорчена не фатально, не работала только запись в базу и чтение
некоторых разделов базы.

У меня был бэкап только месячной давности, но он очень помог (все
никак руки не дойдут на этом полигонном сервере сделать резервное
копирование). Сосредоточив мысли и успокоив себя, что всё не так уж и
плохо я стал препарировать пациента. В первую очередь сделал копию того,
что есть! И отметил, что она corrupted.

Затем я взглянул, что там за запись по адресу 42488496, я посмотрел
в бэкапе и в текущей базе, благо не сильно много менялось. И обнаружил,
что в бэкапе пару 16-байтных страниц вперёд от данного адреса 0x99 0x19
0x01 0x26 (т.е. 0x26011999), а в испорченном users.ldb запись не такая,
но похожая с 0x66 0xE6 0xFE 0xD9 (0xD9FEE666). И я вдруг заметил
некоторую связь: **(0x26011999 + 0xD9FEE666 + 1) = 0**. Круто подумал я,
ведь получается, что одно число **A**, а другое **not(A)**. Я исправил
только этих 4 байта, на правильные. Затем мне помогла утилита ldbedit из
поставки Samba4: я запускал :code:`ldbedit -H лалала/users\_copy.ldb`, оно мне
назвало адрес и снова говорило, что magic неверный. Я правил и так ещё
пару раз. В конце-концов всё открылось. Я перезаписал users.ldb
исправленной версией users\_copy.ldb и всё заработало снова.

P.S. /me ушёл заводить систему резервного копирования (эти базы стоит
раз в день сохранять).
