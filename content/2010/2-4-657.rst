А ларчик просто открывался
==========================
:date: 2010-02-04 16:16:58
:tags: blender, возможности, bge, x-ray
:category: text
:author: IMDagger
:yaru-link: http://imdagger.ya.ru/replies.xml?item_no=657

Сел вчера ночью дома за машинку. Решил основательно потестировать,
почему код, который я добавляю в отрисовку в Blender с трафаретным
буфером не работает. Написал малюсенький кусочек кода для включения
GL\_STENCIL\_TEST и вывода треугольника, отключил вывод мешей самого
Ketsji. Включил функцию GL\_NEVER, что означало, что я хочу использовать
трафарет, но мне нужно изображение на экране. И я получил такой же
результат, как на работе — изображение выводилось и игнорировало то, что
мне нужна проверка трафарета. Тогда я добавил после каждой gl-функции
строчку :code:`printf("%d\\n", glGetError());`. И о чудо! Я увидел код
ошибки 1280 для glEnable(GL\_STENCIL\_TEST), а для включения функций
были ошибки 1282. Вторая ошибка меня не смутила — мало ли, она гласит,
что это неверная операция или невозможна в данном контексте. А вот
первая посеяла в моём мозгу мысль: «Не может быть! Это же значит, что я
передал неверную константу, но она же определена в заголовочном файле
для драйвера карты!».

Ещё больше меня смущало, что тест трафарета работает на моих
отдельных примерах. Но… все они создавали окно при помощи GLUT. Я нашёл
какой-то завалявшийся пример в /usr/share/doc на Perl’е для OpenGL через
SDL и добавил туда проверку трафарета. И.. опять таже ошибка, хотя на
работе Mesa говорит всё время, что ошибки нет. Самое главное и общее тут
выходит — трафарет не работает.

Хорошенько выспавшись я осознал, что  нужно искать, где Blender
создаёт окно для вывода контекста. Я рылся в **blender/source** и ничего
не мог найти подходящего. Но потом я нашёл весь платформозависимой код в
**blender/intern/ghost**. Это был файл GHOST\_WindowX11.cpp (для винды —
GHOST\_WindowWin32.cpp).

И стоило сказать волшебное слово :code:`attributes[i++] =
GLX\_STENCIL\_SIZE; attributes[i++] = 1;` — и проверка трафарета
заработала, потому что я включил при создании окна эту возможность.
Аналогично в файле для Win32 нужно подправить массив параметров для
создания окна.

P.S. Ура! Значит скоро обещанный X-Ray в BGE заработает.
