Opera, jQuery и POST
====================
:date: 2012-01-24 20:28:53
:modified: 2012-01-24 20:33:18
:tags: ошибка, xml, jquery, opera, POST, python, CGI
:category: text
:author: IMDagger
:yaru-link: http://imdagger.ya.ru/replies.xml?item_no=1540

Обнаружил сегодня, что запросы из jQuery с использованием метода
POST, если data является пустым словарём (т.е. никаких аргументов не
передаём), то Opera выставляет Content-Type: text/xml; encoding=utf-8, и
это негативно сказывается на cgi.py из стандартной библиотеки Python.
Стандартный библиотечный FieldStorage решает, что нужно попробовать
считать аргумент как есть, т.к. тип данных не ясен. Но данные реально
отсутствуют и последующие попытки проверки параметров при помощи
has\_key проваливаются, т.к. внутри стоит специальная проверка на такие
None случаи неполной инициализации. Вот код из cgi.py из Python 2.7.2,
который проверяет тип содержимого:

.. code-block:: python

   ...

   if ctype == 'application/x-www-form-urlencoded':
       self.read_urlencoded()
   elif ctype[:10] == 'multipart/':
       self.read_multi(environ, keep_blank_values, strict_parsing)
   else:
       self.read_single()

   ...

Как лечится? В принципе есть несколько путей решения проблемы:
добавить фиктивный параметр равный null в POST запросе из jQuery (что
прекрасно решает проблему без дополнительных телодвижений), унаследовать
FieldStorage и расширить его функционал, чтобы он обрабатывал случай для
text/xml (что не особо хочется).

Я выбрал первый вариант и мне стало получше, правда наверное нужно
для непонятных типов содержимого отвечать клиенту каким-нибудь особым
HTTP-кодом.
