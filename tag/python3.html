<!DOCTYPE html>
<html lang="ru">
    <head>
        <meta charset="utf-8" />
        <title>IMDagger: Дневник</title>
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <meta name="description" content="" />
        <meta name="author" content="Alex Moiseenko" />
        <!-- Open Graph -->
        <link rel="stylesheet" href="http://maxcdn.bootstrapcdn.com/bootstrap/3.2.0/css/bootstrap.min.css" />
        <link rel="stylesheet" href="http://netdna.bootstrapcdn.com/font-awesome/4.0.3/css/font-awesome.min.css" />
        <link rel="shortcut icon" href="/favicon.ico" />
        <link rel="stylesheet" href="/theme/css/html4css1.css" />
        <link rel="stylesheet" href="/theme/css/style.css" />
        <link rel="stylesheet" href="/theme/css/pygment.css" />
        <link rel="stylesheet" href="/theme/css/math.css" />
        <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.11.1/jquery.min.js"></script>
        <script src="http://maxcdn.bootstrapcdn.com/bootstrap/3.2.0/js/bootstrap.min.js"></script>
        <script type="text/x-mathjax-config">
         MathJax.Hub.Config({
             'HTML-CSS': {
                 linebreaks: {
                     automatic: true,
                     width: 'container'
                 }
             },
             tex2jax: {
                 inlineMath: [['$math$','$/math$']],
                 displayMath: [['$$math$$','$$/math$$']],
                 skipTags: ['pre', 'code'],
                 preview: ['формула...'],
                 ignoreClass: 'math-ignore'
             }
         });
        </script>
        <script type="text/javascript" src="http://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS_HTML"></script>


        <script src="http://s3.amazonaws.com/nwapi/nwmatcher/nwmatcher-1.2.5-min.js"></script>
        <!--[if (gte IE 6)&(lte IE 8)]>
          <script type="text/javascript" src="/theme/js/selectivizr-min.js"></script>
          <noscript><link rel="stylesheet" href="[fallback css]" /></noscript>
        <![endif]-->

        <!-- HTML5 shim, for IE6-8 support of HTML5 elements -->
        <!--[if lt IE 9]>
        <script src="http://html5shim.googlecode.com/svn/trunk/html5.js"></script>
        <![endif]-->
    </head>

    <body>
        <div class="row page-head">
            <div class="row page-head-status page-head-status-top"><div class="col-sm-12 b-status mine"><p><i></i><a href="#" title="настроение" class="b-consistent-link"><b>ни к чему чужое мнение, в моде самовыражение</b></a></p></div></div>
            <div class="col-sm-2 page-left">
                <a href="#">
                    <img src="http://upics.yandex.ru/22199227/normal" ilo-full-src="http://upics.yandex.ru/22199227/normal">
                </a>
            </div>
            <div class="col-sm-10 all-posts">
                <div class="title-container">
                    <h1><b><a href="http://imdagger.github.io/" class="fn nickname">IMDagger</a></b></h1>
                </div>
                <div class="title-menu">
                    <ul class="nav nav-tabs" role="tablist">
                        <li class="active">
                            <a href="#">Дневник</a>
                        </li>
                        <li><a href="#">О себе</a></li>
                        <li><a href="#">Фотки</a></li>
                    </ul>
                </div>
            </div>
        </div>
        <div class="row page-body">
<div class="col-sm-2 page-left">
<div class="row widget widget-photo">
    <a href="posts/2011/08/07/aga-popalsia/" class="b-user-photo__link"><img class="b-user-photo__img" src=" http://img-fotki.yandex.ru/get/5409/22199227.a/0_625fc_e780ccc7_L
?log_nocount=64720402854"></a>
</div><div class="row widget">
    <div class="widget-content b-user-info">
        <div class="widget__body">
            <div class="widget-user-info__age">
                <i class="widget-user-info__sex widget-user-info__sex_type_"></i> 26&nbsp;лет
            </div>
            <div class="widget-user-info__place">
                <a href="#">Гомель</a>,                <a href="#">Беларусь</a>            </div>
            <ul class="contacts">
                <li class="contact contact-type-email"><i></i><a href="mailto:imdagger@yandex.ru">imdagger@yandex.ru</a></li>
                <li class="contact contact-type-ya-online"><i></i>imdagger@ya.ru</li>
                <li class="contact contact-type-icq"><i></i>350395088</li>
            </ul>
        </div>
    </div>
</div>

<div class="row widget">
    <div class="widget-content">
        <div class="widget__title">
            <div class="widget__title-link">Популярное в дневнике</div>
        </div>
        <div class="widget__body">
            <div class="widget-line">
                <div class="widget-entry">
                    <div class="widget-day__title">25&nbsp;июня</div>
                    <div class="widget-entry clearfix">
                        <div class="widget-entry__item">
                            <div class="widget-entry__title">
                                <a href="#" class="h-link">&nbsp;&nbsp;&nbsp; Висцеральная теория сна выглядит стр…</a>
                            </div>
                            <div class="widget-entry__info">2&nbsp;ответа</div>
                        </div>
                    </div>
                </div>
                <div class="widget-entry">
                    <div class="widget-day__title">16&nbsp;мая</div>
                    <div class="widget-entry clearfix">
                        <div class="widget-entry__item">
                            <div class="widget-entry__title">
                                <a href="#" class="h-link">Пожалуй у ByFly сегодня даже более серьё…</a>
                            </div>
                            <div class="widget-entry__info">2&nbsp;ответа</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div></div>

<div class="col-sm-10 all-posts">
<div class="row b-post-filter">
    <span class="pull-right">
        записи по
        <div class="btn-group">
            <span type="button" class="pseudo-link" data-toggle="dropdown">месяцам</span>
            <ul class="dropdown-menu dropdown-menu-right" role="menu">
                <li><a href="#" class="h-link">Нулябрь</a><li>
                <li><a href="#" class="h-link">Первябрь</a><li>
            </ul>
        </div> ·
        <div class="btn-group">
            <span type="button" class="pseudo-link" data-toggle="dropdown">меткам</span>
            <ul class="dropdown-menu dropdown-menu-right" role="menu">                <li>                    <a class="tag-2" href="/tag/linux.html" class="h-link">linux</a>                    <a class="tag-1" href="/tag/radost.html" class="h-link">радость</a>                    <a class="tag-1" href="/tag/python.html" class="h-link">python</a>                    <a class="tag-1" href="/tag/bge.html" class="h-link">bge</a>                    <a class="tag-2" href="/tag/iandeks.html" class="h-link">Яндекс</a>                </li>                <li>                    <a class="tag-2" href="/tag/google.html" class="h-link">google</a>                    <a class="tag-2" href="/tag/icfpc.html" class="h-link">icfpc</a>                    <a class="tag-1" href="/tag/blender.html" class="h-link">blender</a>                    <a class="tag-1" href="/tag/programmirovanie.html" class="h-link">программирование</a>                    <a class="tag-2" href="/tag/bredni.html" class="h-link">бредни</a>                </li>                <li>                    <a class="tag-2" href="/tag/java.html" class="h-link">java</a>                    <a class="tag-1" href="/tag/rabota.html" class="h-link">работа</a>                    <a class="tag-1" href="/tag/oshibka.html" class="h-link">ошибка</a>                    <a class="tag-2" href="/tag/emacs.html" class="h-link">emacs</a>                    <a class="tag-2" href="/tag/eda.html" class="h-link">еда</a>                </li>                <li>                    <a class="tag-1" href="/tag/ia.html" class="h-link">Я</a>                    <a class="tag-1" href="/tag/zhizn.html" class="h-link">жизнь</a>                    <a class="tag-2" href="/tag/javascript.html" class="h-link">javascript</a>                    <a class="tag-1" href="/tag/nabrosok.html" class="h-link">набросок</a>                    <a class="tag-2" href="/tag/sborka.html" class="h-link">сборка</a>                </li>            </ul>
        </div> ·
        <div class="btn-group">
            <span type="button" class="pseudo-link" data-toggle="dropdown">типам</span>
            <ul class="dropdown-menu dropdown-menu-right" role="menu">
                <li><a href="/category/description.html" class="h-link">обращение</a><li>
                <li><a href="/category/friend.html" class="h-link"></a><li>
                <li><a href="/category/join.html" class="h-link"></a><li>
                <li><a href="/category/link.html" class="h-link">ссылки</a><li>
                <li><a href="/category/mood.html" class="h-link">настроение</a><li>
                <li><a href="/category/photo.html" class="h-link">фото</a><li>
                <li><a href="/category/text.html" class="h-link">текст</a><li>
                <li><a href="/category/video.html" class="h-link">видео</a><li>
                <li><a href="/category/wishlist.html" class="h-link"></a><li>
            </ul>
        </div>
    </span>
</div>
    <div class="row b-post">
<div class="panel panel-text">
    <div class="panel-heading b-post-type b-post-type-text">
        <b class="b-user">
            <a class="b-user__link" href="author/imdagger.html"><b class="b-user__first-letter">I</b>MDagger</a>
        </b>
написал        <span class="pull-right b-date">
            <a class="h-link" href="/posts/2013/02/05/beskonechnaia-blokirovka/" title="изменено 5 февраля 2013 года в 23:43">
                5 февраля 2013 года, 23:41
            </a>
        </span>
    </div>
    <div class="panel-body">
        <div class="col-sm-1 b-post__layout-left">
            <a href="author/imdagger.html"><img src="http://upics.yandex.ru/22199227/middle"></a>
        </div>
        <div class="col-sm-11 b-right-col">
<div class="row tags-row">
    <span class="tag"><a class="h-link" href="/tag/pul.html">пул</a></span>,    <span class="tag"><a class="h-link" href="/tag/neiavnyi.html">неявный</a></span>,    <span class="tag"><a class="h-link" href="/tag/pool.html">pool</a></span>,    <span class="tag"><a class="h-link" href="/tag/blokirovka.html">блокировка</a></span>,    <span class="tag"><a class="h-link" href="/tag/gevent.html">gevent</a></span>,    <span class="tag"><a class="h-link" href="/tag/python.html">python</a></span></div>
            <div class="post-title">
<a class="no-link" href="/posts/2013/02/05/beskonechnaia-blokirovka/">Бесконечная блокировка</a>            </div>
            <div class="row post-body">
                <div class="b-text">
<p>Как получить ситуацию, что gevent выдаст исключение о бесконечно
блокирующейся операции? Сделать бесконечный цикл? Нет. Достаточно, чтобы
операция сама себя ожидала, но как это сделать неявным образом, чтобы
пример не был высосан из пальца и был похож на настоящую ситуацию.
Достаточно просто.</p>
<p>Допустим есть потребность выполнять какую-то операцию (например
краулинг и парсинг страниц) в ограниченном количестве параллельных
потоком. Мы берём для этого пул с ограниченным размером. Затем для
каждой страницы мы хотим порождать отдельный поток (т.к. микропотоки
достаточно дешёвые), мы пишем что-то типа такого:</p>
<div class="highlight"><pre><span class="pgcss-gp">&gt;&gt;&gt; </span><span class="pgcss-n">p</span> <span class="pgcss-o">=</span> <span class="pgcss-n">gevent</span><span class="pgcss-o">.</span><span class="pgcss-n">pool</span><span class="pgcss-o">.</span><span class="pgcss-n">Pool</span><span class="pgcss-p">(</span><span class="pgcss-mi">10</span><span class="pgcss-p">)</span>
<span class="pgcss-gp">&gt;&gt;&gt; </span><span class="pgcss-k">for</span> <span class="pgcss-n">_</span> <span class="pgcss-ow">in</span> <span class="pgcss-nb">xrange</span><span class="pgcss-p">(</span><span class="pgcss-mi">5</span><span class="pgcss-p">):</span>
<span class="pgcss-gp">... </span>      <span class="pgcss-n">p</span><span class="pgcss-o">.</span><span class="pgcss-n">spawn</span><span class="pgcss-p">(</span><span class="pgcss-n">task</span><span class="pgcss-p">,</span> <span class="pgcss-o">...</span><span class="pgcss-p">)</span>
<span class="pgcss-gp">... </span><span class="pgcss-n">p</span><span class="pgcss-o">.</span><span class="pgcss-n">join</span><span class="pgcss-p">()</span>
</pre></div>
<p>Затем реализуем задачу task, в ней будут выполняться какие-то
операции над полученными данными, например, извлекаться новые ссылки, и
будет происходить порождение новых микропотоков. Но мы же хотим, чтобы
конкуренция не разрасталась, поэтому решаем складывать задачи единый
пул.</p>
<div class="highlight"><pre><span class="pgcss-gp">&gt;&gt;&gt; </span><span class="pgcss-k">def</span> <span class="pgcss-nf">sub_task</span><span class="pgcss-p">(</span><span class="pgcss-n">i</span><span class="pgcss-p">,</span> <span class="pgcss-n">p</span><span class="pgcss-p">):</span>
<span class="pgcss-go">        p.spawn(lambda: i)</span>
<span class="pgcss-gp">&gt;&gt;&gt; </span><span class="pgcss-k">def</span> <span class="pgcss-nf">task</span><span class="pgcss-p">(</span><span class="pgcss-n">i</span><span class="pgcss-p">,</span> <span class="pgcss-n">p</span><span class="pgcss-p">):</span>
<span class="pgcss-gp">... </span>    <span class="pgcss-k">for</span> <span class="pgcss-n">_</span> <span class="pgcss-ow">in</span> <span class="pgcss-nb">xrange</span><span class="pgcss-p">(</span><span class="pgcss-mi">4</span><span class="pgcss-p">):</span>
<span class="pgcss-gp">... </span>        <span class="pgcss-n">p</span><span class="pgcss-o">.</span><span class="pgcss-n">spawn</span><span class="pgcss-p">(</span><span class="pgcss-n">sub_task</span><span class="pgcss-p">,</span> <span class="pgcss-n">i</span> <span class="pgcss-o">+</span> <span class="pgcss-mi">1</span><span class="pgcss-p">,</span> <span class="pgcss-n">p</span><span class="pgcss-p">)</span>
<span class="pgcss-gp">...</span>
</pre></div>
<p>Таким образом каждый task создаёт ещё по 4 sub_task. Когда
структура программы не такая простая и голая, а напичкана различной
дополнительной логикой, то кажется, что всё хорошо. Но увы программа
начинает себя странно вести от раза к разу. И поведение меняется от
количества операция и размера пула.</p>
<p>В версии gevent 0.13.8 всё просто замолкает, зависает и крутится в
цикле. Но благо 1.0dev умеет определять эту проблемную точку и выдавать
исключение:</p>
<div class="highlight"><pre><span class="pgcss-gt">Traceback (most recent call last):</span>
<span class="pgcss-gr">  File &quot;test.py&quot;, line 14, in</span>
<span class="pgcss-gr">    p.join()</span>
<span class="pgcss-gr">  File &quot;/home/imdagger/Projects/bj-project/virtualenv/pg/local/lib/python2.7/site-packages/gevent/pool.py&quot;, line 100, in join</span>
<span class="pgcss-gr">    self._empty_event.wait(timeout=timeout)</span>
<span class="pgcss-gr">  File &quot;/home/imdagger/Projects/bj-project/virtualenv/pg/local/lib/python2.7/site-packages/gevent/event.py&quot;, line 77, in wait</span>
<span class="pgcss-gr">    result = self.hub.switch()</span>
<span class="pgcss-gr">  File &quot;/home/imdagger/Projects/bj-project/virtualenv/pg/local/lib/python2.7/site-packages/gevent/hub.py&quot;, line 331, in switch</span>
<span class="pgcss-gr">    return greenlet.switch(self)</span>
<span class="pgcss-gr">gevent.hub.LoopExit</span>: <span class="pgcss-n">This operation would block forever</span>
</pre></div>
<p>А всё потому, что некоторая задача task нуждается в добавлении в пул
подзадачи sub_task, которая тоже нуждается в пуле, а сам пул нуждается
в завершении задачи task, т.к. он достиг размера 10 и переполнен. и с
другими задачами аналогично, т.е. пул переполнен и ждёт освобождения, а
задачи, чтобы завершится пытаются в него затолкнуть ещё больше подзадач.</p>
<p>Поэтому для выхода из такой ситуации лучше обойтись либо только task
без вызова ещё одной поздадачи со spawn, а лучше вообще закидывать
подзадачи в очередь, а другой поток (или несколько), будут забирать их,
обрабатывать данные и укладывать в пул.</p>
                </div>
            </div>
            <div class="row comments-row">
                <span><a class="pseudo-link b-candy b-comment-shortcut"><i class="b-ico"></i>ответить</a></span>
            </div>
        </div>
    </div>
</div><div class="panel panel-text">
    <div class="panel-heading b-post-type b-post-type-text">
        <b class="b-user">
            <a class="b-user__link" href="author/imdagger.html"><b class="b-user__first-letter">I</b>MDagger</a>
        </b>
написал        <span class="pull-right b-date">
            <a class="h-link" href="/posts/2013/02/01/strannosti-mongoengine/" title="изменено 1 февраля 2013 года в 00:27">
                1 февраля 2013 года, 00:26
            </a>
        </span>
    </div>
    <div class="panel-body">
        <div class="col-sm-1 b-post__layout-left">
            <a href="author/imdagger.html"><img src="http://upics.yandex.ru/22199227/middle"></a>
        </div>
        <div class="col-sm-11 b-right-col">
<div class="row tags-row">
    <span class="tag"><a class="h-link" href="/tag/oshibka.html">ошибка</a></span>,    <span class="tag"><a class="h-link" href="/tag/uroven.html">уровень</a></span>,    <span class="tag"><a class="h-link" href="/tag/slovar.html">словарь</a></span>,    <span class="tag"><a class="h-link" href="/tag/strannoe-povedenie.html">странное поведение</a></span>,    <span class="tag"><a class="h-link" href="/tag/mongoengine.html">MongoEngine</a></span>,    <span class="tag"><a class="h-link" href="/tag/dokument.html">документ</a></span>,    <span class="tag"><a class="h-link" href="/tag/vlozhennyi.html">вложенный</a></span>,    <span class="tag"><a class="h-link" href="/tag/povedenie.html">поведение</a></span>,    <span class="tag"><a class="h-link" href="/tag/pole.html">поле</a></span>,    <span class="tag"><a class="h-link" href="/tag/python.html">python</a></span>,    <span class="tag"><a class="h-link" href="/tag/programmirovanie.html">программирование</a></span></div>
            <div class="post-title">
<a class="no-link" href="/posts/2013/02/01/strannosti-mongoengine/">Странности MongoEngine</a>            </div>
            <div class="row post-body">
                <div class="b-text">
<p>Странно, но в Mongoengine MapField внутри другого MapField ведёт
себя немного неожиданно. Не знаю, так задумано или это ошибка (спрошу у
них попозже), но если сделать вот так:</p>
<div class="highlight"><pre><span class="pgcss-k">class</span> <span class="pgcss-nc">SomeModel</span><span class="pgcss-p">(</span><span class="pgcss-n">EmbeddedDocument</span><span class="pgcss-p">):</span>
    <span class="pgcss-n">num</span> <span class="pgcss-o">=</span> <span class="pgcss-n">IntField</span><span class="pgcss-p">()</span>

<span class="pgcss-k">class</span> <span class="pgcss-nc">SomeModel</span><span class="pgcss-p">(</span><span class="pgcss-n">Document</span><span class="pgcss-p">):</span>
    <span class="pgcss-n">my_field</span> <span class="pgcss-o">=</span> <span class="pgcss-n">MapField</span><span class="pgcss-p">(</span><span class="pgcss-n">MapField</span><span class="pgcss-p">(</span><span class="pgcss-n">EmbeddedDocumentField</span><span class="pgcss-p">(</span><span class="pgcss-n">SomeSubModel</span><span class="pgcss-p">)))</span>
</pre></div>
<p>То всё будет работать, но как только мы захотим получить документ и
произвести правку в поле num начнётся самое интересное:</p>
<div class="highlight"><pre><span class="pgcss-gp">&gt;&gt;&gt; </span><span class="pgcss-n">some_obj</span> <span class="pgcss-o">=</span> <span class="pgcss-n">SomeModel</span><span class="pgcss-o">.</span><span class="pgcss-n">object</span><span class="pgcss-p">[</span><span class="pgcss-mi">1</span><span class="pgcss-p">]</span>
<span class="pgcss-gp">&gt;&gt;&gt; </span><span class="pgcss-k">print</span> <span class="pgcss-n">some_obj</span><span class="pgcss-o">.</span><span class="pgcss-n">my_field</span><span class="pgcss-p">[</span><span class="pgcss-s">&#39;key1&#39;</span><span class="pgcss-p">][</span><span class="pgcss-s">&#39;key2&#39;</span><span class="pgcss-p">]</span><span class="pgcss-o">.</span><span class="pgcss-n">num</span>
<span class="pgcss-go">9</span>
<span class="pgcss-gp">&gt;&gt;&gt; </span><span class="pgcss-n">some_obj</span><span class="pgcss-o">.</span><span class="pgcss-n">my_field</span><span class="pgcss-p">[</span><span class="pgcss-s">&#39;key1&#39;</span><span class="pgcss-p">][</span><span class="pgcss-s">&#39;key2&#39;</span><span class="pgcss-p">]</span><span class="pgcss-o">.</span><span class="pgcss-n">num</span> <span class="pgcss-o">=</span> <span class="pgcss-mi">10</span>
<span class="pgcss-gp">&gt;&gt;&gt; </span><span class="pgcss-n">some_obj</span><span class="pgcss-o">.</span><span class="pgcss-n">save</span><span class="pgcss-p">()</span>
<span class="pgcss-go"># и снова</span>
<span class="pgcss-gp">&gt;&gt;&gt; </span><span class="pgcss-n">some_obj</span> <span class="pgcss-o">=</span> <span class="pgcss-n">SomeModel</span><span class="pgcss-o">.</span><span class="pgcss-n">object</span><span class="pgcss-p">[</span><span class="pgcss-mi">1</span><span class="pgcss-p">]</span>
<span class="pgcss-gp">&gt;&gt;&gt; </span><span class="pgcss-k">print</span> <span class="pgcss-n">some_obj</span><span class="pgcss-o">.</span><span class="pgcss-n">my_field</span><span class="pgcss-p">[</span><span class="pgcss-s">&#39;key1&#39;</span><span class="pgcss-p">][</span><span class="pgcss-s">&#39;key2&#39;</span><span class="pgcss-p">]</span><span class="pgcss-o">.</span><span class="pgcss-n">num</span>
<span class="pgcss-go">9</span>
</pre></div>
<p>И он ни в какую не хочет сохранять. Хотя можно провернуть трюк с
update, но это только для такой простой модели, а если там ещё уровень
вложенности, то уже и update не помогает. А всё почему?</p>
<p>А потому, что это заложено в поведение <code class="code">
 _get _changed _fields</code>
 в
base.BaseDocument у библиотеки, ошибка это или нет, но:</p>
<div class="highlight"><pre><span class="pgcss-o">...</span>
         <span class="pgcss-k">for</span> <span class="pgcss-n">field_name</span> <span class="pgcss-ow">in</span> <span class="pgcss-n">field_list</span><span class="pgcss-p">:</span>

            <span class="pgcss-n">db_field_name</span> <span class="pgcss-o">=</span> <span class="pgcss-bp">self</span><span class="pgcss-o">.</span><span class="pgcss-n">_db_field_map</span><span class="pgcss-o">.</span><span class="pgcss-n">get</span><span class="pgcss-p">(</span><span class="pgcss-n">field_name</span><span class="pgcss-p">,</span> <span class="pgcss-n">field_name</span><span class="pgcss-p">)</span>
            <span class="pgcss-n">key</span> <span class="pgcss-o">=</span> <span class="pgcss-s">&#39;</span><span class="pgcss-si">%s</span><span class="pgcss-s">.&#39;</span> <span class="pgcss-o">%</span> <span class="pgcss-n">db_field_name</span>
            <span class="pgcss-n">field</span> <span class="pgcss-o">=</span> <span class="pgcss-bp">self</span><span class="pgcss-o">.</span><span class="pgcss-n">_data</span><span class="pgcss-o">.</span><span class="pgcss-n">get</span><span class="pgcss-p">(</span><span class="pgcss-n">field_name</span><span class="pgcss-p">,</span> <span class="pgcss-bp">None</span><span class="pgcss-p">)</span>
            <span class="pgcss-k">if</span> <span class="pgcss-nb">hasattr</span><span class="pgcss-p">(</span><span class="pgcss-n">field</span><span class="pgcss-p">,</span> <span class="pgcss-s">&#39;id&#39;</span><span class="pgcss-p">):</span>
                <span class="pgcss-k">if</span> <span class="pgcss-n">field</span><span class="pgcss-o">.</span><span class="pgcss-n">id</span> <span class="pgcss-ow">in</span> <span class="pgcss-n">inspected</span><span class="pgcss-p">:</span>
                    <span class="pgcss-k">continue</span>
                <span class="pgcss-n">inspected</span><span class="pgcss-o">.</span><span class="pgcss-n">add</span><span class="pgcss-p">(</span><span class="pgcss-n">field</span><span class="pgcss-o">.</span><span class="pgcss-n">id</span><span class="pgcss-p">)</span>

            <span class="pgcss-k">if</span> <span class="pgcss-p">(</span><span class="pgcss-nb">isinstance</span><span class="pgcss-p">(</span><span class="pgcss-n">field</span><span class="pgcss-p">,</span> <span class="pgcss-p">(</span><span class="pgcss-n">EmbeddedDocument</span><span class="pgcss-p">,</span> <span class="pgcss-n">DynamicEmbeddedDocument</span><span class="pgcss-p">))</span>
               <span class="pgcss-ow">and</span> <span class="pgcss-n">db_field_name</span> <span class="pgcss-ow">not</span> <span class="pgcss-ow">in</span> <span class="pgcss-n">_changed_fields</span><span class="pgcss-p">):</span>
                 <span class="pgcss-c"># Find all embedded fields that have been changed</span>
                <span class="pgcss-n">changed</span> <span class="pgcss-o">=</span> <span class="pgcss-n">field</span><span class="pgcss-o">.</span><span class="pgcss-n">_get_changed_fields</span><span class="pgcss-p">(</span><span class="pgcss-n">key</span><span class="pgcss-p">,</span> <span class="pgcss-n">inspected</span><span class="pgcss-p">)</span>
                <span class="pgcss-n">_changed_fields</span> <span class="pgcss-o">+=</span> <span class="pgcss-p">[</span><span class="pgcss-s">&quot;</span><span class="pgcss-si">%s%s</span><span class="pgcss-s">&quot;</span> <span class="pgcss-o">%</span> <span class="pgcss-p">(</span><span class="pgcss-n">key</span><span class="pgcss-p">,</span> <span class="pgcss-n">k</span><span class="pgcss-p">)</span> <span class="pgcss-k">for</span> <span class="pgcss-n">k</span> <span class="pgcss-ow">in</span> <span class="pgcss-n">changed</span> <span class="pgcss-k">if</span> <span class="pgcss-n">k</span><span class="pgcss-p">]</span>
            <span class="pgcss-k">elif</span> <span class="pgcss-p">(</span><span class="pgcss-nb">isinstance</span><span class="pgcss-p">(</span><span class="pgcss-n">field</span><span class="pgcss-p">,</span> <span class="pgcss-p">(</span><span class="pgcss-nb">list</span><span class="pgcss-p">,</span> <span class="pgcss-nb">tuple</span><span class="pgcss-p">,</span> <span class="pgcss-nb">dict</span><span class="pgcss-p">))</span> <span class="pgcss-ow">and</span>
                    <span class="pgcss-n">db_field_name</span> <span class="pgcss-ow">not</span> <span class="pgcss-ow">in</span> <span class="pgcss-n">_changed_fields</span><span class="pgcss-p">):</span>
                <span class="pgcss-c"># Loop list / dict fields as they contain documents</span>
                <span class="pgcss-c"># Determine the iterator to use</span>
                <span class="pgcss-k">if</span> <span class="pgcss-ow">not</span> <span class="pgcss-nb">hasattr</span><span class="pgcss-p">(</span><span class="pgcss-n">field</span><span class="pgcss-p">,</span> <span class="pgcss-s">&#39;items&#39;</span><span class="pgcss-p">):</span>
                    <span class="pgcss-n">iterator</span> <span class="pgcss-o">=</span> <span class="pgcss-nb">enumerate</span><span class="pgcss-p">(</span><span class="pgcss-n">field</span><span class="pgcss-p">)</span>
                <span class="pgcss-k">else</span><span class="pgcss-p">:</span>
                    <span class="pgcss-n">iterator</span> <span class="pgcss-o">=</span> <span class="pgcss-n">field</span><span class="pgcss-o">.</span><span class="pgcss-n">iteritems</span><span class="pgcss-p">()</span>
                <span class="pgcss-k">for</span> <span class="pgcss-n">index</span><span class="pgcss-p">,</span> <span class="pgcss-n">value</span> <span class="pgcss-ow">in</span> <span class="pgcss-n">iterator</span><span class="pgcss-p">:</span>
                    <span class="pgcss-k">if</span> <span class="pgcss-ow">not</span> <span class="pgcss-nb">hasattr</span><span class="pgcss-p">(</span><span class="pgcss-n">value</span><span class="pgcss-p">,</span> <span class="pgcss-s">&#39;_get_changed_fields&#39;</span><span class="pgcss-p">):</span>
                        <span class="pgcss-k">continue</span>
                    <span class="pgcss-n">list_key</span> <span class="pgcss-o">=</span> <span class="pgcss-s">&quot;</span><span class="pgcss-si">%s%s</span><span class="pgcss-s">.&quot;</span> <span class="pgcss-o">%</span> <span class="pgcss-p">(</span><span class="pgcss-n">key</span><span class="pgcss-p">,</span> <span class="pgcss-n">index</span><span class="pgcss-p">)</span>
                    <span class="pgcss-n">changed</span> <span class="pgcss-o">=</span> <span class="pgcss-n">value</span><span class="pgcss-o">.</span><span class="pgcss-n">_get_changed_fields</span><span class="pgcss-p">(</span><span class="pgcss-n">list_key</span><span class="pgcss-p">,</span> <span class="pgcss-n">inspected</span><span class="pgcss-p">)</span>
                    <span class="pgcss-n">_changed_fields</span> <span class="pgcss-o">+=</span> <span class="pgcss-p">[</span><span class="pgcss-s">&quot;</span><span class="pgcss-si">%s%s</span><span class="pgcss-s">&quot;</span> <span class="pgcss-o">%</span> <span class="pgcss-p">(</span><span class="pgcss-n">list_key</span><span class="pgcss-p">,</span> <span class="pgcss-n">k</span><span class="pgcss-p">)</span>
                                        <span class="pgcss-k">for</span> <span class="pgcss-n">k</span> <span class="pgcss-ow">in</span> <span class="pgcss-n">changed</span> <span class="pgcss-k">if</span> <span class="pgcss-n">k</span><span class="pgcss-p">]</span>
</pre></div>
<p>Так вот в том месте, где метод проверяет являются ли данные
связанные с полем словарём или списком, есть некоторая неточность в
поведении. Для нашего случае получается словарь в словаре, если бы это
был просто встроенных документ в словаре, то всё было бы хорошо. Но нет,
у нас словарь в словаре, в котором документ, поэтому оно проверяет наш
словарик на наличие специального метода (именно такого, в котором мы
находимся):</p>
<div class="highlight"><pre><span class="pgcss-k">if</span> <span class="pgcss-ow">not</span> <span class="pgcss-nb">hasattr</span><span class="pgcss-p">(</span><span class="pgcss-n">value</span><span class="pgcss-p">,</span> <span class="pgcss-s">&#39;_get_changed_fields&#39;</span><span class="pgcss-p">):</span>
</pre></div>
<p>Естественно он его не находит, это же простой словарь! И
соответственно не подхватывает изменения из вложенного документа. Выход?
Переработать структуру и сделать поля фиксированные, а не два словаря,
или поправить код, чтобы он переварил такой случай и углублялся в
словарь или ещё один вариант: попробовать сделать имя полю
комбинированное через точку (вида 'key1.key2'). Хотя mongoengine стоило
бы предупредить про такие странности.</p>
                </div>
            </div>
            <div class="row comments-row">
                <span><a class="pseudo-link b-candy b-comment-shortcut"><i class="b-ico"></i>ответить</a></span>
            </div>
        </div>
    </div>
</div><div class="panel panel-text">
    <div class="panel-heading b-post-type b-post-type-text">
        <b class="b-user">
            <a class="b-user__link" href="author/imdagger.html"><b class="b-user__first-letter">I</b>MDagger</a>
        </b>
написал        <span class="pull-right b-date">
            <a class="h-link" href="/posts/2013/01/17/udobnaia-nadstroika-i-zamena-dlia-urllib2/" >
                17 января 2013 года, 03:11
            </a>
        </span>
    </div>
    <div class="panel-body">
        <div class="col-sm-1 b-post__layout-left">
            <a href="author/imdagger.html"><img src="http://upics.yandex.ru/22199227/middle"></a>
        </div>
        <div class="col-sm-11 b-right-col">
<div class="row tags-row">
    <span class="tag"><a class="h-link" href="/tag/programmirovanie.html">программирование</a></span>,    <span class="tag"><a class="h-link" href="/tag/chtenie.html">чтение</a></span>,    <span class="tag"><a class="h-link" href="/tag/biblioteka.html">библиотека</a></span>,    <span class="tag"><a class="h-link" href="/tag/requests.html">requests</a></span>,    <span class="tag"><a class="h-link" href="/tag/http.html">HTTP</a></span>,    <span class="tag"><a class="h-link" href="/tag/python.html">python</a></span></div>
            <div class="post-title">
<a class="no-link" href="/posts/2013/01/17/udobnaia-nadstroika-i-zamena-dlia-urllib2/">Удобная надстройка (и замена) для urllib2</a>            </div>
            <div class="row post-body">
                <div class="b-text">
<p>Если использовать библиотеку urllib2, то можно открыть соединение,
проверить заголовки, а затем начать считывать содержимое, которое
возвращает сервер. Но urllib2 не настолько удобная и наглядная как
библиотека requests:</p>
<div class="highlight"><pre><span class="pgcss-kn">import</span> <span class="pgcss-nn">requests</span>
<span class="pgcss-n">answer</span> <span class="pgcss-o">=</span> <span class="pgcss-n">requests</span><span class="pgcss-o">.</span><span class="pgcss-n">get</span><span class="pgcss-p">(</span><span class="pgcss-s">&#39;http://some...url&#39;</span><span class="pgcss-p">,</span> <span class="pgcss-n">cookies</span><span class="pgcss-o">=</span><span class="pgcss-p">{</span><span class="pgcss-s">&#39;mycookie&#39;</span><span class="pgcss-p">:</span> <span class="pgcss-s">&#39;value&#39;</span><span class="pgcss-p">},</span>
                      <span class="pgcss-n">headers</span><span class="pgcss-o">=</span><span class="pgcss-p">{</span><span class="pgcss-s">&#39;x-additional-header&#39;</span><span class="pgcss-p">:</span> <span class="pgcss-s">&#39;value&#39;</span><span class="pgcss-p">})</span>
<span class="pgcss-k">print</span><span class="pgcss-p">(</span><span class="pgcss-n">answer</span><span class="pgcss-o">.</span><span class="pgcss-n">text</span><span class="pgcss-p">)</span>
</pre></div>
<p>Но как, допустим, проверить тип содержимого и если он не подходящий
сразу закрыть соединение? Достаточно передать параметр <code class="code">
stream=True</code>
:</p>
<div class="highlight"><pre><span class="pgcss-kn">import</span> <span class="pgcss-nn">requests</span>
<span class="pgcss-n">answer</span> <span class="pgcss-o">=</span> <span class="pgcss-n">requests</span><span class="pgcss-o">.</span><span class="pgcss-n">get</span><span class="pgcss-p">(</span><span class="pgcss-s">&#39;http://some...url&#39;</span><span class="pgcss-p">,</span> <span class="pgcss-n">cookies</span><span class="pgcss-o">=</span><span class="pgcss-p">{</span><span class="pgcss-s">&#39;mycookie&#39;</span><span class="pgcss-p">:</span> <span class="pgcss-s">&#39;value&#39;</span><span class="pgcss-p">},</span>
                      <span class="pgcss-n">stream</span><span class="pgcss-o">=</span><span class="pgcss-bp">True</span><span class="pgcss-p">,</span>
                      <span class="pgcss-n">headers</span><span class="pgcss-o">=</span><span class="pgcss-p">{</span><span class="pgcss-s">&#39;x-additional-header&#39;</span><span class="pgcss-p">:</span> <span class="pgcss-s">&#39;value&#39;</span><span class="pgcss-p">})</span>
<span class="pgcss-k">if</span> <span class="pgcss-n">answer</span><span class="pgcss-o">.</span><span class="pgcss-n">headers</span><span class="pgcss-o">.</span><span class="pgcss-n">get</span><span class="pgcss-p">(</span><span class="pgcss-s">&#39;content-type&#39;</span><span class="pgcss-p">,</span> <span class="pgcss-s">&#39;&#39;</span><span class="pgcss-p">)</span><span class="pgcss-o">.</span><span class="pgcss-n">startswith</span><span class="pgcss-p">(</span><span class="pgcss-s">&#39;text/html&#39;</span><span class="pgcss-p">):</span>
   <span class="pgcss-k">pass</span> <span class="pgcss-c"># в этот момент ещё не началось получение данных самой страницы</span>
<span class="pgcss-c"># а вот тут уже, после обращения к text, содержимое будет готово</span>
<span class="pgcss-k">print</span><span class="pgcss-p">(</span><span class="pgcss-n">answer</span><span class="pgcss-o">.</span><span class="pgcss-n">text</span><span class="pgcss-p">)</span>
<span class="pgcss-c"># .text обращается к .content, который производит считывание только 1 раз,</span>
<span class="pgcss-c"># так что всё хорошо даже второй раз</span>
<span class="pgcss-k">print</span><span class="pgcss-p">(</span><span class="pgcss-n">answer</span><span class="pgcss-o">.</span><span class="pgcss-n">text</span><span class="pgcss-p">)</span>
</pre></div>
                </div>
            </div>
            <div class="row comments-row">
                <span><a class="pseudo-link b-candy b-comment-shortcut"><i class="b-ico"></i>ответить</a></span>
            </div>
        </div>
    </div>
</div><div class="panel panel-link">
    <div class="panel-heading b-post-type b-post-type-link">
        <b class="b-user">
            <a class="b-user__link" href="author/imdagger.html"><b class="b-user__first-letter">I</b>MDagger</a>
        </b>
поделился ссылкой        <span class="pull-right b-date">
            <a class="h-link" href="/posts/2012/11/21/urn:ya.ru:post/22199227/1718/" >
                21 ноября 2012 года, 21:45
            </a>
        </span>
    </div>
    <div class="panel-body">
        <div class="col-sm-1 b-post__layout-left">
            <a href="author/imdagger.html"><img src="http://upics.yandex.ru/22199227/middle"></a>
        </div>
        <div class="col-sm-11 b-right-col">
<div class="row tags-row">
    <span class="tag"><a class="h-link" href="/tag/vyvod.html">вывод</a></span>,    <span class="tag"><a class="h-link" href="/tag/python.html">python</a></span>,    <span class="tag"><a class="h-link" href="/tag/utf-8.html">UTF-8</a></span></div>
            <div class="post-title">
<a class="h-link" href="http://stackoverflow.com/questions/1473577/writing-unicode-strings-via-sys-stdout-in-python">
    <img class="b-ico" src="http://favicon.yandex.ru/favicon/stackoverflow.com?default=yaru-external">http://stackoverflow.com/questions/1473577/writing-unicode-strings-via-sys-stdout-in-python</a>
            </div>
            <div class="row post-body">
                <div class="b-text">
<div class="highlight"><pre><span class="pgcss-nb">export </span><span class="pgcss-nv">PYTHONIOENCODING</span><span class="pgcss-o">=</span>utf-8
</pre></div>
<p>То, что нужно чтобы UTF-8 вывод работал для Python 2.7.1+ даже, если к
пайпу подключён less.</p>
                </div>
            </div>
            <div class="row comments-row">
                <span><a class="pseudo-link b-candy b-comment-shortcut"><i class="b-ico"></i>ответить</a></span>
            </div>
        </div>
    </div>
</div><div class="panel panel-text">
    <div class="panel-heading b-post-type b-post-type-text">
        <b class="b-user">
            <a class="b-user__link" href="author/imdagger.html"><b class="b-user__first-letter">I</b>MDagger</a>
        </b>
написал        <span class="pull-right b-date">
            <a class="h-link" href="/posts/2012/07/12/tsiklicheskie-struktury/" title="изменено 12 июля 2012 года в 01:51">
                12 июля 2012 года, 01:49
            </a>
        </span>
    </div>
    <div class="panel-body">
        <div class="col-sm-1 b-post__layout-left">
            <a href="author/imdagger.html"><img src="http://upics.yandex.ru/22199227/middle"></a>
        </div>
        <div class="col-sm-11 b-right-col">
<div class="row tags-row">
    <span class="tag"><a class="h-link" href="/tag/programmirovanie.html">программирование</a></span>,    <span class="tag"><a class="h-link" href="/tag/scheme.html">Scheme</a></span>,    <span class="tag"><a class="h-link" href="/tag/python.html">python</a></span>,    <span class="tag"><a class="h-link" href="/tag/bigloo.html">bigloo</a></span>,    <span class="tag"><a class="h-link" href="/tag/struktura.html">структура</a></span>,    <span class="tag"><a class="h-link" href="/tag/tsiklicheskii.html">циклический</a></span></div>
            <div class="post-title">
<a class="no-link" href="/posts/2012/07/12/tsiklicheskie-struktury/">Циклические структуры</a>            </div>
            <div class="row post-body">
                <div class="b-text">
<p>Python при выводе циклической структуры выкручивается вот так:</p>
<blockquote>
<pre class="doctest-block">
&gt;&gt;&gt; a = {1 : 2}
&gt;&gt;&gt; a['2'] = a
&gt;&gt;&gt; a
{1: 2, '2': {...}}
&gt;&gt;&gt; print (a)
{1: 2, '2': {...}}
</pre>
</blockquote>
<p>А вот в Bigloo Scheme стандартные display, print и pp не умеют такое
обрабатывать. Но благо нашёлся в документации рядом с display метод
display-circle. Вот он очень хорошо справляется с такой задачей. В
отличии от предыдущих функций, которые просто зацикливаются:</p>
<pre class="literal-block">
------------------------------------------------------------------------------
Bigloo (3.8c)                                                            ,--^,
`a practical Scheme compiler'                                      _ ___/ /|/
Сб. июня 9 01:57:24 FET 2012                             ,;'( )__, ) '
Inria -- Sophia Antipolis                                     ;;  //   L__.
email: bigloo&#64;lists-sop.inria.fr                              '   \    /  '
url: http://www-sop.inria.fr/indes/fp/Bigloo                       ^   ^
------------------------------------------------------------------------------
1:=&gt; (define x '(1))
x1:=&gt; (append! x x)
#0=(1 . #0#)
1:=&gt; (display-circle x)
#0=(1 . #0#)
</pre>
<p>Чего это я вдруг наткнулся на это и вспомнил? Да вот нужно было
вывести класс, а там была ссылка на структуру, которая ссылалась опять
на класс. А я без особых размышлений сделал (print x) и зациклился,
пришлось прервать.</p>
                </div>
            </div>
            <div class="row comments-row">
                <span><a class="pseudo-link b-candy b-comment-shortcut"><i class="b-ico"></i>ответить</a></span>
            </div>
        </div>
    </div>
</div><div class="panel panel-text">
    <div class="panel-heading b-post-type b-post-type-text">
        <b class="b-user">
            <a class="b-user__link" href="author/imdagger.html"><b class="b-user__first-letter">I</b>MDagger</a>
        </b>
написал        <span class="pull-right b-date">
            <a class="h-link" href="/posts/2012/04/28/fiks-dlia-pyamf/" >
                28 апреля 2012 года, 01:34
            </a>
        </span>
    </div>
    <div class="panel-body">
        <div class="col-sm-1 b-post__layout-left">
            <a href="author/imdagger.html"><img src="http://upics.yandex.ru/22199227/middle"></a>
        </div>
        <div class="col-sm-11 b-right-col">
<div class="row tags-row">
    <span class="tag"><a class="h-link" href="/tag/__amf__.html">__amf__</a></span>,    <span class="tag"><a class="h-link" href="/tag/synonym.html">synonym</a></span>,    <span class="tag"><a class="h-link" href="/tag/ispravlenie.html">исправление</a></span>,    <span class="tag"><a class="h-link" href="/tag/python.html">python</a></span>,    <span class="tag"><a class="h-link" href="/tag/oshibka.html">ошибка</a></span>,    <span class="tag"><a class="h-link" href="/tag/pyamf.html">pyamf</a></span></div>
            <div class="post-title">
<a class="no-link" href="/posts/2012/04/28/fiks-dlia-pyamf/">Фикс для PyAMF</a>            </div>
            <div class="row post-body">
                <div class="b-text">
<p>&nbsp;&nbsp;&nbsp; Нашёл проблему в PyAMF, которая мешает нормально работать с
десериализованными из AMF объектами, которые содержат правило synonym в
__amf__, при сериализации оно работает нормально, а вот в обратную
сторону нет. Т.к. это касалось рабочего проекта и исправление нужно
здесь и сейчас, то не дожидаясь пока его исправят разработчики, я
поправил сам. Просто форкнул репозиторий проекта и исправил
<a class="reference external" href="https://github.com/IMDagger/pyamf">тут</a>. Чуть позже отправлю
pull-запрос разработчикам, надеюсь они примут мои исправления. Т.к. это
была явная ошибка в тесте и проблема с copy&amp;paste в коде.</p>
                </div>
            </div>
            <div class="row comments-row">
                <span><a class="pseudo-link b-candy b-comment-shortcut"><i class="b-ico"></i>ответить</a></span>
            </div>
        </div>
    </div>
</div><div class="panel panel-text">
    <div class="panel-heading b-post-type b-post-type-text">
        <b class="b-user">
            <a class="b-user__link" href="author/imdagger.html"><b class="b-user__first-letter">I</b>MDagger</a>
        </b>
написал        <span class="pull-right b-date">
            <a class="h-link" href="/posts/2012/04/19/celery-dlia-igrovogo-mira/" title="изменено 19 апреля 2012 года в 00:08">
                19 апреля 2012 года, 00:07
            </a>
        </span>
    </div>
    <div class="panel-body">
        <div class="col-sm-1 b-post__layout-left">
            <a href="author/imdagger.html"><img src="http://upics.yandex.ru/22199227/middle"></a>
        </div>
        <div class="col-sm-11 b-right-col">
<div class="row tags-row">
    <span class="tag"><a class="h-link" href="/tag/celery.html">Celery</a></span>,    <span class="tag"><a class="h-link" href="/tag/igra.html">игра</a></span>,    <span class="tag"><a class="h-link" href="/tag/multipleer.html">мультиплеер</a></span>,    <span class="tag"><a class="h-link" href="/tag/gevent.html">gevent</a></span>,    <span class="tag"><a class="h-link" href="/tag/mikropotok.html">микропоток</a></span>,    <span class="tag"><a class="h-link" href="/tag/python.html">python</a></span></div>
            <div class="post-title">
<a class="no-link" href="/posts/2012/04/19/celery-dlia-igrovogo-mira/">Celery для игрового мира</a>            </div>
            <div class="row post-body">
                <div class="b-text">
<p>&nbsp;&nbsp;&nbsp; Надесь Celery в режиме gevent сможет выступить в роли менеджера
задач игровых миров, было бы неплохо из WEB-части порождать отдельную
задачу, которая обслуживает и обновляет состояние игрового мира в Redis.
Т.е. по небольшой группе микропотоков на игровой мир, где будут
существовать игроки и отправлять в него события. Эдакая модель акторов
на Python с супервизором Celery.</p>
                </div>
            </div>
            <div class="row comments-row">
                <span><a class="pseudo-link b-candy b-comment-shortcut"><i class="b-ico"></i>ответить</a></span>
            </div>
        </div>
    </div>
</div><div class="panel panel-text">
    <div class="panel-heading b-post-type b-post-type-text">
        <b class="b-user">
            <a class="b-user__link" href="author/imdagger.html"><b class="b-user__first-letter">I</b>MDagger</a>
        </b>
написал        <span class="pull-right b-date">
            <a class="h-link" href="/posts/2012/03/31/eksperiment-proshiol-uspeshno/" >
                31 марта 2012 года, 02:43
            </a>
        </span>
    </div>
    <div class="panel-body">
        <div class="col-sm-1 b-post__layout-left">
            <a href="author/imdagger.html"><img src="http://upics.yandex.ru/22199227/middle"></a>
        </div>
        <div class="col-sm-11 b-right-col">
<div class="row tags-row">
    <span class="tag"><a class="h-link" href="/tag/programmirovanie.html">программирование</a></span>,    <span class="tag"><a class="h-link" href="/tag/radost.html">радость</a></span>,    <span class="tag"><a class="h-link" href="/tag/http.html">HTTP</a></span>,    <span class="tag"><a class="h-link" href="/tag/python.html">python</a></span>,    <span class="tag"><a class="h-link" href="/tag/serializatsiia.html">сериализация</a></span>,    <span class="tag"><a class="h-link" href="/tag/pyamf.html">pyamf</a></span>,    <span class="tag"><a class="h-link" href="/tag/flash.html">flash</a></span>,    <span class="tag"><a class="h-link" href="/tag/rabota.html">работа</a></span>,    <span class="tag"><a class="h-link" href="/tag/flex.html">flex</a></span></div>
            <div class="post-title">
<a class="no-link" href="/posts/2012/03/31/eksperiment-proshiol-uspeshno/">Эксперимент прошёл успешно</a>            </div>
            <div class="row post-body">
                <div class="b-text">
<p>&nbsp;&nbsp;&nbsp; Очень большой поток сообщений через chunked канал мы не проверяли,
но всё работает отлично. События передаются, только, т.к. Flash часть
без Flex, то нужно чтобы списки не передавались как
flex.messaging.io.ArrayCollection, т.к. они только во Flex есть. Поэтому
нужно, чтобы <strong>pyamf.amf3.use_proxies_default</strong> был равен <strong>False</strong>.
Так же стоит выставить заголовки, чтобы промежуточные прокси-сервера,
если таковые имеются не изменяли содержимое и не кэшировали его, т.к.
это всё таки события из игровой системы. И не очень бы хотелось, чтобы
игрок вошёл в игру и случилось дежавю.</p>
<blockquote>
…
Cache-Control: no-cache, no-transform
…</blockquote>
<p>&nbsp;&nbsp;&nbsp; Ещё забавно, когда из браузера обращается к обработчику, то
начинается скачиванием бинарного файла с AMF-объектами, и он может
скачиваться бесконечно.</p>
                </div>
            </div>
            <div class="row comments-row">
                <span><a class="pseudo-link b-candy b-comment-shortcut"><i class="b-ico"></i>ответить</a></span>
            </div>
        </div>
    </div>
</div><div class="panel panel-text">
    <div class="panel-heading b-post-type b-post-type-text">
        <b class="b-user">
            <a class="b-user__link" href="author/imdagger.html"><b class="b-user__first-letter">I</b>MDagger</a>
        </b>
написал        <span class="pull-right b-date">
            <a class="h-link" href="/posts/2012/03/30/soedinenie-flash-python-amf-i-drugie-tovarishchi/" title="изменено 30 марта 2012 года в 00:26">
                30 марта 2012 года, 00:25
            </a>
        </span>
    </div>
    <div class="panel-body">
        <div class="col-sm-1 b-post__layout-left">
            <a href="author/imdagger.html"><img src="http://upics.yandex.ru/22199227/middle"></a>
        </div>
        <div class="col-sm-11 b-right-col">
<div class="row tags-row">
    <span class="tag"><a class="h-link" href="/tag/http.html">HTTP</a></span>,    <span class="tag"><a class="h-link" href="/tag/python.html">python</a></span>,    <span class="tag"><a class="h-link" href="/tag/flash.html">flash</a></span>,    <span class="tag"><a class="h-link" href="/tag/rabota.html">работа</a></span>,    <span class="tag"><a class="h-link" href="/tag/chunked.html">chunked</a></span>,    <span class="tag"><a class="h-link" href="/tag/wsgi.html">wsgi</a></span></div>
            <div class="post-title">
<a class="no-link" href="/posts/2012/03/30/soedinenie-flash-python-amf-i-drugie-tovarishchi/">Соединение Flash &lt;-&gt; Python, AMF и другие товарищи</a>            </div>
            <div class="row post-body">
                <div class="b-text">
<p>&nbsp;&nbsp;&nbsp; Дабы не строить свой TCP-сервер и не разрабатывать свой протокол для
того, чтобы обмениваться с Flash в <strong>двустороннем порядке</strong> при помощи
AMF-пакетов, мы сошлись на варианте с двумя соединениями. Одно
соединение для получения событий из системы (1), а второй канал (2)
используется через NetConnection и создан для отправки call из Flash. Из
игры отправляется некоторый запрос по каналу (2), который является
HTTP-запросом, соединение удерживается и в рамках одного соединения
происходит много HTTP-запросов. Затем call обрабатывается на сервере и
происходят проверки корректности, событие заносится в очередь или
исполняется сразу же (в зависимости от необходимого времени для
события), ответ возвращается в AMF-формате обратно клиенту.</p>
<p>&nbsp;&nbsp;&nbsp; Затем в системе происходят события, и необходимо оповестить игрока
об этом. Обработчик обслуживающий (2) канал начинает отдавать события по
HTTP клиенту в режиме <em>Transfer-Encoding: chunked</em>, каждый пакет это
одно событие системы. Flash их обрабатывает и отображает игроку.</p>
<p>&nbsp;&nbsp;&nbsp; Такой подход позволил использовать стандартный pywsgi.WSGIHandler из
gevent, при этом получить быстрый канал оповещения с минимальными
накладными расходами. Chunked режим всего требует несколько байт для
отделения длины от пакета и немного символов для описания самой длины в
HEX. Требуется из Flash подключаться при помощи обычного сокета и
пересылать немного HTTP-заголовков для инициализации сессии. Посмотрим
насколько оправдает себя такой подход, чем то напоминает спутниковый
интернет.</p>
                </div>
            </div>
            <div class="row comments-row">
                <span><a class="pseudo-link b-candy b-comment-shortcut"><i class="b-ico"></i>ответить</a></span>
            </div>
        </div>
    </div>
</div><div class="panel panel-text">
    <div class="panel-heading b-post-type b-post-type-text">
        <b class="b-user">
            <a class="b-user__link" href="author/imdagger.html"><b class="b-user__first-letter">I</b>MDagger</a>
        </b>
написал        <span class="pull-right b-date">
            <a class="h-link" href="/posts/2012/02/17/nasledovanie-blokov-v-cheetah/" title="изменено 17 февраля 2012 года в 18:59">
                17 февраля 2012 года, 18:58
            </a>
        </span>
    </div>
    <div class="panel-body">
        <div class="col-sm-1 b-post__layout-left">
            <a href="author/imdagger.html"><img src="http://upics.yandex.ru/22199227/middle"></a>
        </div>
        <div class="col-sm-11 b-right-col">
<div class="row tags-row">
    <span class="tag"><a class="h-link" href="/tag/problema.html">проблема</a></span>,    <span class="tag"><a class="h-link" href="/tag/nasledovanie.html">наследование</a></span>,    <span class="tag"><a class="h-link" href="/tag/reshenie.html">решение</a></span>,    <span class="tag"><a class="h-link" href="/tag/python.html">python</a></span>,    <span class="tag"><a class="h-link" href="/tag/rasshirenie.html">расширение</a></span>,    <span class="tag"><a class="h-link" href="/tag/shablon.html">шаблон</a></span>,    <span class="tag"><a class="h-link" href="/tag/cheetah.html">Cheetah</a></span></div>
            <div class="post-title">
<a class="no-link" href="/posts/2012/02/17/nasledovanie-blokov-v-cheetah/">Наследование блоков в Cheetah</a>            </div>
            <div class="row post-body">
                <div class="b-text">
<p>Столкнулся с проблемой, что есть блок <code class="code">
#block … #end block</code>
 и
шаблон <em>base</em>, его расширяет шаблон <em>base_ex</em>t при помощи
<code class="code">
#extends</code>
, а его в свою очередь расширяет шаблон <em>application</em>. Я
хотел в <em>base_ext</em> добавить обрамляющий <code class="code">
&lt;div&gt;</code>
 для блока из <em>base</em>, но
не трогать базовый шаблон. Т.е. просто унаследовать метод и вызывать
метод предка. Помогла вот
такая <a class="reference external" href="http://base-art.net/Articles/44/">техника</a> с <code class="code">
$self</code>
 (хотя
там в примере используется <code class="code">
#def</code>
, но это не влияет на подход к
решению проблемы).</p>
<blockquote>
<p><strong>base.tmpl:</strong></p>
<div class="highlight"><pre><span class="pgcss-x">...</span>
<span class="pgcss-cp">#block</span> <span class="pgcss-n">external_block</span><span class="pgcss-x"></span>
<span class="pgcss-x">    ...</span>
<span class="pgcss-cp">#end block</span><span class="pgcss-x"></span>
</pre></div>
<p><strong>base_ext.tmpl:</strong></p>
<div class="highlight"><pre><span class="pgcss-cp">#import</span> <span class="pgcss-n">templates</span><span class="pgcss-o">.</span><span class="pgcss-n">base</span><span class="pgcss-x"></span>
<span class="pgcss-cp">#extends</span> <span class="pgcss-n">templates</span><span class="pgcss-o">.</span><span class="pgcss-n">base</span><span class="pgcss-o">.</span><span class="pgcss-n">base</span><span class="pgcss-x"></span>
<span class="pgcss-cp">#block</span> <span class="pgcss-n">external_block</span><span class="pgcss-x"></span>
<span class="pgcss-x">    &lt;div&gt;</span>
<span class="pgcss-x">        templates.base_ext.base(</span><span class="pgcss-cp">$</span><span class="pgcss-bp">self</span><span class="pgcss-x">)</span>
<span class="pgcss-x">    &lt;/div&gt;</span>
<span class="pgcss-cp">#end block</span><span class="pgcss-x"></span>
<span class="pgcss-x">...</span>
</pre></div>
</blockquote>
                </div>
            </div>
            <div class="row comments-row">
                <span><a class="pseudo-link b-candy b-comment-shortcut"><i class="b-ico"></i>ответить</a></span>
            </div>
        </div>
    </div>
</div>        <div class="panel panel-default">
            <div class="panel-body more">
                <span class="less-prev"><a class="h-link" href="tag/python2.html">Назад</a></span>
                <span class="more-next"><a class="h-link" href="tag/python4.html">Ещё записи</a></span>
            </div>
        </div>
    </div>
</div>
        </div>
    </body>
</html>