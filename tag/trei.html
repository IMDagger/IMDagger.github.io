<!DOCTYPE html>
<html lang="ru">
    <head>
        <meta charset="utf-8" />
        <title>IMDagger: Дневник</title>
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <meta name="description" content="Блог IMDagger: IT и жизнь" />
        <meta name="keywords" content="python,lisp,scheme,racket,emacs,blender,программирование,моделирование,lua,c++,c,js,java,git,bazaar" />
        <meta name="author" content="Alex Moiseenko (IMDagger)" />

<meta name="robots" content="noindex"/>
        <!-- Open Graph -->
        <link rel="stylesheet" href="http://maxcdn.bootstrapcdn.com/bootstrap/3.2.0/css/bootstrap.min.css" />
        <link rel="stylesheet" href="http://netdna.bootstrapcdn.com/font-awesome/4.0.3/css/font-awesome.min.css" />
        <link rel="shortcut icon" href="/favicon.ico" />
        <link rel="stylesheet" href="/theme/css/html4css1.css" />
        <link rel="stylesheet" href="/theme/css/style.css" />
        <link rel="stylesheet" href="/theme/css/pygment.css" />
        <link rel="stylesheet" href="/theme/css/math.css" />
        <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.11.1/jquery.min.js"></script>
        <script src="http://maxcdn.bootstrapcdn.com/bootstrap/3.2.0/js/bootstrap.min.js"></script>
        <script type="text/javascript" src="http://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS_HTML,http://imdagger.github.io/theme/js/math.js"></script>
        <script src="http://s3.amazonaws.com/nwapi/nwmatcher/nwmatcher-1.2.5-min.js"></script>
        <!--[if (gte IE 6)&(lte IE 8)]>
          <script type="text/javascript" src="/theme/js/selectivizr-min.js"></script>
          <noscript><link rel="stylesheet" href="[fallback css]" /></noscript>
        <![endif]-->

        <!-- HTML5 shim, for IE6-8 support of HTML5 elements -->
        <!--[if lt IE 9]>
        <script src="http://html5shim.googlecode.com/svn/trunk/html5.js"></script>
        <![endif]-->
    </head>

    <body>
        <div class="row page-head">
            <div class="row page-head-status page-head-status-top"><div class="col-sm-12 b-status mine"><p><i></i><a href="#" title="настроение" class="b-consistent-link"><b>ни к чему чужое мнение, в моде самовыражение</b></a></p></div></div>
            <div class="col-sm-2 page-left">
                <a href="#">
                    <img src="http://upics.yandex.ru/22199227/normal" ilo-full-src="http://upics.yandex.ru/22199227/normal">
                </a>
            </div>
            <div class="col-sm-10 all-posts">
                <div class="title-container">
                    <h1><b><a href="http://imdagger.github.io" class="fn nickname">IMDagger</a></b></h1>
                </div>
                <div class="title-menu">
                    <ul class="nav nav-tabs" role="tablist">
                        <li class="active">
                            <a href="#">Дневник</a>
                        </li>
                        <li><a href="#">О себе</a></li>
                        <li><a href="#">Фотки</a></li>
                        <li><a href="#">RSS-ленты</a></li>
                    </ul>
                </div>
            </div>
        </div>
        <div class="row page-body">
<div class="col-sm-2 page-left">
<div class="row widget widget-photo">
    <a href="posts/2011/08/07/aga-popalsia/" class="b-user-photo__link"><img class="b-user-photo__img" src=" http://img-fotki.yandex.ru/get/5409/22199227.a/0_625fc_e780ccc7_L
?log_nocount=64720402854"></a>
</div><div class="row widget">
    <div class="widget-content b-user-info">
        <div class="widget__body">
            <div class="widget-user-info__age">
                <i class="widget-user-info__sex widget-user-info__sex_type_"></i> 26&nbsp;лет
            </div>
            <div class="widget-user-info__place">
                <a href="#">Гомель</a>,                <a href="#">Беларусь</a>            </div>
            <ul class="contacts">
                <li class="contact contact-type-email"><i></i><a href="mailto:imdagger@yandex.ru">imdagger@yandex.ru</a></li>
                <li class="contact contact-type-ya-online"><i></i>imdagger@ya.ru</li>
                <li class="contact contact-type-icq"><i></i>350395088</li>
            </ul>
        </div>
    </div>
</div>

<div class="row widget">
    <div class="widget-content">
        <div class="widget__title">
            <div class="widget__title-link">Метрика</div>
        </div>
        <div class="widget__body">
            <div class="widget-line">
              <!-- noindex -->
              <!-- googleoff: index -->
              <div class="widget-entry">
                <!-- Yandex.Metrika informer --><a href="https://metrika.yandex.ru/stat/?id=25746494&amp;from=informer" target="_blank" rel="nofollow"><img src="//bs.yandex.ru/informer/25746494/3_1_FFFFFFFF_EFEFEFFF_0_pageviews" style="width:88px; height:31px; border:0;" alt="Яндекс.Метрика" title="Яндекс.Метрика: данные за сегодня (просмотры, визиты и уникальные посетители)" onclick="try{Ya.Metrika.informer({i:this,id:25746494,lang:'ru'});return false}catch(e){}"/></a><!-- /Yandex.Metrika informer --><!-- Yandex.Metrika counter --><script type="text/javascript">(function (d, w, c) { (w[c] = w[c] || []).push(function() { try { w.yaCounter25746494 = new Ya.Metrika({id:25746494, clickmap:true, trackLinks:true, accurateTrackBounce:true}); } catch(e) { } }); var n = d.getElementsByTagName("script")[0], s = d.createElement("script"), f = function () { n.parentNode.insertBefore(s, n); }; s.type = "text/javascript"; s.async = true; s.src = (d.location.protocol == "https:" ? "https:" : "http:") + "//mc.yandex.ru/metrika/watch.js"; if (w.opera == "[object Opera]") { d.addEventListener("DOMContentLoaded", f, false); } else { f(); } })(document, window, "yandex_metrika_callbacks");</script><noscript><div><img src="//mc.yandex.ru/watch/25746494" style="position:absolute; left:-9999px;" alt="" /></div></noscript><!-- /Yandex.Metrika counter -->
                <!-- googleon: index -->
                <!-- /noindex -->
                </div>
            </div>
        </div>
    </div>
</div><div class="row widget">
    <div class="widget-content">
        <div class="widget__title">
            <div class="widget__title-link">Популярное в дневнике</div>
        </div>
        <div class="widget__body">
            <div class="widget-line">
                <div class="widget-entry">
                    <div class="widget-day__title">25&nbsp;июня</div>
                    <div class="widget-entry clearfix">
                        <div class="widget-entry__item">
                            <div class="widget-entry__title">
                                <a href="#" class="h-link">&nbsp;&nbsp;&nbsp; Висцеральная теория сна выглядит стр…</a>
                            </div>
                            <div class="widget-entry__info">2&nbsp;ответа</div>
                        </div>
                    </div>
                </div>
                <div class="widget-entry">
                    <div class="widget-day__title">16&nbsp;мая</div>
                    <div class="widget-entry clearfix">
                        <div class="widget-entry__item">
                            <div class="widget-entry__title">
                                <a href="#" class="h-link">Пожалуй у ByFly сегодня даже более серьё…</a>
                            </div>
                            <div class="widget-entry__info">2&nbsp;ответа</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div></div>

<div class="col-sm-10 all-posts">
<div class="row b-post-filter">
    <span class="pull-right">
        записи по
        <div class="btn-group">
            <span type="button" class="pseudo-link" data-toggle="dropdown">месяцам</span>
            <ul class="dropdown-menu dropdown-menu-right" role="menu">
                <li><a rel="nofollow" href="#" class="h-link">Нулябрь</a><li>
                <li><a rel="nofollow" href="#" class="h-link">Первябрь</a><li>
            </ul>
        </div> ·
        <div class="btn-group">
            <span type="button" class="pseudo-link" data-toggle="dropdown">меткам</span>
            <ul class="dropdown-menu dropdown-menu-right" role="menu">                <li>                    <a rel="nofollow" class="tag-1" href="http://imdagger.github.io/tag/oshibka.html" class="h-link">ошибка</a>                    <a rel="nofollow" class="tag-2" href="http://imdagger.github.io/tag/javascript.html" class="h-link">javascript</a>                    <a rel="nofollow" class="tag-2" href="http://imdagger.github.io/tag/icfpc.html" class="h-link">icfpc</a>                    <a rel="nofollow" class="tag-2" href="http://imdagger.github.io/tag/java.html" class="h-link">java</a>                    <a rel="nofollow" class="tag-1" href="http://imdagger.github.io/tag/zhizn.html" class="h-link">жизнь</a>                </li>                <li>                    <a rel="nofollow" class="tag-1" href="http://imdagger.github.io/tag/blender.html" class="h-link">blender</a>                    <a rel="nofollow" class="tag-1" href="http://imdagger.github.io/tag/ia.html" class="h-link">Я</a>                    <a rel="nofollow" class="tag-2" href="http://imdagger.github.io/tag/google.html" class="h-link">google</a>                    <a rel="nofollow" class="tag-2" href="http://imdagger.github.io/tag/sborka.html" class="h-link">сборка</a>                    <a rel="nofollow" class="tag-1" href="http://imdagger.github.io/tag/programmirovanie.html" class="h-link">программирование</a>                </li>                <li>                    <a rel="nofollow" class="tag-1" href="http://imdagger.github.io/tag/rabota.html" class="h-link">работа</a>                    <a rel="nofollow" class="tag-2" href="http://imdagger.github.io/tag/linux.html" class="h-link">linux</a>                    <a rel="nofollow" class="tag-2" href="http://imdagger.github.io/tag/eda.html" class="h-link">еда</a>                    <a rel="nofollow" class="tag-2" href="http://imdagger.github.io/tag/iandeks.html" class="h-link">Яндекс</a>                    <a rel="nofollow" class="tag-1" href="http://imdagger.github.io/tag/nabrosok.html" class="h-link">набросок</a>                </li>                <li>                    <a rel="nofollow" class="tag-2" href="http://imdagger.github.io/tag/emacs.html" class="h-link">emacs</a>                    <a rel="nofollow" class="tag-1" href="http://imdagger.github.io/tag/radost.html" class="h-link">радость</a>                    <a rel="nofollow" class="tag-1" href="http://imdagger.github.io/tag/python.html" class="h-link">python</a>                    <a rel="nofollow" class="tag-2" href="http://imdagger.github.io/tag/bredni.html" class="h-link">бредни</a>                    <a rel="nofollow" class="tag-1" href="http://imdagger.github.io/tag/bge.html" class="h-link">bge</a>                </li>            </ul>
        </div> ·
        <div class="btn-group">
            <span type="button" class="pseudo-link" data-toggle="dropdown">типам</span>
            <ul class="dropdown-menu dropdown-menu-right" role="menu">
                <li><a rel="nofollow" href="http://imdagger.github.io/category/description.html" class="h-link">обращение</a><li>
                <li><a rel="nofollow" href="http://imdagger.github.io/category/friend.html" class="h-link"></a><li>
                <li><a rel="nofollow" href="http://imdagger.github.io/category/join.html" class="h-link"></a><li>
                <li><a rel="nofollow" href="http://imdagger.github.io/category/link.html" class="h-link">ссылки</a><li>
                <li><a rel="nofollow" href="http://imdagger.github.io/category/mood.html" class="h-link">настроение</a><li>
                <li><a rel="nofollow" href="http://imdagger.github.io/category/photo.html" class="h-link">фото</a><li>
                <li><a rel="nofollow" href="http://imdagger.github.io/category/text.html" class="h-link">текст</a><li>
                <li><a rel="nofollow" href="http://imdagger.github.io/category/video.html" class="h-link">видео</a><li>
                <li><a rel="nofollow" href="http://imdagger.github.io/category/wishlist.html" class="h-link"></a><li>
            </ul>
        </div>
    </span>
</div>
    <div class="row b-post">
<div class="panel panel-text">
    <div class="panel-heading b-post-type b-post-type-text">
        <b class="b-user">
            <a class="b-user__link" href="http://imdagger.github.io/author/imdagger.html"><b class="b-user__first-letter">I</b>MDagger</a>
        </b>
написал        <span class="pull-right b-date">
            <a class="h-link" href="http://imdagger.github.io/posts/2009/09/14/emacs-i-uvedomleniia-v-tree/" >
                14 сентября 2009 года, 18:06
            </a>
        </span>
    </div>
    <div class="panel-body">
        <div class="col-sm-1 b-post__layout-left">
            <a href="http://imdagger.github.io/author/imdagger.html"><img src="http://upics.yandex.ru/22199227/middle"></a>
        </div>
        <div class="col-sm-11 b-right-col">
            <noindex>
<div class="row tags-row">
    <span class="tag"><a rel="nofollow" class="h-link" href="http://imdagger.github.io/tag/emacs.html">emacs</a></span>,    <span class="tag"><a rel="nofollow" class="h-link" href="http://imdagger.github.io/tag/trei.html">трей</a></span></div>
            </noindex>
            <div class="post-title">
<a class="no-link" href="http://imdagger.github.io/posts/2009/09/14/emacs-i-uvedomleniia-v-tree/">Emacs и уведомления в трее</a>            </div>
            <div class="row post-body">
                <div class="b-text">
<p>Т.к. <strong>Emacs</strong> не поддерживает загрузку динамических библиотек (а
оно ему и не нужно), то иконку в трее и изменение её статуса будет
отображать отдельное небольшое приложение, которое соединяется пайпами с
Emacs. Я модифицировал существующее такое приложение (описывал его
раньше),
<a class="reference external" href="https://yadi.sk/d/lAg5SLN8UmdLG">tray_daemon.c</a> - это
версия, которая умеет:</p>
<ul class="simple">
<li>Отложенное создание иконки (полезно, если иконка нужна только по
время соединения)</li>
<li>Скрытие/показ и мерцание в трее</li>
<li>Установка изображения иконки (чтобы можно было передавать из файла
конфигурации Emacs’а, а не была вшита намертво)</li>
<li>Уничтожение иконки</li>
<li>Возможность отдельной иконки для каждого процесса Emacs, или
множество различных иконок для одного процесса Emacs, т.к. работает
через пайпы и только со своим родительским процессом</li>
</ul>
<p>Вот так оно выглядит:</p>
<p><a class="reference external" href="http://fotki.yandex.ru/users/imdagger/view/80430/"><img alt="Панель" src="http://img-fotki.yandex.ru/get/3707/imdagger.3/0_13a2e_da2dfe6b_L" title="Панель"/></a></p>
<p class="cut"><a class="h-link reference internal" data-toggle="collapse" href="#cut_46602384">дальше много текста и пояснений</a></p>
<div class="collapse" id="cut_46602384">
<p>Процесс, отображающий иконку в трее:</p>
<ol class="arabic simple">
<li>Дублирует при помощи dup стандартный поток ввода (stdin)</li>
<li>Устанавливает значение названия файла иконки по умолчанию равное
<strong>“icon.png”</strong></li>
<li>Переходит к считыванию команд</li>
<li>Т.к. <strong>stdin</strong> находится в режиме блокировки, то <strong>read</strong> будет
ожидать хотя бы одного символа на входном потоке</li>
<li>Ожидает символы либо <strong>‘I’</strong>, либо <strong>‘s’</strong></li>
<li>Если пришло сообщение <strong>‘s’</strong>, то следующие за ним символы — название
файла с изображением (эту команду возможно вызывать только до
инициализации и сколько угодно раз)</li>
<li>Если пришла команда-символ <strong>‘I’</strong>, то вызывается инициализация
<strong>Gtk</strong> и разблокировка потока (добавляется <em>O_NONBLOCK</em>)</li>
<li>Если инициализация уже была произведена ранее, то в режиме
неблокирующего потока приложение ожидает команды <strong>‘b’</strong>, <strong>‘B’</strong>,
<strong>‘v’</strong>, <strong>‘V’</strong>, <strong>‘Q’</strong>, которыми и управляется</li>
</ol>
<p>Описание команд:</p>
<ul class="simple">
<li><strong>‘I’</strong> — инициализация gtk и показ в трее</li>
<li><strong>‘s’ символы_однобайтные</strong> — установка исходного изображения, название
не обязательно завершать терминирующим нулём</li>
<li><strong>‘b’</strong> — выключить мерцание</li>
<li><strong>‘B’</strong> — включить мерцание</li>
<li><strong>‘v’</strong> — спрятать иконку</li>
<li><strong>‘V’</strong> — показать иконку</li>
<li><strong>‘Q’</strong>  — завершение процесса, уничтожение иконки</li>
</ul>
<p>Затем для этого приложения был написан на Elisp’е код, который связал
<strong>ejabber.el</strong> и «демона трея». Разберём по порядку. Функция
<code class="code">
my-tray-icon-send-command</code>
 умеет отправлять набор символов дочернему
процессу tray_daemon.</p>
<div class="highlight"><pre><span class="pgcss-p">(</span><span class="pgcss-nb">defun</span> <span class="pgcss-nv">my-tray-icon-send-command</span> <span class="pgcss-p">(</span><span class="pgcss-nv">command</span><span class="pgcss-p">)</span>
  <span class="pgcss-p">(</span><span class="pgcss-nv">process-send-string</span> <span class="pgcss-nv">my-tray-icon-process</span> <span class="pgcss-nv">command</span><span class="pgcss-p">)</span>
  <span class="pgcss-p">(</span><span class="pgcss-nv">process-send-eof</span> <span class="pgcss-nv">my-tray-icon-process</span><span class="pgcss-p">))</span>
</pre></div>
<p>Функция <code class="code">
process-send-string</code>
 отправляет строку command процессу
<code class="code">
my-tray-icon-process</code>
, она встроенная в Emacs. А функция
<code class="code">
process-senf-eof</code>
 отправляет сигнал <strong>EOF</strong> во входной поток процесса,
что позволяет процирующему потоку понять, что запись
завершена. <code class="code">
my-tray-icon-send-command</code>
 будет использована, как
базовая для всех функций управления.</p>
<div class="highlight"><pre><span class="pgcss-p">(</span><span class="pgcss-nb">defun</span> <span class="pgcss-nv">my-tray-icon-set</span> <span class="pgcss-p">(</span><span class="pgcss-nv">icon-path</span><span class="pgcss-p">)</span>
  <span class="pgcss-p">(</span><span class="pgcss-nv">my-tray-icon-send-command</span> <span class="pgcss-s">"s"</span><span class="pgcss-p">)</span>
  <span class="pgcss-p">(</span><span class="pgcss-nv">my-tray-icon-send-command</span> <span class="pgcss-nv">icon-path</span><span class="pgcss-p">))</span>
</pre></div>
<p>Функция <em>my-tray-icon-set</em> устанавливает путь к изображению иконки.
Для этого сначала посылается байт ‘s’, а затем строка байтов из
icon-path.</p>
<p>Далее показан код функций для управления демоном в трее и смысл их
аналогичен посылаемому символьному коду:</p>
<div class="highlight"><pre><span class="pgcss-p">(</span><span class="pgcss-nb">defun</span> <span class="pgcss-nv">my-tray-icon-init</span> <span class="pgcss-p">()</span>
  <span class="pgcss-p">(</span><span class="pgcss-nv">my-tray-icon-send-command</span> <span class="pgcss-s">"I"</span><span class="pgcss-p">))</span>

<span class="pgcss-p">(</span><span class="pgcss-nb">defun</span> <span class="pgcss-nv">my-tray-icon-destroy</span> <span class="pgcss-p">()</span>
  <span class="pgcss-p">(</span><span class="pgcss-nv">my-tray-icon-send-command</span> <span class="pgcss-s">"Q"</span><span class="pgcss-p">))</span>

<span class="pgcss-p">(</span><span class="pgcss-nb">defun</span> <span class="pgcss-nv">my-tray-icon-show</span> <span class="pgcss-p">()</span>
  <span class="pgcss-p">(</span><span class="pgcss-nv">my-tray-icon-send-command</span> <span class="pgcss-s">"V"</span><span class="pgcss-p">))</span>

<span class="pgcss-p">(</span><span class="pgcss-nb">defun</span> <span class="pgcss-nv">my-tray-icon-hide</span> <span class="pgcss-p">()</span>
  <span class="pgcss-p">(</span><span class="pgcss-nv">my-tray-icon-send-command</span> <span class="pgcss-s">"v"</span><span class="pgcss-p">))</span>

<span class="pgcss-p">(</span><span class="pgcss-nb">defun</span> <span class="pgcss-nv">my-tray-icon-blink</span> <span class="pgcss-p">()</span>
  <span class="pgcss-p">(</span><span class="pgcss-nv">my-tray-icon-send-command</span> <span class="pgcss-s">"B"</span><span class="pgcss-p">))</span>

<span class="pgcss-p">(</span><span class="pgcss-nb">defun</span> <span class="pgcss-nv">my-tray-icon-no-blink</span> <span class="pgcss-p">()</span>
  <span class="pgcss-p">(</span><span class="pgcss-nv">my-tray-icon-send-command</span> <span class="pgcss-s">"b"</span><span class="pgcss-p">))</span>
</pre></div>
<p>Теперь потребуется описать функцию, которая создаст дочерний
процесс, инициализирует и сконфигурирует демона и установит переменную
<em>my-tray-icon-process</em> с названием процесса:</p>
<div class="highlight"><pre><span class="pgcss-p">(</span><span class="pgcss-nb">defun</span> <span class="pgcss-nv">my-tray-icon-start</span> <span class="pgcss-p">()</span>
  <span class="pgcss-p">(</span><span class="pgcss-k">setq</span> <span class="pgcss-nv">my-tray-icon-process</span> <span class="pgcss-s">"*tray_icon*"</span><span class="pgcss-p">)</span>
  <span class="pgcss-p">(</span><span class="pgcss-k">if</span> <span class="pgcss-p">(</span><span class="pgcss-nv">get-process</span> <span class="pgcss-nv">my-tray-icon-process</span><span class="pgcss-p">)</span>
      <span class="pgcss-p">()</span>
     <span class="pgcss-p">(</span><span class="pgcss-nv">start-process</span> <span class="pgcss-nv">my-tray-icon-process</span> <span class="pgcss-no">nil</span> <span class="pgcss-s">"~/.emacs.d/tray_daemon"</span><span class="pgcss-p">)))</span>
</pre></div>
<p>Демон будет иметь уникальное имя *tray_icon* в Emacs, а при
помощи <em>get-process</em> проверяется, чтобы процесс не был уже запущен, т.к.
нет смысла в двух одинаковых. Но если <strong>*tray_icon*</strong> отсутствует, то
при помощи встроенной функции <em>start-process</em> он запускается. Формат
вызова <em>start-process</em>:</p>
<div class="highlight"><pre><span class="pgcss-p">(</span><span class="pgcss-nv">start-process</span> <span class="pgcss-err">имя</span><span class="pgcss-nb">-</span><span class="pgcss-err">процесса</span><span class="pgcss-nb">-</span><span class="pgcss-err">в</span><span class="pgcss-nv">-Emacs</span> <span class="pgcss-err">буфер</span><span class="pgcss-nb">-</span><span class="pgcss-err">обмена</span> <span class="pgcss-s">"путь_к_файлу_на_диске"</span><span class="pgcss-p">)</span>
</pre></div>
<p>Т.к. обмен с процессом будет происходить последством каналов, то
буфер нужно установить равным nil.</p>
<p>Для того, чтобы обрабатывать прочитанные сообщения и выключать
мерцание иконки в трее я создал функцию <em>my-tray-icon-mesagge-handler</em>:</p>
<div class="highlight"><pre><span class="pgcss-p">(</span><span class="pgcss-nb">defun</span> <span class="pgcss-nv">my-tray-icon-mesagge-handler</span> <span class="pgcss-p">()</span>
  <span class="pgcss-p">(</span><span class="pgcss-nb">when</span> <span class="pgcss-p">(</span><span class="pgcss-nb">and</span> <span class="pgcss-p">(</span><span class="pgcss-nv">get-process</span> <span class="pgcss-nv">my-tray-icon-process</span><span class="pgcss-p">)</span>
  <span class="pgcss-p">(</span><span class="pgcss-nb">equal</span> <span class="pgcss-nv">jabber-activity-count-string</span> <span class="pgcss-s">"0"</span><span class="pgcss-p">))</span>
  <span class="pgcss-p">(</span><span class="pgcss-nv">my-tray-icon-no-blink</span><span class="pgcss-p">)))</span>
</pre></div>
<p>В jabber.el написано, что переменная <code class="code">
jabber-activity-count-string</code>

содержит строковое значение текущего количества пользователей, сообщения
которых ещё не прочитаны. Поэтому нужно её проверить на равество “0” и,
если это так, то убрать мерцание. Этот обработчик вешается как хук на
обновление активности:</p>
<div class="highlight"><pre><span class="pgcss-p">(</span><span class="pgcss-nv">add-hook</span> <span class="pgcss-ss">'jabber-activity-update-hook</span>
  <span class="pgcss-ss">'my-tray-icon-mesagge-handler</span><span class="pgcss-p">)</span>
</pre></div>
<p>Функция обновления активности вызывается в случае, если число
непрочитанных сообщений изменилось. Теперь как только наше приложение
смогло не мерцать, то следует его научить мерцать:</p>
<div class="highlight"><pre><span class="pgcss-p">(</span><span class="pgcss-nb">defun</span> <span class="pgcss-nv">my-show-notification</span> <span class="pgcss-p">(</span><span class="pgcss-nv">from</span> <span class="pgcss-nv">buffer</span> <span class="pgcss-nv">text</span> <span class="pgcss-nv">proposed-alert</span><span class="pgcss-p">)</span>
  <span class="pgcss-p">(</span><span class="pgcss-nb">when</span> <span class="pgcss-p">(</span><span class="pgcss-nb">not</span> <span class="pgcss-p">(</span><span class="pgcss-nb">equal</span> <span class="pgcss-p">(</span><span class="pgcss-nv">get-buffer-window</span> <span class="pgcss-nv">buffer</span> <span class="pgcss-ss">'visible</span><span class="pgcss-p">)</span>
  <span class="pgcss-p">(</span><span class="pgcss-nv">selected-window</span><span class="pgcss-p">)))</span>
  <span class="pgcss-p">(</span><span class="pgcss-nv">jabber-message-osd</span> <span class="pgcss-nv">from</span> <span class="pgcss-nv">buffer</span> <span class="pgcss-nv">text</span> <span class="pgcss-nv">proposed-alert</span><span class="pgcss-p">)</span>
  <span class="pgcss-p">(</span><span class="pgcss-nv">my-tray-icon-blink</span><span class="pgcss-p">)))</span>

<span class="pgcss-p">(</span><span class="pgcss-nv">add-hook</span> <span class="pgcss-ss">'jabber-alert-message-hooks</span>
  <span class="pgcss-ss">'my-show-notification</span><span class="pgcss-p">)</span>
</pre></div>
<p>Обязательно нужно, чтобы функция-обработчик пришедшего сообщения,
которая применяется как хук к <code class="code">
jabber-alert-message-hooks</code>
, принимала 4
параметра: от кого, буфер для общения с этим человеком, текст сообщения,
тип сообщения (отошёл, текст, отключён и т.д.). Чтобы иконка не начинала
мерцать в тот момент, когда пользователь и так видит окно чата с
человеком, то вызывается <code class="code">
(get-buffer-window buffer 'visible)</code>
, с
параметром visible она проверяет виден ли буфер (учитывает даже факт,
что окно свёрнуто, но не учитывает множество рабочих
столов). <code class="code">
(jabber-message-osd from buffer text proposed-alert)</code>
 я
использую, чтобы xosd (треубется скачать osd.el) отображал от кого
пришло сообщение на экране:</p>
<p class="text-center"><a class="reference external" href="http://fotki.yandex.ru/users/imdagger/view/80432/"><img alt="Новое сообщение" src="http://img-fotki.yandex.ru/get/3711/imdagger.3/0_13a30_8fd4035a_L" title="Новое сообщение"/></a></p>
<p>Ну и на закуску мой полный jabber_cfg.el:</p>
<div class="highlight"><pre><span class="pgcss-c1">;; а пароль вводить ручками при к каждом коннекте</span>
<span class="pgcss-c1">;; ну не доверяю я хранить его в открытов виде тут</span>
<span class="pgcss-p">(</span><span class="pgcss-k">setq</span> <span class="pgcss-nv">jabber-account-list</span>
 <span class="pgcss-o">'</span><span class="pgcss-p">((</span><span class="pgcss-s">"имя@ya.ru/emacs"</span>
  <span class="pgcss-p">(</span><span class="pgcss-ss">:network-server</span> <span class="pgcss-o">.</span> <span class="pgcss-s">"сервер"</span><span class="pgcss-p">)</span>
  <span class="pgcss-p">(</span><span class="pgcss-ss">:connection-type</span> <span class="pgcss-o">.</span> <span class="pgcss-nv">ssl</span><span class="pgcss-p">))))</span>

<span class="pgcss-c1">;; раскомментировать, если будет говорить, что переменная</span>
<span class="pgcss-c1">;; my-tray-icon-process не объявлена</span>
<span class="pgcss-c1">;; (setq my-tray-icon-process "*tray_icon*")</span>

<span class="pgcss-p">(</span><span class="pgcss-nb">defun</span> <span class="pgcss-nv">my-tray-icon-send-command</span> <span class="pgcss-p">(</span><span class="pgcss-nv">command</span><span class="pgcss-p">)</span>
  <span class="pgcss-p">(</span><span class="pgcss-nv">process-send-string</span> <span class="pgcss-nv">my-tray-icon-process</span> <span class="pgcss-nv">command</span><span class="pgcss-p">)</span>
  <span class="pgcss-p">(</span><span class="pgcss-nv">process-send-eof</span> <span class="pgcss-nv">my-tray-icon-process</span><span class="pgcss-p">))</span>

<span class="pgcss-p">(</span><span class="pgcss-nb">defun</span> <span class="pgcss-nv">my-tray-icon-set</span> <span class="pgcss-p">(</span><span class="pgcss-nv">icon-path</span><span class="pgcss-p">)</span>
  <span class="pgcss-p">(</span><span class="pgcss-nv">my-tray-icon-send-command</span> <span class="pgcss-s">"s"</span><span class="pgcss-p">)</span>
  <span class="pgcss-p">(</span><span class="pgcss-nv">my-tray-icon-send-command</span> <span class="pgcss-nv">icon-path</span><span class="pgcss-p">))</span>

<span class="pgcss-p">(</span><span class="pgcss-nb">defun</span> <span class="pgcss-nv">my-tray-icon-init</span> <span class="pgcss-p">()</span>
  <span class="pgcss-p">(</span><span class="pgcss-nv">my-tray-icon-send-command</span> <span class="pgcss-s">"I"</span><span class="pgcss-p">))</span>

<span class="pgcss-p">(</span><span class="pgcss-nb">defun</span> <span class="pgcss-nv">my-tray-icon-destroy</span> <span class="pgcss-p">()</span>
  <span class="pgcss-p">(</span><span class="pgcss-nv">my-tray-icon-send-command</span> <span class="pgcss-s">"Q"</span><span class="pgcss-p">))</span>

<span class="pgcss-p">(</span><span class="pgcss-nb">defun</span> <span class="pgcss-nv">my-tray-icon-show</span> <span class="pgcss-p">()</span>
  <span class="pgcss-p">(</span><span class="pgcss-nv">my-tray-icon-send-command</span> <span class="pgcss-s">"V"</span><span class="pgcss-p">))</span>

<span class="pgcss-p">(</span><span class="pgcss-nb">defun</span> <span class="pgcss-nv">my-tray-icon-hide</span> <span class="pgcss-p">()</span>
  <span class="pgcss-p">(</span><span class="pgcss-nv">my-tray-icon-send-command</span> <span class="pgcss-s">"v"</span><span class="pgcss-p">))</span>

<span class="pgcss-p">(</span><span class="pgcss-nb">defun</span> <span class="pgcss-nv">my-tray-icon-blink</span> <span class="pgcss-p">()</span>
  <span class="pgcss-p">(</span><span class="pgcss-nv">my-tray-icon-send-command</span> <span class="pgcss-s">"B"</span><span class="pgcss-p">))</span>

<span class="pgcss-p">(</span><span class="pgcss-nb">defun</span> <span class="pgcss-nv">my-tray-icon-no-blink</span> <span class="pgcss-p">()</span>
  <span class="pgcss-p">(</span><span class="pgcss-nv">my-tray-icon-send-command</span> <span class="pgcss-s">"b"</span><span class="pgcss-p">))</span>

<span class="pgcss-p">(</span><span class="pgcss-nb">defun</span> <span class="pgcss-nv">my-tray-icon-start</span> <span class="pgcss-p">()</span>
  <span class="pgcss-p">(</span><span class="pgcss-k">setq</span> <span class="pgcss-nv">my-tray-icon-process</span> <span class="pgcss-s">"*tray_icon*"</span><span class="pgcss-p">)</span>
  <span class="pgcss-p">(</span><span class="pgcss-k">if</span> <span class="pgcss-p">(</span><span class="pgcss-nv">get-process</span> <span class="pgcss-nv">my-tray-icon-process</span><span class="pgcss-p">)</span>
      <span class="pgcss-p">()</span>
    <span class="pgcss-p">(</span><span class="pgcss-nv">start-process</span> <span class="pgcss-nv">my-tray-icon-process</span> <span class="pgcss-no">nil</span> <span class="pgcss-s">"~/.emacs.d/tray_daemon"</span><span class="pgcss-p">)))</span>

<span class="pgcss-c1">;; подключение скачанной библиотеки</span>
<span class="pgcss-p">(</span><span class="pgcss-nb">require</span> <span class="pgcss-ss">'osd</span><span class="pgcss-p">)</span>

<span class="pgcss-c1">;; настройки для xosd</span>
<span class="pgcss-p">(</span><span class="pgcss-k">setq</span> <span class="pgcss-nv">osd-program-args</span>
  <span class="pgcss-o">'</span><span class="pgcss-p">(</span><span class="pgcss-s">"--pos"</span> <span class="pgcss-s">"bottom"</span>
  <span class="pgcss-s">"--offset"</span> <span class="pgcss-s">"7"</span>
  <span class="pgcss-s">"--align"</span> <span class="pgcss-s">"left"</span>
  <span class="pgcss-s">"--indent"</span> <span class="pgcss-s">"18"</span>
  <span class="pgcss-s">"--delay"</span> <span class="pgcss-s">"3"</span>
  <span class="pgcss-s">"--color"</span> <span class="pgcss-s">"red"</span>
  <span class="pgcss-s">"--shadow"</span> <span class="pgcss-s">"2"</span>
  <span class="pgcss-s">"--shadowcolour"</span> <span class="pgcss-s">"#1e2320"</span>
  <span class="pgcss-s">"--lines"</span> <span class="pgcss-s">"3"</span>
  <span class="pgcss-s">"--font"</span>
  <span class="pgcss-s">"-*-times new roman-medium-r-*-*-24-*-*-*-*-*-*-*"</span><span class="pgcss-p">))</span>

<span class="pgcss-p">(</span><span class="pgcss-nb">require</span> <span class="pgcss-ss">'jabber-autoloads</span><span class="pgcss-p">)</span>

<span class="pgcss-p">(</span><span class="pgcss-nb">defun</span> <span class="pgcss-nv">my-tray-icon-mesagge-handler</span> <span class="pgcss-p">()</span>
  <span class="pgcss-p">(</span><span class="pgcss-nb">when</span> <span class="pgcss-p">(</span><span class="pgcss-nb">and</span> <span class="pgcss-p">(</span><span class="pgcss-nv">get-process</span> <span class="pgcss-nv">my-tray-icon-process</span><span class="pgcss-p">)</span>
  <span class="pgcss-p">(</span><span class="pgcss-nb">equal</span> <span class="pgcss-nv">jabber-activity-count-string</span> <span class="pgcss-s">"0"</span><span class="pgcss-p">))</span>
  <span class="pgcss-p">(</span><span class="pgcss-nv">my-tray-icon-no-blink</span><span class="pgcss-p">)))</span>

<span class="pgcss-p">(</span><span class="pgcss-nv">add-hook</span> <span class="pgcss-ss">'jabber-activity-update-hook</span>
  <span class="pgcss-ss">'my-tray-icon-mesagge-handler</span><span class="pgcss-p">)</span>

<span class="pgcss-p">(</span><span class="pgcss-nv">add-hook</span> <span class="pgcss-ss">'jabber-post-connect-hooks</span>
  <span class="pgcss-p">(</span><span class="pgcss-k">lambda</span> <span class="pgcss-p">(</span><span class="pgcss-nv">connection</span><span class="pgcss-p">)</span>
  <span class="pgcss-p">(</span><span class="pgcss-nv">my-tray-icon-start</span><span class="pgcss-p">)</span>
  <span class="pgcss-p">(</span><span class="pgcss-nv">my-tray-icon-set</span> <span class="pgcss-s">"/home/imdagger/.emacs.d/icon.png"</span><span class="pgcss-p">)</span>
  <span class="pgcss-p">(</span><span class="pgcss-nv">my-tray-icon-init</span><span class="pgcss-p">)</span>
  <span class="pgcss-p">(</span><span class="pgcss-nv">my-tray-icon-show</span><span class="pgcss-p">)))</span>

<span class="pgcss-p">(</span><span class="pgcss-nv">add-hook</span> <span class="pgcss-ss">'jabber-post-disconnect-hook</span>
  <span class="pgcss-p">(</span><span class="pgcss-k">lambda</span> <span class="pgcss-p">()</span>
  <span class="pgcss-p">(</span><span class="pgcss-nv">my-tray-icon-hide</span><span class="pgcss-p">)</span>
  <span class="pgcss-p">(</span><span class="pgcss-nv">my-tray-icon-destroy</span><span class="pgcss-p">)))</span>

<span class="pgcss-p">(</span><span class="pgcss-nb">defun</span> <span class="pgcss-nv">my-show-notification</span> <span class="pgcss-p">(</span><span class="pgcss-nv">from</span> <span class="pgcss-nv">buffer</span> <span class="pgcss-nv">text</span> <span class="pgcss-nv">proposed-alert</span><span class="pgcss-p">)</span>
  <span class="pgcss-p">(</span><span class="pgcss-nb">when</span> <span class="pgcss-p">(</span><span class="pgcss-nb">not</span> <span class="pgcss-p">(</span><span class="pgcss-nb">equal</span> <span class="pgcss-p">(</span><span class="pgcss-nv">get-buffer-window</span> <span class="pgcss-nv">buffer</span> <span class="pgcss-ss">'visible</span><span class="pgcss-p">)</span>
  <span class="pgcss-p">(</span><span class="pgcss-nv">selected-window</span><span class="pgcss-p">)))</span>
  <span class="pgcss-p">(</span><span class="pgcss-nv">jabber-message-osd</span> <span class="pgcss-nv">from</span> <span class="pgcss-nv">buffer</span> <span class="pgcss-nv">text</span> <span class="pgcss-nv">proposed-alert</span><span class="pgcss-p">)</span>
  <span class="pgcss-p">(</span><span class="pgcss-nv">my-tray-icon-blink</span><span class="pgcss-p">)))</span>

<span class="pgcss-p">(</span><span class="pgcss-nv">add-hook</span> <span class="pgcss-ss">'jabber-alert-message-hooks</span>
  <span class="pgcss-ss">'my-show-notification</span><span class="pgcss-p">)</span>

<span class="pgcss-c1">;; хуки на изменение статуса и отображение через xosd</span>
<span class="pgcss-p">(</span><span class="pgcss-nv">add-hook</span> <span class="pgcss-ss">'jabber-alert-muc-hooks</span> <span class="pgcss-ss">'jabber-muc-osd</span><span class="pgcss-p">)</span>
<span class="pgcss-p">(</span><span class="pgcss-nv">add-hook</span> <span class="pgcss-ss">'jabber-alert-presence-hooks</span> <span class="pgcss-ss">'jabber-presence-osd</span><span class="pgcss-p">)</span>

<span class="pgcss-c1">;; нам не нужная отладочная информация</span>
<span class="pgcss-c1">;; включим, когда будем что-то дорабатывать в jabber.el</span>
<span class="pgcss-p">(</span><span class="pgcss-k">setq</span> <span class="pgcss-nv">fsm-debug</span> <span class="pgcss-no">nil</span><span class="pgcss-p">)</span>

<span class="pgcss-c1">;; параметры для истории, вида и др.</span>
<span class="pgcss-p">(</span><span class="pgcss-k">setq</span> <span class="pgcss-nv">jabber-history-enabled</span> <span class="pgcss-no">t</span>
  <span class="pgcss-nv">jabber-use-global-history</span> <span class="pgcss-no">nil</span>
  <span class="pgcss-nv">jabber-history-dir</span> <span class="pgcss-s">"~/.emacs.d/jabber/"</span>
  <span class="pgcss-nv">jabber-chatstates-confirm</span> <span class="pgcss-no">t</span>
  <span class="pgcss-nv">jabber-events-confirm-composing</span> <span class="pgcss-no">t</span>
  <span class="pgcss-nv">jabber-chat-time-format</span> <span class="pgcss-s">"%a %d %b %H:%M:%S"</span>
  <span class="pgcss-nv">jabber-backlog-number</span> <span class="pgcss-mi">50</span><span class="pgcss-p">)</span>

<span class="pgcss-c1">;; быстрое переключение к буфферу с сообщением</span>
<span class="pgcss-p">(</span><span class="pgcss-nv">global-set-key</span> <span class="pgcss-nv">[S-f12]</span> <span class="pgcss-ss">'jabber-activity-switch-to</span><span class="pgcss-p">)</span>
</pre></div>
</div>                </div>
            </div>
            <div class="row comments-row">
                <span><a class="pseudo-link b-candy b-comment-shortcut"><i class="b-ico"></i>ответить</a></span>
            </div>
        </div>
    </div>
</div><div class="panel panel-link">
    <div class="panel-heading b-post-type b-post-type-link">
        <b class="b-user">
            <a class="b-user__link" href="http://imdagger.github.io/author/imdagger.html"><b class="b-user__first-letter">I</b>MDagger</a>
        </b>
поделился ссылкой        <span class="pull-right b-date">
            <a class="h-link" href="http://imdagger.github.io/posts/2009/08/19/izveshcheniia-v-tree-ot-emacs/" >
                19 августа 2009 года, 18:11
            </a>
        </span>
    </div>
    <div class="panel-body">
        <div class="col-sm-1 b-post__layout-left">
            <a href="http://imdagger.github.io/author/imdagger.html"><img src="http://upics.yandex.ru/22199227/middle"></a>
        </div>
        <div class="col-sm-11 b-right-col">
            <noindex>
<div class="row tags-row">
    <span class="tag"><a rel="nofollow" class="h-link" href="http://imdagger.github.io/tag/emacs.html">emacs</a></span>,    <span class="tag"><a rel="nofollow" class="h-link" href="http://imdagger.github.io/tag/trei.html">трей</a></span></div>
            </noindex>
            <div class="post-title">
<a class="h-link" href="http://www.emacswiki.org/emacs/ErcTray">
    <img class="b-ico" src="http://favicon.yandex.ru/favicon/www.emacswiki.org?default=yaru-external">Извещения в трее от Emacs</a>
            </div>
            <div class="row post-body">
                <div class="b-text">
<p>Небольшое, но полезное описание того, как сделать, чтобы была иконка
Emacs в трее (при помощи дополнительной утилиты), и чтобы её состоянием
можно было управлять. Можно сделать, чтобы она моргала. Может что-нибудь
добавлю в неё для моего jabber.el (в духе попап меню, котрое показывает
количество сообщений от пользователя).</p>
                </div>
            </div>
            <div class="row comments-row">
                <span><a class="pseudo-link b-candy b-comment-shortcut"><i class="b-ico"></i>ответить</a></span>
            </div>
        </div>
    </div>
</div>    </div>
</div>
        </div>
    </body>
</html>