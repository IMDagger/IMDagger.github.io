<!DOCTYPE html>
<html lang="ru">
    <head>
        <meta charset="utf-8" />
        <title>IMDagger: Дневник</title>
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <meta name="description" content="Блог IMDagger: IT и жизнь" />
        <meta name="keywords" content="python,lisp,scheme,racket,emacs,blender,программирование,моделирование,lua,c++,c,js,java,git,bazaar" />
        <meta name="author" content="Alex Moiseenko (IMDagger)" />

<meta name="robots" content="noindex"/>
        <!-- Open Graph -->
        <link rel="stylesheet" href="http://maxcdn.bootstrapcdn.com/bootstrap/3.2.0/css/bootstrap.min.css" />
        <link rel="stylesheet" href="http://netdna.bootstrapcdn.com/font-awesome/4.0.3/css/font-awesome.min.css" />
        <link rel="shortcut icon" href="http://imdagger.github.io/favicon.ico" />
        <link rel="stylesheet" href="/theme/css/html4css1.css" />
        <link rel="stylesheet" href="/theme/css/style.css" />
        <link rel="stylesheet" href="/theme/css/pygment.css" />
        <link rel="stylesheet" href="/theme/css/math.css" />
        <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.11.1/jquery.min.js"></script>
        <script src="http://maxcdn.bootstrapcdn.com/bootstrap/3.2.0/js/bootstrap.min.js"></script>
        <script type="text/javascript" src="http://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS_HTML,http://imdagger.github.io/theme/js/math.js"></script>
        <script src="http://s3.amazonaws.com/nwapi/nwmatcher/nwmatcher-1.2.5-min.js"></script>
        <!--[if (gte IE 6)&(lte IE 8)]>
          <script type="text/javascript" src="/theme/js/selectivizr-min.js"></script>
          <noscript><link rel="stylesheet" href="[fallback css]" /></noscript>
        <![endif]-->

        <!-- HTML5 shim, for IE6-8 support of HTML5 elements -->
        <!--[if lt IE 9]>
        <script src="http://html5shim.googlecode.com/svn/trunk/html5.js"></script>
        <![endif]-->
        <link href="http://imdagger.github.io/feeds/all.atom.xml" type="application/atom+xml" rel="alternate" title="IMDagger Atom-лента" />
    </head>

    <body>
        <div class="row page-head">
            <div class="row page-head-status page-head-status-top"><div class="col-sm-12 b-status mine"><p><i></i><a href="#" title="настроение" class="b-consistent-link"><b>Продать кому-то что-то всегда на деле сложнее, чем кажется</b></a></p></div></div>
            <div class="col-sm-2 page-left">
                <a href="#">
                    <img src="http://upics.yandex.ru/22199227/normal" ilo-full-src="http://upics.yandex.ru/22199227/normal">
                </a>
            </div>
            <div class="col-sm-10 all-posts">
                <div class="title-container">
                    <h1><b><a href="http://imdagger.github.io" class="fn nickname">IMDagger</a></b></h1>
                </div>
                <div class="title-menu">
                    <ul class="nav nav-tabs" role="tablist">
                        <li class="active">
                            <a href="#">Дневник</a>
                        </li>
                        <li><a href="http://fotki.yandex.ru/users/imdagger">Фотки</a></li>
                        <li><a href="http://imdagger.github.io/pages/o-sebe.html">О себе</a></li>
                        <li><a href="http://imdagger.github.io/pages/rss-lenta.html">RSS-лента</a></li>
                    </ul>
                </div>
            </div>
        </div>
        <div class="row page-body">
<div class="col-sm-2 page-left">
<div class="row widget widget-photo">
    <a href="posts/2011/08/07/aga-popalsia/" class="b-user-photo__link"><img class="b-user-photo__img" src=" http://img-fotki.yandex.ru/get/5409/22199227.a/0_625fc_e780ccc7_L
?log_nocount=64720402854"></a>
</div><div class="row widget">
    <div class="widget-content b-user-info">
        <div class="widget__body">
            <div class="widget-user-info__age">
                <i class="widget-user-info__sex widget-user-info__sex_type_"></i> 26&nbsp;лет
            </div>
            <div class="widget-user-info__place">
                <a href="#">Гомель</a>,                <a href="#">Беларусь</a>            </div>
            <ul class="contacts">
                <li class="contact contact-type-email"><i></i><a href="mailto:imdagger@yandex.ru">imdagger@yandex.ru</a></li>
                <li class="contact contact-type-ya-online"><i></i>imdagger@ya.ru</li>
                <li class="contact contact-type-icq"><i></i>350395088</li>
            </ul>
        </div>
    </div>
</div>

<div class="row widget">
    <div class="widget-content">
        <div class="widget__title">
            <div class="widget__title-link">Метрика</div>
        </div>
        <div class="widget__body">
            <div class="widget-line">
              <!-- noindex -->
              <!-- googleoff: index -->
              <div class="widget-entry">
                <!-- Yandex.Metrika informer --><a href="https://metrika.yandex.ru/stat/?id=25746494&amp;from=informer" target="_blank" rel="nofollow"><img src="//bs.yandex.ru/informer/25746494/3_1_FFFFFFFF_EFEFEFFF_0_pageviews" style="width:88px; height:31px; border:0;" alt="Яндекс.Метрика" title="Яндекс.Метрика: данные за сегодня (просмотры, визиты и уникальные посетители)" onclick="try{Ya.Metrika.informer({i:this,id:25746494,lang:'ru'});return false}catch(e){}"/></a><!-- /Yandex.Metrika informer --><!-- Yandex.Metrika counter --><script type="text/javascript">(function (d, w, c) { (w[c] = w[c] || []).push(function() { try { w.yaCounter25746494 = new Ya.Metrika({id:25746494, clickmap:true, trackLinks:true, accurateTrackBounce:true}); } catch(e) { } }); var n = d.getElementsByTagName("script")[0], s = d.createElement("script"), f = function () { n.parentNode.insertBefore(s, n); }; s.type = "text/javascript"; s.async = true; s.src = (d.location.protocol == "https:" ? "https:" : "http:") + "//mc.yandex.ru/metrika/watch.js"; if (w.opera == "[object Opera]") { d.addEventListener("DOMContentLoaded", f, false); } else { f(); } })(document, window, "yandex_metrika_callbacks");</script><noscript><div><img src="//mc.yandex.ru/watch/25746494" style="position:absolute; left:-9999px;" alt="" /></div></noscript><!-- /Yandex.Metrika counter -->
                <!-- googleon: index -->
                <!-- /noindex -->
                </div>
            </div>
        </div>
    </div>
</div><div class="row widget">
    <div class="widget-content">
        <div class="widget__title">
            <div class="widget__title-link">Популярное в дневнике</div>
        </div>
        <div class="widget__body">
            <div class="widget-line">
                <div class="widget-entry">
                    <div class="widget-day__title">25&nbsp;июня</div>
                    <div class="widget-entry clearfix">
                        <div class="widget-entry__item">
                            <div class="widget-entry__title">
                                <a href="#" class="h-link">&nbsp;&nbsp;&nbsp; Висцеральная теория сна выглядит стр…</a>
                            </div>
                            <div class="widget-entry__info">2&nbsp;ответа</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div></div>

<div class="col-sm-10 all-posts">
<div class="row b-post-filter">
    <span class="pull-right">
        записи по
        <div class="btn-group">
            <span type="button" class="pseudo-link" data-toggle="dropdown">месяцам</span>
            <ul class="dropdown-menu dropdown-menu-right" role="menu">
                <li><a rel="nofollow" href="#" class="h-link">Нулябрь</a><li>
                <li><a rel="nofollow" href="#" class="h-link">Первябрь</a><li>
            </ul>
        </div> ·
        <div class="btn-group">
            <span type="button" class="pseudo-link" data-toggle="dropdown">меткам</span>
            <ul class="dropdown-menu dropdown-menu-right" role="menu">                <li>                    <a rel="nofollow" class="tag-2" href="http://imdagger.github.io/tag/eda.html" class="h-link">еда</a>                    <a rel="nofollow" class="tag-2" href="http://imdagger.github.io/tag/iandeks.html" class="h-link">Яндекс</a>                    <a rel="nofollow" class="tag-2" href="http://imdagger.github.io/tag/linux.html" class="h-link">linux</a>                    <a rel="nofollow" class="tag-1" href="http://imdagger.github.io/tag/python.html" class="h-link">python</a>                    <a rel="nofollow" class="tag-2" href="http://imdagger.github.io/tag/icfpc.html" class="h-link">icfpc</a>                </li>                <li>                    <a rel="nofollow" class="tag-1" href="http://imdagger.github.io/tag/rabota.html" class="h-link">работа</a>                    <a rel="nofollow" class="tag-2" href="http://imdagger.github.io/tag/google.html" class="h-link">google</a>                    <a rel="nofollow" class="tag-1" href="http://imdagger.github.io/tag/zhizn.html" class="h-link">жизнь</a>                    <a rel="nofollow" class="tag-2" href="http://imdagger.github.io/tag/emacs.html" class="h-link">emacs</a>                    <a rel="nofollow" class="tag-1" href="http://imdagger.github.io/tag/oshibka.html" class="h-link">ошибка</a>                </li>                <li>                    <a rel="nofollow" class="tag-1" href="http://imdagger.github.io/tag/bredni.html" class="h-link">бредни</a>                    <a rel="nofollow" class="tag-1" href="http://imdagger.github.io/tag/ia.html" class="h-link">Я</a>                    <a rel="nofollow" class="tag-2" href="http://imdagger.github.io/tag/javascript.html" class="h-link">javascript</a>                    <a rel="nofollow" class="tag-1" href="http://imdagger.github.io/tag/bge.html" class="h-link">bge</a>                    <a rel="nofollow" class="tag-2" href="http://imdagger.github.io/tag/java.html" class="h-link">java</a>                </li>                <li>                    <a rel="nofollow" class="tag-1" href="http://imdagger.github.io/tag/blender.html" class="h-link">blender</a>                    <a rel="nofollow" class="tag-1" href="http://imdagger.github.io/tag/programmirovanie.html" class="h-link">программирование</a>                    <a rel="nofollow" class="tag-1" href="http://imdagger.github.io/tag/radost.html" class="h-link">радость</a>                    <a rel="nofollow" class="tag-1" href="http://imdagger.github.io/tag/nabrosok.html" class="h-link">набросок</a>                    <a rel="nofollow" class="tag-2" href="http://imdagger.github.io/tag/sborka.html" class="h-link">сборка</a>                </li>            </ul>
        </div> ·
        <div class="btn-group">
            <span type="button" class="pseudo-link" data-toggle="dropdown">типам</span>
            <ul class="dropdown-menu dropdown-menu-right" role="menu">
                <li><a rel="nofollow" href="http://imdagger.github.io/category/description.html" class="h-link">обращение</a><li>
                <li><a rel="nofollow" href="http://imdagger.github.io/category/friend.html" class="h-link">дружба</a><li>
                <li><a rel="nofollow" href="http://imdagger.github.io/category/join.html" class="h-link">клубы</a><li>
                <li><a rel="nofollow" href="http://imdagger.github.io/category/link.html" class="h-link">ссылки</a><li>
                <li><a rel="nofollow" href="http://imdagger.github.io/category/mood.html" class="h-link">настроение</a><li>
                <li><a rel="nofollow" href="http://imdagger.github.io/category/photo.html" class="h-link">фото</a><li>
                <li><a rel="nofollow" href="http://imdagger.github.io/category/text.html" class="h-link">текст</a><li>
                <li><a rel="nofollow" href="http://imdagger.github.io/category/video.html" class="h-link">видео</a><li>
                <li><a rel="nofollow" href="http://imdagger.github.io/category/wishlist.html" class="h-link"></a><li>
            </ul>
        </div>
    </span>
</div>
    <div class="row b-post">
<div class="panel panel-text">
    <div class="panel-heading b-post-type b-post-type-text">
        <b class="b-user">
            <a class="b-user__link" href="http://imdagger.github.io/author/imdagger.html"><b class="b-user__first-letter">I</b>MDagger</a>
        </b>
написал        <span class="pull-right b-date">
            <a class="h-link" href="http://imdagger.github.io/posts/2014/02/20/urn:ya.ru:post/22199227/1935/" >
                20 февраля, 01:45
            </a>
        </span>
    </div>
    <div class="panel-body">
        <div class="col-sm-1 b-post__layout-left">
            <a href="http://imdagger.github.io/author/imdagger.html"><img src="http://upics.yandex.ru/22199227/middle"></a>
        </div>
        <div class="col-sm-11 b-right-col">
            <noindex>
<div class="row tags-row">
    <span class="tag"><a rel="nofollow" class="h-link" href="http://imdagger.github.io/tag/django.html">Django</a></span>,    <span class="tag"><a rel="nofollow" class="h-link" href="http://imdagger.github.io/tag/vidzhet.html">виджет</a></span>,    <span class="tag"><a rel="nofollow" class="h-link" href="http://imdagger.github.io/tag/pole.html">поле</a></span>,    <span class="tag"><a rel="nofollow" class="h-link" href="http://imdagger.github.io/tag/perekrytie.html">перекрытие</a></span>,    <span class="tag"><a rel="nofollow" class="h-link" href="http://imdagger.github.io/tag/peregruzka.html">перегрузка</a></span>,    <span class="tag"><a rel="nofollow" class="h-link" href="http://imdagger.github.io/tag/modelform.html">modelform</a></span>,    <span class="tag"><a rel="nofollow" class="h-link" href="http://imdagger.github.io/tag/forma.html">форма</a></span>,    <span class="tag"><a rel="nofollow" class="h-link" href="http://imdagger.github.io/tag/rabota.html">работа</a></span>,    <span class="tag"><a rel="nofollow" class="h-link" href="http://imdagger.github.io/tag/programmirovanie.html">программирование</a></span></div>
            </noindex>
            <div class="post-title">
<a class="no-link" href="http://imdagger.github.io/posts/2014/02/20/urn:ya.ru:post/22199227/1935/"></a>            </div>
            <div class="row post-body">
                <div class="b-text">
<p>Не нашёл я как в Django сделать так, чтобы в ModelForm можно было
уже <strong>ранее описанным</strong> полям изменять их widget, и всё из-за того, что
поля инстанцируются ещё в метаклассе, что вызывает проблемы — заново
туда не подсунуть widget, label и другие аргументы. Поэтому пришлось
построить небольшой свой велосипед с квадратными колёсами. В котором
поля, которые перекрывают другие и при этом нуждаются в гибкости (чтобы
в наследниках можно было легко заменить некритичные участки),
объявляются как <code class="code">
Meta.override _fields</code>
:</p>
<p>Он <a class="reference external" href="https://gist.github.com/IMDagger/9102834">доступен на GitGub</a>.</p>
<span class="cut"><a class="h-link reference internal" href="#cut_85626128"data-toggle="collapse">посмотреть мой велосипед</a></span><div class="collapse" id="cut_85626128">
<div class="highlight"><pre><span class="pgcss-c"># -*- coding: utf-8 -*-</span>
<span class="pgcss-kn">from</span> <span class="pgcss-nn">django</span> <span class="pgcss-kn">import</span> <span class="pgcss-n">forms</span>
<span class="pgcss-kn">from</span> <span class="pgcss-nn">django.forms</span> <span class="pgcss-kn">import</span> <span class="pgcss-n">widgets</span>

<span class="pgcss-k">class</span> <span class="pgcss-nc">ModelFormStyler</span><span class="pgcss-p">(</span><span class="pgcss-n">forms</span><span class="pgcss-o">.</span><span class="pgcss-n">ModelForm</span><span class="pgcss-o">.</span><span class="pgcss-n">__metaclass__</span><span class="pgcss-p">):</span>
    <span class="pgcss-sd">&#39;&#39;&#39;</span>
<span class="pgcss-sd">    Allows to write such kind of forms:</span>
<span class="pgcss-sd">    ...</span>
<span class="pgcss-sd">    class Some(ModelFormStyler):</span>
<span class="pgcss-sd">        class Meta:</span>
<span class="pgcss-sd">            model = ...</span>
<span class="pgcss-sd">            widgets = {</span>
<span class="pgcss-sd">                ...</span>
<span class="pgcss-sd">                &#39;field1&#39;: widgets.Textarea(attrs={&#39;rows&#39;: 5}),</span>
<span class="pgcss-sd">            },</span>
<span class="pgcss-sd">            override_fields = {</span>
<span class="pgcss-sd">                &#39;field1&#39;: (forms.CharField, dict(label=..., ...)),</span>
<span class="pgcss-sd">                &#39;field2&#39;: (MyCustomField, dict(widget=widgets.TextInput())),</span>
<span class="pgcss-sd">            }</span>
<span class="pgcss-sd">         ... methods here ...</span>

<span class="pgcss-sd">    class Some2(Some):</span>
<span class="pgcss-sd">        class Meta:</span>
<span class="pgcss-sd">            model = ...</span>
<span class="pgcss-sd">            widgets = {</span>
<span class="pgcss-sd">                ...</span>
<span class="pgcss-sd">                &#39;field1&#39;: widgets.Textarea(attrs={&#39;rows&#39;: 100500}),</span>
<span class="pgcss-sd">                &#39;field2&#39;: widgets.Textarea(attrs={&#39;rows&#39;: 100500}),</span>
<span class="pgcss-sd">            },</span>
<span class="pgcss-sd">            labels = {</span>
<span class="pgcss-sd">                &#39;field1&#39;: &#39;another label&#39;,</span>
<span class="pgcss-sd">            },</span>
<span class="pgcss-sd">            override_fields = {</span>
<span class="pgcss-sd">                &#39;field2&#39;: (MyCustomField2, {}),</span>
<span class="pgcss-sd">            }</span>
<span class="pgcss-sd">         ... methods here again ...</span>

<span class="pgcss-sd">    &#39;&#39;&#39;</span>

    <span class="pgcss-n">__sections</span> <span class="pgcss-o">=</span> <span class="pgcss-p">{</span>
        <span class="pgcss-s">&#39;widgets&#39;</span><span class="pgcss-p">:</span> <span class="pgcss-s">&#39;widget&#39;</span><span class="pgcss-p">,</span> <span class="pgcss-c"># section name -&gt; argument name</span>
        <span class="pgcss-s">&#39;labels&#39;</span><span class="pgcss-p">:</span> <span class="pgcss-s">&#39;label&#39;</span><span class="pgcss-p">,</span>
    <span class="pgcss-p">}</span>

    <span class="pgcss-k">def</span> <span class="pgcss-nf">__new__</span><span class="pgcss-p">(</span><span class="pgcss-n">cls</span><span class="pgcss-p">,</span> <span class="pgcss-n">name</span><span class="pgcss-p">,</span> <span class="pgcss-n">bases</span><span class="pgcss-p">,</span> <span class="pgcss-n">attrs</span><span class="pgcss-p">):</span>
        <span class="pgcss-n">super_new</span> <span class="pgcss-o">=</span> <span class="pgcss-nb">super</span><span class="pgcss-p">(</span><span class="pgcss-n">ModelFormStyler</span><span class="pgcss-p">,</span> <span class="pgcss-n">cls</span><span class="pgcss-p">)</span><span class="pgcss-o">.</span><span class="pgcss-n">__new__</span>

        <span class="pgcss-n">cls</span><span class="pgcss-o">.</span><span class="pgcss-n">_override_custom_widgets</span><span class="pgcss-p">(</span><span class="pgcss-n">bases</span><span class="pgcss-p">,</span> <span class="pgcss-n">attrs</span><span class="pgcss-p">)</span>
        <span class="pgcss-n">new_class</span> <span class="pgcss-o">=</span> <span class="pgcss-n">super_new</span><span class="pgcss-p">(</span><span class="pgcss-n">cls</span><span class="pgcss-p">,</span> <span class="pgcss-n">name</span><span class="pgcss-p">,</span> <span class="pgcss-n">bases</span><span class="pgcss-p">,</span> <span class="pgcss-n">attrs</span><span class="pgcss-p">)</span>
        <span class="pgcss-k">return</span> <span class="pgcss-n">new_class</span>

    <span class="pgcss-nd">@classmethod</span>
    <span class="pgcss-k">def</span> <span class="pgcss-nf">__replacement_for</span><span class="pgcss-p">(</span><span class="pgcss-n">cls</span><span class="pgcss-p">,</span> <span class="pgcss-n">attrs</span><span class="pgcss-p">,</span> <span class="pgcss-n">bases</span><span class="pgcss-p">,</span> <span class="pgcss-n">fname</span><span class="pgcss-p">,</span> <span class="pgcss-n">opt_name</span><span class="pgcss-p">):</span>
        <span class="pgcss-k">try</span><span class="pgcss-p">:</span>
            <span class="pgcss-c"># .widgets, .labels and etc</span>
            <span class="pgcss-k">return</span> <span class="pgcss-nb">getattr</span><span class="pgcss-p">(</span><span class="pgcss-n">attrs</span><span class="pgcss-p">[</span><span class="pgcss-s">&#39;Meta&#39;</span><span class="pgcss-p">],</span> <span class="pgcss-n">opt_name</span><span class="pgcss-p">)[</span><span class="pgcss-n">fname</span><span class="pgcss-p">]</span>
        <span class="pgcss-k">except</span><span class="pgcss-p">:</span>
            <span class="pgcss-k">pass</span>
        <span class="pgcss-k">for</span> <span class="pgcss-n">base</span> <span class="pgcss-ow">in</span> <span class="pgcss-n">bases</span><span class="pgcss-p">:</span>
            <span class="pgcss-k">try</span><span class="pgcss-p">:</span>
                <span class="pgcss-k">return</span> <span class="pgcss-nb">getattr</span><span class="pgcss-p">(</span><span class="pgcss-n">base</span><span class="pgcss-o">.</span><span class="pgcss-n">Meta</span><span class="pgcss-p">,</span> <span class="pgcss-n">opt_name</span><span class="pgcss-p">)[</span><span class="pgcss-n">fname</span><span class="pgcss-p">]</span>
            <span class="pgcss-k">except</span><span class="pgcss-p">:</span>
                <span class="pgcss-k">pass</span>

    <span class="pgcss-nd">@classmethod</span>
    <span class="pgcss-k">def</span> <span class="pgcss-nf">__field_descr_for</span><span class="pgcss-p">(</span><span class="pgcss-n">cls</span><span class="pgcss-p">,</span> <span class="pgcss-n">attrs</span><span class="pgcss-p">,</span> <span class="pgcss-n">bases</span><span class="pgcss-p">,</span> <span class="pgcss-n">fname</span><span class="pgcss-p">):</span>
        <span class="pgcss-k">return</span> <span class="pgcss-n">cls</span><span class="pgcss-o">.</span><span class="pgcss-n">__replacement_for</span><span class="pgcss-p">(</span><span class="pgcss-n">cls</span><span class="pgcss-p">,</span> <span class="pgcss-n">attrs</span><span class="pgcss-p">,</span> <span class="pgcss-n">bases</span><span class="pgcss-p">,</span> <span class="pgcss-n">fname</span><span class="pgcss-p">,</span> <span class="pgcss-s">&#39;field_overrides&#39;</span><span class="pgcss-p">)</span>

    <span class="pgcss-nd">@classmethod</span>
    <span class="pgcss-k">def</span> <span class="pgcss-nf">_override_custom_widgets</span><span class="pgcss-p">(</span><span class="pgcss-n">cls</span><span class="pgcss-p">,</span> <span class="pgcss-n">bases</span><span class="pgcss-p">,</span> <span class="pgcss-n">attrs</span><span class="pgcss-p">):</span>
        <span class="pgcss-k">if</span> <span class="pgcss-s">&#39;Meta&#39;</span> <span class="pgcss-ow">in</span> <span class="pgcss-n">attrs</span><span class="pgcss-p">:</span>
            <span class="pgcss-n">entire_dirty</span> <span class="pgcss-o">=</span> <span class="pgcss-nb">set</span><span class="pgcss-p">()</span>
            <span class="pgcss-k">for</span> <span class="pgcss-n">section</span> <span class="pgcss-ow">in</span> <span class="pgcss-p">[</span><span class="pgcss-s">&#39;field_overrides&#39;</span><span class="pgcss-p">,]</span> <span class="pgcss-o">+</span> <span class="pgcss-n">cls</span><span class="pgcss-o">.</span><span class="pgcss-n">__sections</span><span class="pgcss-o">.</span><span class="pgcss-n">keys</span><span class="pgcss-p">():</span>
                <span class="pgcss-c"># .field_overrides together with .widgets, .labels</span>
                <span class="pgcss-n">dirty</span> <span class="pgcss-o">=</span> <span class="pgcss-nb">getattr</span><span class="pgcss-p">(</span><span class="pgcss-n">attrs</span><span class="pgcss-p">[</span><span class="pgcss-s">&#39;Meta&#39;</span><span class="pgcss-p">],</span> <span class="pgcss-n">section</span><span class="pgcss-p">,</span> <span class="pgcss-p">{})</span>
                <span class="pgcss-n">entire_dirty</span><span class="pgcss-o">.</span><span class="pgcss-n">update</span><span class="pgcss-p">(</span><span class="pgcss-n">dirty</span><span class="pgcss-o">.</span><span class="pgcss-n">iterkeys</span><span class="pgcss-p">())</span>

            <span class="pgcss-n">dirty_fields</span> <span class="pgcss-o">=</span> <span class="pgcss-p">[]</span>
            <span class="pgcss-c"># it&#39;s now without duplicates</span>
            <span class="pgcss-k">for</span> <span class="pgcss-n">fname</span> <span class="pgcss-ow">in</span> <span class="pgcss-n">entire_dirty</span><span class="pgcss-p">:</span>
                <span class="pgcss-n">descr</span> <span class="pgcss-o">=</span> <span class="pgcss-n">cls</span><span class="pgcss-o">.</span><span class="pgcss-n">__field_descr_for</span><span class="pgcss-p">(</span><span class="pgcss-n">attrs</span><span class="pgcss-p">,</span> <span class="pgcss-n">bases</span><span class="pgcss-p">,</span> <span class="pgcss-n">fname</span><span class="pgcss-p">)</span>
                <span class="pgcss-k">if</span> <span class="pgcss-n">descr</span> <span class="pgcss-ow">is</span> <span class="pgcss-ow">not</span> <span class="pgcss-bp">None</span><span class="pgcss-p">:</span>
                    <span class="pgcss-n">dirty_fields</span><span class="pgcss-o">.</span><span class="pgcss-n">append</span><span class="pgcss-p">((</span><span class="pgcss-n">fname</span><span class="pgcss-p">,</span> <span class="pgcss-n">descr</span><span class="pgcss-p">))</span>

            <span class="pgcss-c"># create fields for all dirty descriptors (local and parent)</span>
            <span class="pgcss-k">for</span> <span class="pgcss-n">fname</span><span class="pgcss-p">,</span> <span class="pgcss-p">(</span><span class="pgcss-n">ftype</span><span class="pgcss-p">,</span> <span class="pgcss-n">kwargs</span><span class="pgcss-p">)</span> <span class="pgcss-ow">in</span> <span class="pgcss-n">dirty_fields</span><span class="pgcss-p">:</span>
                <span class="pgcss-n">options</span> <span class="pgcss-o">=</span> <span class="pgcss-nb">dict</span><span class="pgcss-p">(</span><span class="pgcss-n">kwargs</span><span class="pgcss-p">)</span>
                <span class="pgcss-c"># process</span>
                <span class="pgcss-k">for</span> <span class="pgcss-n">section</span><span class="pgcss-p">,</span> <span class="pgcss-n">arg_name</span> <span class="pgcss-ow">in</span> <span class="pgcss-n">cls</span><span class="pgcss-o">.</span><span class="pgcss-n">__sections</span><span class="pgcss-o">.</span><span class="pgcss-n">iteritems</span><span class="pgcss-p">():</span>
                    <span class="pgcss-n">arg_value</span> <span class="pgcss-o">=</span> <span class="pgcss-n">cls</span><span class="pgcss-o">.</span><span class="pgcss-n">__replacement_for</span><span class="pgcss-p">(</span><span class="pgcss-n">attrs</span><span class="pgcss-p">,</span> <span class="pgcss-n">bases</span><span class="pgcss-p">,</span> <span class="pgcss-n">fname</span><span class="pgcss-p">,</span> <span class="pgcss-n">section</span><span class="pgcss-p">)</span>
                    <span class="pgcss-k">if</span> <span class="pgcss-n">arg_value</span> <span class="pgcss-ow">is</span> <span class="pgcss-ow">not</span> <span class="pgcss-bp">None</span><span class="pgcss-p">:</span>
                        <span class="pgcss-n">options</span><span class="pgcss-p">[</span><span class="pgcss-n">arg_name</span><span class="pgcss-p">]</span> <span class="pgcss-o">=</span> <span class="pgcss-n">arg_value</span>
                <span class="pgcss-n">attrs</span><span class="pgcss-p">[</span><span class="pgcss-n">fname</span><span class="pgcss-p">]</span> <span class="pgcss-o">=</span> <span class="pgcss-n">ftype</span><span class="pgcss-p">(</span><span class="pgcss-o">**</span><span class="pgcss-n">options</span><span class="pgcss-p">)</span>

<span class="pgcss-k">class</span> <span class="pgcss-nc">ControlModelForm</span><span class="pgcss-p">(</span><span class="pgcss-n">forms</span><span class="pgcss-o">.</span><span class="pgcss-n">ModelForm</span><span class="pgcss-p">):</span>
    <span class="pgcss-n">__metaclass__</span> <span class="pgcss-o">=</span> <span class="pgcss-n">ModelFormStyler</span>
</pre></div>
</div>
                </div>
            </div>
            <div class="row comments-row">
                <span><a class="pseudo-link b-candy b-comment-shortcut"><i class="b-ico"></i>ответить</a></span>
            </div>
        </div>
    </div>
</div><div class="panel panel-text">
    <div class="panel-heading b-post-type b-post-type-text">
        <b class="b-user">
            <a class="b-user__link" href="http://imdagger.github.io/author/imdagger.html"><b class="b-user__first-letter">I</b>MDagger</a>
        </b>
написал        <span class="pull-right b-date">
            <a class="h-link" href="http://imdagger.github.io/posts/2014/02/13/problema-s-udaleniem-mnozhestva-obektov-v-polymorphic/" >
                13 февраля, 23:56
            </a>
        </span>
    </div>
    <div class="panel-body">
        <div class="col-sm-1 b-post__layout-left">
            <a href="http://imdagger.github.io/author/imdagger.html"><img src="http://upics.yandex.ru/22199227/middle"></a>
        </div>
        <div class="col-sm-11 b-right-col">
            <noindex>
<div class="row tags-row">
    <span class="tag"><a rel="nofollow" class="h-link" href="http://imdagger.github.io/tag/oshibka.html">ошибка</a></span>,    <span class="tag"><a rel="nofollow" class="h-link" href="http://imdagger.github.io/tag/django-polymorphic.html">django-polymorphic</a></span>,    <span class="tag"><a rel="nofollow" class="h-link" href="http://imdagger.github.io/tag/programmirovanie.html">программирование</a></span>,    <span class="tag"><a rel="nofollow" class="h-link" href="http://imdagger.github.io/tag/django.html">Django</a></span>,    <span class="tag"><a rel="nofollow" class="h-link" href="http://imdagger.github.io/tag/zapros.html">запрос</a></span>,    <span class="tag"><a rel="nofollow" class="h-link" href="http://imdagger.github.io/tag/udalenie.html">удаление</a></span>,    <span class="tag"><a rel="nofollow" class="h-link" href="http://imdagger.github.io/tag/rabota.html">работа</a></span>,    <span class="tag"><a rel="nofollow" class="h-link" href="http://imdagger.github.io/tag/administrirovanie.html">администрирование</a></span></div>
            </noindex>
            <div class="post-title">
<a class="no-link" href="http://imdagger.github.io/posts/2014/02/13/problema-s-udaleniem-mnozhestva-obektov-v-polymorphic/">Проблема с удалением множества объектов в polymorphic</a>            </div>
            <div class="row post-body">
                <div class="b-text">
<p>&nbsp;&nbsp;&nbsp; Если есть некоторый класс A и в нём поле b, которое может описывать
множество объектов класса C, у которого есть потомки D и E, то при
попытке удалить все эти объекты разом может возникнуть проблема (у меня
возникает в админке). И суть ещё заключается в том, что в Django при
сборе всех зависимых объектов <a class="reference external" href="https://github.com/django/django/blob/stable/1.6.x/django/db/models/deletion.py#L170">берут первый из
списка</a>,
его класс и остальные обрабатывают из расчёта на его поля, хотя в этом
множестве могут быть немного другие по поведению объекты. Придётся
какой-то обходной путь строить, иначе не получается удалять в админке
пользователей, т.к. те у меня тащат за собой созданные ими документы,
которые имеют небольшие различия, что сразу отправляет обработчик
запроса в 502.</p>
                </div>
            </div>
            <div class="row comments-row">
                <span><a class="pseudo-link b-candy b-comment-shortcut"><i class="b-ico"></i>ответить</a></span>
            </div>
        </div>
    </div>
</div><div class="panel panel-text">
    <div class="panel-heading b-post-type b-post-type-text">
        <b class="b-user">
            <a class="b-user__link" href="http://imdagger.github.io/author/imdagger.html"><b class="b-user__first-letter">I</b>MDagger</a>
        </b>
написал        <span class="pull-right b-date">
            <a class="h-link" href="http://imdagger.github.io/posts/2013/03/29/bag-v-spyne/" >
                29 марта 2013 года, 03:23
            </a>
        </span>
    </div>
    <div class="panel-body">
        <div class="col-sm-1 b-post__layout-left">
            <a href="http://imdagger.github.io/author/imdagger.html"><img src="http://upics.yandex.ru/22199227/middle"></a>
        </div>
        <div class="col-sm-11 b-right-col">
            <noindex>
<div class="row tags-row">
    <span class="tag"><a rel="nofollow" class="h-link" href="http://imdagger.github.io/tag/python.html">python</a></span>,    <span class="tag"><a rel="nofollow" class="h-link" href="http://imdagger.github.io/tag/spyne.html">spyne</a></span>,    <span class="tag"><a rel="nofollow" class="h-link" href="http://imdagger.github.io/tag/json.html">JSON</a></span>,    <span class="tag"><a rel="nofollow" class="h-link" href="http://imdagger.github.io/tag/rabota.html">работа</a></span>,    <span class="tag"><a rel="nofollow" class="h-link" href="http://imdagger.github.io/tag/oshibka.html">ошибка</a></span></div>
            </noindex>
            <div class="post-title">
<a class="no-link" href="http://imdagger.github.io/posts/2013/03/29/bag-v-spyne/">Баг в Spyne</a>            </div>
            <div class="row post-body">
                <div class="b-text">
<p>Нашёл неприятную ошибку в последней версии
<a class="reference external" href="https://github.com/arskom/spyne">spyne</a>, из-за которой все протоколы
опирающиеся на HierDictDocument класс, а это: JSON, YAML, MessagePack
неправильно трактуют как десериализовать результат выполнения функции,
если использовать внутренний клиентский модуль из пакета spryne:</p>
<div class="highlight"><pre><span class="pgcss-kn">import</span> <span class="pgcss-nn">spyne.client.http</span>
<span class="pgcss-kn">from</span> <span class="pgcss-nn">services</span> <span class="pgcss-kn">import</span> <span class="pgcss-n">main</span>
<span class="pgcss-n">x</span> <span class="pgcss-o">=</span> <span class="pgcss-n">spyne</span><span class="pgcss-o">.</span><span class="pgcss-n">client</span><span class="pgcss-o">.</span><span class="pgcss-n">http</span><span class="pgcss-o">.</span><span class="pgcss-n">HttpClient</span><span class="pgcss-p">(</span><span class="pgcss-s">&#39;http://localhost:7789&#39;</span><span class="pgcss-p">,</span> <span class="pgcss-n">main</span><span class="pgcss-o">.</span><span class="pgcss-n">server</span><span class="pgcss-p">)</span>
<span class="pgcss-k">print</span> <span class="pgcss-n">x</span><span class="pgcss-o">.</span><span class="pgcss-n">service</span><span class="pgcss-o">.</span><span class="pgcss-n">say_hello</span><span class="pgcss-p">(</span><span class="pgcss-s">&#39;Word&#39;</span><span class="pgcss-p">,</span> <span class="pgcss-mi">5</span><span class="pgcss-p">)</span>

<span class="pgcss-c"># ...</span>
<span class="pgcss-c"># где main.server это объект приложения с описанием сервисов:</span>

<span class="pgcss-n">server</span> <span class="pgcss-o">=</span> <span class="pgcss-n">Application</span><span class="pgcss-p">([</span><span class="pgcss-n">HelloServiceClass</span><span class="pgcss-p">],</span>
    <span class="pgcss-n">tns</span><span class="pgcss-o">=</span><span class="pgcss-s">&#39;example.hello&#39;</span><span class="pgcss-p">,</span>
    <span class="pgcss-n">in_protocol</span><span class="pgcss-o">=</span><span class="pgcss-n">JSONDocument</span><span class="pgcss-p">(</span><span class="pgcss-n">validator</span><span class="pgcss-o">=</span><span class="pgcss-s">&#39;soft&#39;</span><span class="pgcss-p">),</span>
    <span class="pgcss-n">out_protocol</span><span class="pgcss-o">=</span><span class="pgcss-n">JSONDocument</span><span class="pgcss-p">()</span>
<span class="pgcss-p">)</span>
</pre></div>
<p>В случае JSON print выведет просто None, хотя должен был вывести
объект генератора. А всё потому, что библиотека пробует десериализовать
свой собственный ответ тем же способом, что и входящие сообщения
разбирает, а это не совсем корректно или там не дописан код. А вот
протокол XMLDocument опирается на другой класс и не имеет такой
проблемы. Поэтому пока буду использовать его, а позже попробую исправить
ошибки библиотеки.</p>
                </div>
            </div>
            <div class="row comments-row">
                <span><a class="pseudo-link b-candy b-comment-shortcut"><i class="b-ico"></i>ответить</a></span>
            </div>
        </div>
    </div>
</div><div class="panel panel-text">
    <div class="panel-heading b-post-type b-post-type-text">
        <b class="b-user">
            <a class="b-user__link" href="http://imdagger.github.io/author/imdagger.html"><b class="b-user__first-letter">I</b>MDagger</a>
        </b>
написал        <span class="pull-right b-date">
            <a class="h-link" href="http://imdagger.github.io/posts/2012/09/24/jinja2/" >
                24 сентября 2012 года, 14:43
            </a>
        </span>
    </div>
    <div class="panel-body">
        <div class="col-sm-1 b-post__layout-left">
            <a href="http://imdagger.github.io/author/imdagger.html"><img src="http://upics.yandex.ru/22199227/middle"></a>
        </div>
        <div class="col-sm-11 b-right-col">
            <noindex>
<div class="row tags-row">
    <span class="tag"><a rel="nofollow" class="h-link" href="http://imdagger.github.io/tag/shablon.html">шаблон</a></span>,    <span class="tag"><a rel="nofollow" class="h-link" href="http://imdagger.github.io/tag/jinja2.html">Jinja2</a></span>,    <span class="tag"><a rel="nofollow" class="h-link" href="http://imdagger.github.io/tag/programmirovanie.html">программирование</a></span>,    <span class="tag"><a rel="nofollow" class="h-link" href="http://imdagger.github.io/tag/cheetah.html">Cheetah</a></span>,    <span class="tag"><a rel="nofollow" class="h-link" href="http://imdagger.github.io/tag/rabota.html">работа</a></span></div>
            </noindex>
            <div class="post-title">
<a class="no-link" href="http://imdagger.github.io/posts/2012/09/24/jinja2/">Jinja2</a>            </div>
            <div class="row post-body">
                <div class="b-text">
<p>Сел вчера и за полдня переделал в проекте все шаблоны и подсистему,
которая вызывает шаблонизатор, а также инфраструктуру по компиляции и
деплоингу под Jinja2 (вот как-то так: <em>109 files changed, 934
insertions(+), 1373 deletions(-)</em>). А до этого было Cheetah. Во-первых
стало компилироваться намного быстрее, во-вторых есть множество разных
вариантов загрузки и компиляции шаблонов. Я выбрал складывать всё в один
zip-архив без сжатия. Так же радует автоматическая загрузка шаблонов (в
случае модификации), поддержка <code class="code">
{{ super() }}</code>
, наличие макросов с
возможностью обращения к вызывающему контексту. Достаточное количество
фильтров и лёгкость написания своих. В общем очень доволен выбором и
синтаксисом Jinja2 (а также тем, что его легко можно настраивать),
особенно из-за решения нетривиальных проблем с наследованием для
Cheetah.</p>
<p>Жалко только, что поздно вчера взялся за дело, только около 16:00,
поэтому лёг ночью и поспал всего 3 часа. Но будильник меня разбудил в
нормальном состоянии, я не оказался сильно сонным (помогает то, что он
даёт мне подремать 10 минут).</p>
                </div>
            </div>
            <div class="row comments-row">
                <span><a class="pseudo-link b-candy b-comment-shortcut"><i class="b-ico"></i>ответить</a></span>
            </div>
        </div>
    </div>
</div><div class="panel panel-text">
    <div class="panel-heading b-post-type b-post-type-text">
        <b class="b-user">
            <a class="b-user__link" href="http://imdagger.github.io/author/imdagger.html"><b class="b-user__first-letter">I</b>MDagger</a>
        </b>
написал        <span class="pull-right b-date">
            <a class="h-link" href="http://imdagger.github.io/posts/2012/04/22/flash-socket-blokirovalsia-antivirusami/" >
                22 апреля 2012 года, 10:02
            </a>
        </span>
    </div>
    <div class="panel-body">
        <div class="col-sm-1 b-post__layout-left">
            <a href="http://imdagger.github.io/author/imdagger.html"><img src="http://upics.yandex.ru/22199227/middle"></a>
        </div>
        <div class="col-sm-11 b-right-col">
            <noindex>
<div class="row tags-row">
    <span class="tag"><a rel="nofollow" class="h-link" href="http://imdagger.github.io/tag/antivirus.html">антивирус</a></span>,    <span class="tag"><a rel="nofollow" class="h-link" href="http://imdagger.github.io/tag/flash.html">flash</a></span>,    <span class="tag"><a rel="nofollow" class="h-link" href="http://imdagger.github.io/tag/programmirovanie.html">программирование</a></span>,    <span class="tag"><a rel="nofollow" class="h-link" href="http://imdagger.github.io/tag/soket.html">сокет</a></span>,    <span class="tag"><a rel="nofollow" class="h-link" href="http://imdagger.github.io/tag/rabota.html">работа</a></span></div>
            </noindex>
            <div class="post-title">
<a class="no-link" href="http://imdagger.github.io/posts/2012/04/22/flash-socket-blokirovalsia-antivirusami/">Flash socket блокировался антивирусами</a>            </div>
            <div class="row post-body">
                <div class="b-text">
<p>&nbsp;&nbsp;&nbsp; Неожиданная проблема с тем, что у некоторых игроков не отображались
обновления, разрешилась. Сузив круг виновных приложений и платформ,
выяснилось, что это антивирус. При чём Kaspersky и Avast себя вели
достаточно одинаково — блокировали запрос из Flash без каки-либо
собщений пользователю и отметов в журнале событий. Такое молчаливое
поведение достаточно странно. Но после продолжительных поисков
выяснилось, что достаточно сменить порт для соединения с 80-го. В nginx
было выставлено дополнительно слушать 81-ый порт. После этого проблема с
Flash и его socket соединением решилась.</p>
                </div>
            </div>
            <div class="row comments-row">
                <span><a class="pseudo-link b-candy b-comment-shortcut"><i class="b-ico"></i>ответить</a></span>
            </div>
        </div>
    </div>
</div><div class="panel panel-text">
    <div class="panel-heading b-post-type b-post-type-text">
        <b class="b-user">
            <a class="b-user__link" href="http://imdagger.github.io/author/imdagger.html"><b class="b-user__first-letter">I</b>MDagger</a>
        </b>
написал        <span class="pull-right b-date">
            <a class="h-link" href="http://imdagger.github.io/posts/2012/03/31/eksperiment-proshiol-uspeshno/" >
                31 марта 2012 года, 02:43
            </a>
        </span>
    </div>
    <div class="panel-body">
        <div class="col-sm-1 b-post__layout-left">
            <a href="http://imdagger.github.io/author/imdagger.html"><img src="http://upics.yandex.ru/22199227/middle"></a>
        </div>
        <div class="col-sm-11 b-right-col">
            <noindex>
<div class="row tags-row">
    <span class="tag"><a rel="nofollow" class="h-link" href="http://imdagger.github.io/tag/programmirovanie.html">программирование</a></span>,    <span class="tag"><a rel="nofollow" class="h-link" href="http://imdagger.github.io/tag/radost.html">радость</a></span>,    <span class="tag"><a rel="nofollow" class="h-link" href="http://imdagger.github.io/tag/http.html">HTTP</a></span>,    <span class="tag"><a rel="nofollow" class="h-link" href="http://imdagger.github.io/tag/python.html">python</a></span>,    <span class="tag"><a rel="nofollow" class="h-link" href="http://imdagger.github.io/tag/serializatsiia.html">сериализация</a></span>,    <span class="tag"><a rel="nofollow" class="h-link" href="http://imdagger.github.io/tag/pyamf.html">pyamf</a></span>,    <span class="tag"><a rel="nofollow" class="h-link" href="http://imdagger.github.io/tag/flash.html">flash</a></span>,    <span class="tag"><a rel="nofollow" class="h-link" href="http://imdagger.github.io/tag/rabota.html">работа</a></span>,    <span class="tag"><a rel="nofollow" class="h-link" href="http://imdagger.github.io/tag/flex.html">flex</a></span></div>
            </noindex>
            <div class="post-title">
<a class="no-link" href="http://imdagger.github.io/posts/2012/03/31/eksperiment-proshiol-uspeshno/">Эксперимент прошёл успешно</a>            </div>
            <div class="row post-body">
                <div class="b-text">
<p>&nbsp;&nbsp;&nbsp; Очень большой поток сообщений через chunked канал мы не проверяли,
но всё работает отлично. События передаются, только, т.к. Flash часть
без Flex, то нужно чтобы списки не передавались как
flex.messaging.io.ArrayCollection, т.к. они только во Flex есть. Поэтому
нужно, чтобы <strong>pyamf.amf3.use_proxies_default</strong> был равен <strong>False</strong>.
Так же стоит выставить заголовки, чтобы промежуточные прокси-сервера,
если таковые имеются не изменяли содержимое и не кэшировали его, т.к.
это всё таки события из игровой системы. И не очень бы хотелось, чтобы
игрок вошёл в игру и случилось дежавю.</p>
<blockquote>
…
Cache-Control: no-cache, no-transform
…</blockquote>
<p>&nbsp;&nbsp;&nbsp; Ещё забавно, когда из браузера обращается к обработчику, то
начинается скачиванием бинарного файла с AMF-объектами, и он может
скачиваться бесконечно.</p>
                </div>
            </div>
            <div class="row comments-row">
                <span><a class="pseudo-link b-candy b-comment-shortcut"><i class="b-ico"></i>ответить</a></span>
            </div>
        </div>
    </div>
</div><div class="panel panel-text">
    <div class="panel-heading b-post-type b-post-type-text">
        <b class="b-user">
            <a class="b-user__link" href="http://imdagger.github.io/author/imdagger.html"><b class="b-user__first-letter">I</b>MDagger</a>
        </b>
написал        <span class="pull-right b-date">
            <a class="h-link" href="http://imdagger.github.io/posts/2012/03/30/soedinenie-flash-python-amf-i-drugie-tovarishchi/" title="изменено 30 марта 2012 года в 00:26">
                30 марта 2012 года, 00:25
            </a>
        </span>
    </div>
    <div class="panel-body">
        <div class="col-sm-1 b-post__layout-left">
            <a href="http://imdagger.github.io/author/imdagger.html"><img src="http://upics.yandex.ru/22199227/middle"></a>
        </div>
        <div class="col-sm-11 b-right-col">
            <noindex>
<div class="row tags-row">
    <span class="tag"><a rel="nofollow" class="h-link" href="http://imdagger.github.io/tag/http.html">HTTP</a></span>,    <span class="tag"><a rel="nofollow" class="h-link" href="http://imdagger.github.io/tag/python.html">python</a></span>,    <span class="tag"><a rel="nofollow" class="h-link" href="http://imdagger.github.io/tag/flash.html">flash</a></span>,    <span class="tag"><a rel="nofollow" class="h-link" href="http://imdagger.github.io/tag/rabota.html">работа</a></span>,    <span class="tag"><a rel="nofollow" class="h-link" href="http://imdagger.github.io/tag/chunked.html">chunked</a></span>,    <span class="tag"><a rel="nofollow" class="h-link" href="http://imdagger.github.io/tag/wsgi.html">wsgi</a></span></div>
            </noindex>
            <div class="post-title">
<a class="no-link" href="http://imdagger.github.io/posts/2012/03/30/soedinenie-flash-python-amf-i-drugie-tovarishchi/">Соединение Flash &lt;-&gt; Python, AMF и другие товарищи</a>            </div>
            <div class="row post-body">
                <div class="b-text">
<p>&nbsp;&nbsp;&nbsp; Дабы не строить свой TCP-сервер и не разрабатывать свой протокол для
того, чтобы обмениваться с Flash в <strong>двустороннем порядке</strong> при помощи
AMF-пакетов, мы сошлись на варианте с двумя соединениями. Одно
соединение для получения событий из системы (1), а второй канал (2)
используется через NetConnection и создан для отправки call из Flash. Из
игры отправляется некоторый запрос по каналу (2), который является
HTTP-запросом, соединение удерживается и в рамках одного соединения
происходит много HTTP-запросов. Затем call обрабатывается на сервере и
происходят проверки корректности, событие заносится в очередь или
исполняется сразу же (в зависимости от необходимого времени для
события), ответ возвращается в AMF-формате обратно клиенту.</p>
<p>&nbsp;&nbsp;&nbsp; Затем в системе происходят события, и необходимо оповестить игрока
об этом. Обработчик обслуживающий (2) канал начинает отдавать события по
HTTP клиенту в режиме <em>Transfer-Encoding: chunked</em>, каждый пакет это
одно событие системы. Flash их обрабатывает и отображает игроку.</p>
<p>&nbsp;&nbsp;&nbsp; Такой подход позволил использовать стандартный pywsgi.WSGIHandler из
gevent, при этом получить быстрый канал оповещения с минимальными
накладными расходами. Chunked режим всего требует несколько байт для
отделения длины от пакета и немного символов для описания самой длины в
HEX. Требуется из Flash подключаться при помощи обычного сокета и
пересылать немного HTTP-заголовков для инициализации сессии. Посмотрим
насколько оправдает себя такой подход, чем то напоминает спутниковый
интернет.</p>
                </div>
            </div>
            <div class="row comments-row">
                <span><a class="pseudo-link b-candy b-comment-shortcut"><i class="b-ico"></i>ответить</a></span>
            </div>
        </div>
    </div>
</div><div class="panel panel-text">
    <div class="panel-heading b-post-type b-post-type-text">
        <b class="b-user">
            <a class="b-user__link" href="http://imdagger.github.io/author/imdagger.html"><b class="b-user__first-letter">I</b>MDagger</a>
        </b>
написал        <span class="pull-right b-date">
            <a class="h-link" href="http://imdagger.github.io/posts/2012/01/12/pppoe-i-byfly/" >
                12 января 2012 года, 23:24
            </a>
        </span>
    </div>
    <div class="panel-body">
        <div class="col-sm-1 b-post__layout-left">
            <a href="http://imdagger.github.io/author/imdagger.html"><img src="http://upics.yandex.ru/22199227/middle"></a>
        </div>
        <div class="col-sm-11 b-right-col">
            <noindex>
<div class="row tags-row">
    <span class="tag"><a rel="nofollow" class="h-link" href="http://imdagger.github.io/tag/oshibka.html">ошибка</a></span>,    <span class="tag"><a rel="nofollow" class="h-link" href="http://imdagger.github.io/tag/pppoe.html">PPPoE</a></span>,    <span class="tag"><a rel="nofollow" class="h-link" href="http://imdagger.github.io/tag/soedinenie.html">соединение</a></span>,    <span class="tag"><a rel="nofollow" class="h-link" href="http://imdagger.github.io/tag/avtorizatsiia.html">авторизация</a></span>,    <span class="tag"><a rel="nofollow" class="h-link" href="http://imdagger.github.io/tag/internet.html">интернет</a></span>,    <span class="tag"><a rel="nofollow" class="h-link" href="http://imdagger.github.io/tag/byfly.html">byfly</a></span>,    <span class="tag"><a rel="nofollow" class="h-link" href="http://imdagger.github.io/tag/plagin.html">плагин</a></span>,    <span class="tag"><a rel="nofollow" class="h-link" href="http://imdagger.github.io/tag/rabota.html">работа</a></span></div>
            </noindex>
            <div class="post-title">
<a class="no-link" href="http://imdagger.github.io/posts/2012/01/12/pppoe-i-byfly/">PPPoE и byfly</a>            </div>
            <div class="row post-body">
                <div class="b-text">
<p>&nbsp;&nbsp;&nbsp; При подключении через pppd со стороны byfly выдавалась ошибка
подключения с Access denied и что-то говорилось про неверный логин или
пароль. Множество раз перепроверив пароль и их логин, который
заканчивается на &#64;beltel.by, наши мозги утверждали, что всё правильно.
Звонок с запросом баланса и подключили ли они нам всё, дал положительный
ответ. Но сервер продолжал упорно отказываться подключиться, хотя с
модема удалось поднять соединение, но нас такой вариант не устраивал,
т.к. тогда сложнее балансировать каналы.</p>
<p>&nbsp;&nbsp;&nbsp; Рысканье по интернету давало много ответов, что нужно вписать для
byfly в конфигурационный файл pppd для данного подключения, но ничего не
помогало, только смущало, что у некоторых прописана строка на загрузку
модуля <strong>rp-pppoe.so</strong> Оказалось, что авторизация не проходит без
загрузки данного модуля, достаточно было использовать стандартные
настройки peers от pppd и добавить:</p>
<blockquote>
plugin rp-pppoe.so eth3 # eth3 — сетевая карта, куда подключён модем
к серверу в режиме bridge</blockquote>
<p>&nbsp;&nbsp;&nbsp; Эта строка всё решила.</p>
                </div>
            </div>
            <div class="row comments-row">
                <span><a class="pseudo-link b-candy b-comment-shortcut"><i class="b-ico"></i>ответить</a></span>
            </div>
        </div>
    </div>
</div><div class="panel panel-text">
    <div class="panel-heading b-post-type b-post-type-text">
        <b class="b-user">
            <a class="b-user__link" href="http://imdagger.github.io/author/imdagger.html"><b class="b-user__first-letter">I</b>MDagger</a>
        </b>
написал        <span class="pull-right b-date">
            <a class="h-link" href="http://imdagger.github.io/posts/2011/12/29/requirejs-moduli/" >
                29 декабря 2011 года, 03:55
            </a>
        </span>
    </div>
    <div class="panel-body">
        <div class="col-sm-1 b-post__layout-left">
            <a href="http://imdagger.github.io/author/imdagger.html"><img src="http://upics.yandex.ru/22199227/middle"></a>
        </div>
        <div class="col-sm-11 b-right-col">
            <noindex>
<div class="row tags-row">
    <span class="tag"><a rel="nofollow" class="h-link" href="http://imdagger.github.io/tag/zagruzka.html">загрузка</a></span>,    <span class="tag"><a rel="nofollow" class="h-link" href="http://imdagger.github.io/tag/oshibka.html">ошибка</a></span>,    <span class="tag"><a rel="nofollow" class="h-link" href="http://imdagger.github.io/tag/programmirovanie.html">программирование</a></span>,    <span class="tag"><a rel="nofollow" class="h-link" href="http://imdagger.github.io/tag/radost.html">радость</a></span>,    <span class="tag"><a rel="nofollow" class="h-link" href="http://imdagger.github.io/tag/javascript.html">javascript</a></span>,    <span class="tag"><a rel="nofollow" class="h-link" href="http://imdagger.github.io/tag/undefined.html">undefined</a></span>,    <span class="tag"><a rel="nofollow" class="h-link" href="http://imdagger.github.io/tag/modul.html">модуль</a></span>,    <span class="tag"><a rel="nofollow" class="h-link" href="http://imdagger.github.io/tag/requirejs.html">RequireJS</a></span>,    <span class="tag"><a rel="nofollow" class="h-link" href="http://imdagger.github.io/tag/zavisimost.html">зависимость</a></span>,    <span class="tag"><a rel="nofollow" class="h-link" href="http://imdagger.github.io/tag/rabota.html">работа</a></span></div>
            </noindex>
            <div class="post-title">
<a class="no-link" href="http://imdagger.github.io/posts/2011/12/29/requirejs-moduli/">RequireJS модули</a>            </div>
            <div class="row post-body">
                <div class="b-text">
<p>Мне нужно было подправить странную проблему в JavaScript коде,
структура которого была написана не мной. Сервер возвращает некоторый
готовый HTML, который принимает клиентская сторона и превращает в DOM.
Возвращаемая страница содержала несколько тегов <code class="code">
&lt;script&gt;</code>
, я создал
несколько js-файлов, при чём B нуждался в A, и был после них тег
<code class="code">
&lt;script&gt;</code>
 с прописанным кодом в шаблоне, где создавался экземпляр
прототипа из файла B.</p>
<p>И всё это счастье срабатывало на нажатие кнопки. Я обнаружил, что
кнопку приходится нажимать несколько раз. При чём странным образом
первый раз код выпадал с ошибкой и говорил, что не знает такой прототип
C и в помине (и что он undefined), хотя чуть выше был подключён
JavaScript-код для него.</p>
<p>Пару проб с <strong>alert</strong>-ами и выяснилось, что если этот участок кода
немного подождёт, то всё проходит из соринки и задоринки. Стало ясно,
что <code class="code">
&lt;script&gt;</code>
 элементы обходятся в произвольном порядке и по мере
загрузки. В тот момент, когда блок кода исполнялся, протопит C ещё
загружался с сервера. Пришлось искать решения.</p>
<p>И оно нашлось <a class="reference external" href="http://requirejs.org/">RequireJS</a>, что позволило
мне собрать части кода как модули и определить зависимости между ними. Я
не JavaScript разработчик, поэтому я раньше не особо задумывался, что в
JS есть такие проблемы и до этого не искал таких библиотек.</p>
<p>Но после того как я сделал модули меня ждал небольшой сюрприз
(документацию я смотрел невнимательно):</p>
<blockquote>
<div class="line-block">
<div class="line">// a/b/c</div>
<div class="line">define([], function() { … });</div>
<div class="line">// mod/user</div>
<div class="line">define([’a/b/c’, …], function (mod_a) {</div>
<div class="line">&nbsp; &nbsp; ....</div>
<div class="line">&nbsp; &nbsp; <strong>mod_a undefined, т.к. модуль ничего не экспортирует</strong></div>
<div class="line">});</div>
</div>
</blockquote>
<p>Я ничего не возвращал из данной функции, почему-то подразумевая, что
всё как-то само отправится в глобальную видимость, хотя сто раз прочёл в
доке про указание на анонимную функцию и т.д.</p>
<p>А затем час волосы на себе рвал пытаясь понять почему mod_a
переменная undefined и не содержит заветного модуля. Оказалось, что
функция возвращает словарь с данными, которые модуль экспортирует.</p>
<blockquote>
<div class="line-block">
<div class="line">// a/b/c</div>
<div class="line">define([], function() { … return {exported: MyMegaProto}; });</div>
<div class="line">// mod/user</div>
<div class="line">define([’a/b/c’, …], function (mod_a) {</div>
<div class="line">&nbsp; &nbsp; ...</div>
<div class="line">&nbsp; &nbsp; <strong>использовать mod_a.exported</strong></div>
<div class="line">&nbsp; &nbsp; ...</div>
<div class="line">&nbsp; &nbsp; return … // то что экспортируем</div>
<div class="line">});</div>
</div>
</blockquote>
                </div>
            </div>
            <div class="row comments-row">
                <span><a class="pseudo-link b-candy b-comment-shortcut"><i class="b-ico"></i>ответить</a></span>
            </div>
        </div>
    </div>
</div><div class="panel panel-text">
    <div class="panel-heading b-post-type b-post-type-text">
        <b class="b-user">
            <a class="b-user__link" href="http://imdagger.github.io/author/imdagger.html"><b class="b-user__first-letter">I</b>MDagger</a>
        </b>
написал        <span class="pull-right b-date">
            <a class="h-link" href="http://imdagger.github.io/posts/2011/12/22/novogodnii-korporativ-epic-fail-2/" >
                22 декабря 2011 года, 23:43
            </a>
        </span>
    </div>
    <div class="panel-body">
        <div class="col-sm-1 b-post__layout-left">
            <a href="http://imdagger.github.io/author/imdagger.html"><img src="http://upics.yandex.ru/22199227/middle"></a>
        </div>
        <div class="col-sm-11 b-right-col">
            <noindex>
<div class="row tags-row">
    <span class="tag"><a rel="nofollow" class="h-link" href="http://imdagger.github.io/tag/korporativ.html">корпоратив</a></span>,    <span class="tag"><a rel="nofollow" class="h-link" href="http://imdagger.github.io/tag/restoran.html">ресторан</a></span>,    <span class="tag"><a rel="nofollow" class="h-link" href="http://imdagger.github.io/tag/prazdnik.html">праздник</a></span>,    <span class="tag"><a rel="nofollow" class="h-link" href="http://imdagger.github.io/tag/ia.html">Я</a></span>,    <span class="tag"><a rel="nofollow" class="h-link" href="http://imdagger.github.io/tag/pechal.html">печаль</a></span>,    <span class="tag"><a rel="nofollow" class="h-link" href="http://imdagger.github.io/tag/rabota.html">работа</a></span></div>
            </noindex>
            <div class="post-title">
<a class="no-link" href="http://imdagger.github.io/posts/2011/12/22/novogodnii-korporativ-epic-fail-2/">Новогодний корпоратив — Epic Fail 2</a>            </div>
            <div class="row post-body">
                <div class="b-text">
<p>В этот раз вышло даже похуже, чем в прошлый раз, хоть и в ресторане
отмечали. Такое чувство было, что в зале прямо рядом со мной курят или
это специально такая система вентиляции: брать дым извне и затягивать в
зал? Ведущий тоже … в общем Терренс и Филлип отдыхают с их
фикально/анальными шутками, у этого были сексуально/фикально/анальные с
ответвлением в различные девиации. Участвовать в пошлых и странных
конкурсах я не хотел, еда мне не очень понравилась, поэтому я быстренько
ушёл и не жалею.</p>
                </div>
            </div>
            <div class="row comments-row">
                <span><a class="pseudo-link b-candy b-comment-shortcut"><i class="b-ico"></i>ответить</a></span>
            </div>
        </div>
    </div>
</div>        <div class="panel panel-default">
            <div class="panel-body more">
                <span class="more-next"><a class="h-link" href="http://imdagger.github.io/tag/rabota2.html">Ещё записи</a></span>
            </div>
        </div>
    </div>
</div>
        </div>
    </body>
</html>