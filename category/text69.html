<!DOCTYPE html>
<html lang="ru">
    <head>
        <meta charset="utf-8" />
        <title>IMDagger: Дневник</title>
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <meta name="description" content="Блог IMDagger: IT и жизнь" />
        <meta name="keywords" content="python,lisp,scheme,racket,emacs,blender,программирование,моделирование,lua,c++,c,js,java,git,bazaar" />
        <meta name="author" content="Alex Moiseenko (IMDagger)" />

<meta name="robots" content="noindex"/>
        <!-- Open Graph -->
        <link rel="stylesheet" href="http://maxcdn.bootstrapcdn.com/bootstrap/3.2.0/css/bootstrap.min.css" />
        <link rel="stylesheet" href="http://netdna.bootstrapcdn.com/font-awesome/4.0.3/css/font-awesome.min.css" />
        <link rel="shortcut icon" href="http://imdagger.github.io/favicon.ico" />
        <link rel="stylesheet" href="/theme/css/html4css1.css" />
        <link rel="stylesheet" href="/theme/css/style.css" />
        <link rel="stylesheet" href="/theme/css/pygment.css" />
        <link rel="stylesheet" href="/theme/css/math.css" />
        <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.11.1/jquery.min.js"></script>
        <script src="http://maxcdn.bootstrapcdn.com/bootstrap/3.2.0/js/bootstrap.min.js"></script>
        <script type="text/javascript" src="http://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS_HTML,http://imdagger.github.io/theme/js/math.js"></script>
        <script src="http://s3.amazonaws.com/nwapi/nwmatcher/nwmatcher-1.2.5-min.js"></script>
        <!--[if (gte IE 6)&(lte IE 8)]>
          <script type="text/javascript" src="/theme/js/selectivizr-min.js"></script>
          <noscript><link rel="stylesheet" href="[fallback css]" /></noscript>
        <![endif]-->

        <!-- HTML5 shim, for IE6-8 support of HTML5 elements -->
        <!--[if lt IE 9]>
        <script src="http://html5shim.googlecode.com/svn/trunk/html5.js"></script>
        <![endif]-->
        <link href="http://imdagger.github.io/feeds/all.atom.xml" type="application/atom+xml" rel="alternate" title="IMDagger Atom-лента" />
    </head>

    <body>
        <div class="row page-head">
            <div class="row page-head-status page-head-status-top"><div class="col-sm-12 b-status mine"><p><i></i><a href="#" title="настроение" class="b-consistent-link"><b>Продать кому-то что-то всегда на деле сложнее, чем кажется</b></a></p></div></div>
            <div class="col-sm-2 page-left">
                <a href="#">
                    <img src="http://upics.yandex.ru/22199227/normal" ilo-full-src="http://upics.yandex.ru/22199227/normal">
                </a>
            </div>
            <div class="col-sm-10 all-posts">
                <div class="title-container">
                    <h1><b><a href="http://imdagger.github.io" class="fn nickname">IMDagger</a></b></h1>
                </div>
                <div class="title-menu">
                    <ul class="nav nav-tabs" role="tablist">
                        <li class="active">
                            <a href="#">Дневник</a>
                        </li>
                        <li><a href="http://fotki.yandex.ru/users/imdagger">Фотки</a></li>
                        <li><a href="http://imdagger.github.io/pages/o-sebe.html">О себе</a></li>
                        <li><a href="http://imdagger.github.io/pages/rss-lenta.html">RSS-лента</a></li>
                    </ul>
                </div>
            </div>
        </div>
        <div class="row page-body">
<div class="col-sm-2 page-left">
<div class="row widget widget-photo">
    <a href="posts/2011/08/07/aga-popalsia/" class="b-user-photo__link"><img class="b-user-photo__img" src=" http://img-fotki.yandex.ru/get/5409/22199227.a/0_625fc_e780ccc7_L
?log_nocount=64720402854"></a>
</div><div class="row widget">
    <div class="widget-content b-user-info">
        <div class="widget__body">
            <div class="widget-user-info__age">
                <i class="widget-user-info__sex widget-user-info__sex_type_"></i> 26&nbsp;лет
            </div>
            <div class="widget-user-info__place">
                <a href="#">Гомель</a>,                <a href="#">Беларусь</a>            </div>
            <ul class="contacts">
                <li class="contact contact-type-email"><i></i><a href="mailto:imdagger@yandex.ru">imdagger@yandex.ru</a></li>
                <li class="contact contact-type-ya-online"><i></i>imdagger@ya.ru</li>
                <li class="contact contact-type-icq"><i></i>350395088</li>
            </ul>
        </div>
    </div>
</div>

<div class="row widget">
    <div class="widget-content">
        <div class="widget__title">
            <div class="widget__title-link">Метрика</div>
        </div>
        <div class="widget__body">
            <div class="widget-line">
              <!-- noindex -->
              <!-- googleoff: index -->
              <div class="widget-entry">
                <!-- Yandex.Metrika informer --><a href="https://metrika.yandex.ru/stat/?id=25746494&amp;from=informer" target="_blank" rel="nofollow"><img src="//bs.yandex.ru/informer/25746494/3_1_FFFFFFFF_EFEFEFFF_0_pageviews" style="width:88px; height:31px; border:0;" alt="Яндекс.Метрика" title="Яндекс.Метрика: данные за сегодня (просмотры, визиты и уникальные посетители)" onclick="try{Ya.Metrika.informer({i:this,id:25746494,lang:'ru'});return false}catch(e){}"/></a><!-- /Yandex.Metrika informer --><!-- Yandex.Metrika counter --><script type="text/javascript">(function (d, w, c) { (w[c] = w[c] || []).push(function() { try { w.yaCounter25746494 = new Ya.Metrika({id:25746494, clickmap:true, trackLinks:true, accurateTrackBounce:true}); } catch(e) { } }); var n = d.getElementsByTagName("script")[0], s = d.createElement("script"), f = function () { n.parentNode.insertBefore(s, n); }; s.type = "text/javascript"; s.async = true; s.src = (d.location.protocol == "https:" ? "https:" : "http:") + "//mc.yandex.ru/metrika/watch.js"; if (w.opera == "[object Opera]") { d.addEventListener("DOMContentLoaded", f, false); } else { f(); } })(document, window, "yandex_metrika_callbacks");</script><noscript><div><img src="//mc.yandex.ru/watch/25746494" style="position:absolute; left:-9999px;" alt="" /></div></noscript><!-- /Yandex.Metrika counter -->
                <!-- googleon: index -->
                <!-- /noindex -->
                </div>
            </div>
        </div>
    </div>
</div><div class="row widget">
    <div class="widget-content">
        <div class="widget__title">
            <div class="widget__title-link">Популярное в дневнике</div>
        </div>
        <div class="widget__body">
            <div class="widget-line">
                <div class="widget-entry">
                    <div class="widget-day__title">25&nbsp;июня</div>
                    <div class="widget-entry clearfix">
                        <div class="widget-entry__item">
                            <div class="widget-entry__title">
                                <a href="#" class="h-link">&nbsp;&nbsp;&nbsp; Висцеральная теория сна выглядит стр…</a>
                            </div>
                            <div class="widget-entry__info">2&nbsp;ответа</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div></div>

<div class="col-sm-10 all-posts">
<div class="row b-post-filter">
    <span class="pull-right">
        записи по
        <div class="btn-group">
            <span type="button" class="pseudo-link" data-toggle="dropdown">месяцам</span>
            <ul class="dropdown-menu dropdown-menu-right" role="menu">
                <li><a rel="nofollow" href="#" class="h-link">Нулябрь</a><li>
                <li><a rel="nofollow" href="#" class="h-link">Первябрь</a><li>
            </ul>
        </div> ·
        <div class="btn-group">
            <span type="button" class="pseudo-link" data-toggle="dropdown">меткам</span>
            <ul class="dropdown-menu dropdown-menu-right" role="menu">                <li>                    <a rel="nofollow" class="tag-1" href="http://imdagger.github.io/tag/oshibka.html" class="h-link">ошибка</a>                    <a rel="nofollow" class="tag-2" href="http://imdagger.github.io/tag/google.html" class="h-link">google</a>                    <a rel="nofollow" class="tag-1" href="http://imdagger.github.io/tag/nabrosok.html" class="h-link">набросок</a>                    <a rel="nofollow" class="tag-2" href="http://imdagger.github.io/tag/icfpc.html" class="h-link">icfpc</a>                    <a rel="nofollow" class="tag-2" href="http://imdagger.github.io/tag/java.html" class="h-link">java</a>                </li>                <li>                    <a rel="nofollow" class="tag-1" href="http://imdagger.github.io/tag/ia.html" class="h-link">Я</a>                    <a rel="nofollow" class="tag-2" href="http://imdagger.github.io/tag/linux.html" class="h-link">linux</a>                    <a rel="nofollow" class="tag-2" href="http://imdagger.github.io/tag/iandeks.html" class="h-link">Яндекс</a>                    <a rel="nofollow" class="tag-1" href="http://imdagger.github.io/tag/bge.html" class="h-link">bge</a>                    <a rel="nofollow" class="tag-2" href="http://imdagger.github.io/tag/javascript.html" class="h-link">javascript</a>                </li>                <li>                    <a rel="nofollow" class="tag-2" href="http://imdagger.github.io/tag/emacs.html" class="h-link">emacs</a>                    <a rel="nofollow" class="tag-1" href="http://imdagger.github.io/tag/zhizn.html" class="h-link">жизнь</a>                    <a rel="nofollow" class="tag-1" href="http://imdagger.github.io/tag/blender.html" class="h-link">blender</a>                    <a rel="nofollow" class="tag-1" href="http://imdagger.github.io/tag/bredni.html" class="h-link">бредни</a>                    <a rel="nofollow" class="tag-1" href="http://imdagger.github.io/tag/radost.html" class="h-link">радость</a>                </li>                <li>                    <a rel="nofollow" class="tag-1" href="http://imdagger.github.io/tag/python.html" class="h-link">python</a>                    <a rel="nofollow" class="tag-1" href="http://imdagger.github.io/tag/programmirovanie.html" class="h-link">программирование</a>                    <a rel="nofollow" class="tag-2" href="http://imdagger.github.io/tag/sborka.html" class="h-link">сборка</a>                    <a rel="nofollow" class="tag-1" href="http://imdagger.github.io/tag/rabota.html" class="h-link">работа</a>                    <a rel="nofollow" class="tag-2" href="http://imdagger.github.io/tag/eda.html" class="h-link">еда</a>                </li>            </ul>
        </div> ·
        <div class="btn-group">
            <span type="button" class="pseudo-link" data-toggle="dropdown">типам</span>
            <ul class="dropdown-menu dropdown-menu-right" role="menu">
                <li><a rel="nofollow" href="http://imdagger.github.io/category/description.html" class="h-link">обращение</a><li>
                <li><a rel="nofollow" href="http://imdagger.github.io/category/friend.html" class="h-link">дружба</a><li>
                <li><a rel="nofollow" href="http://imdagger.github.io/category/join.html" class="h-link">клубы</a><li>
                <li><a rel="nofollow" href="http://imdagger.github.io/category/link.html" class="h-link">ссылки</a><li>
                <li><a rel="nofollow" href="http://imdagger.github.io/category/mood.html" class="h-link">настроение</a><li>
                <li><a rel="nofollow" href="http://imdagger.github.io/category/photo.html" class="h-link">фото</a><li>
                <li><a rel="nofollow" href="http://imdagger.github.io/category/text.html" class="h-link">текст</a><li>
                <li><a rel="nofollow" href="http://imdagger.github.io/category/video.html" class="h-link">видео</a><li>
                <li><a rel="nofollow" href="http://imdagger.github.io/category/wishlist.html" class="h-link"></a><li>
            </ul>
        </div>
    </span>
</div>
    <div class="row b-post">
<div class="panel panel-text">
    <div class="panel-heading b-post-type b-post-type-text">
        <b class="b-user">
            <a class="b-user__link" href="http://imdagger.github.io/author/imdagger.html"><b class="b-user__first-letter">I</b>MDagger</a>
        </b>
написал        <span class="pull-right b-date">
            <a class="h-link" href="http://imdagger.github.io/posts/2009/09/26/kak-ia-pokorial-tablichnye-funktsii/" >
                26 сентября 2009 года, 17:35
            </a>
        </span>
    </div>
    <div class="panel-body">
        <div class="col-sm-1 b-post__layout-left">
            <a href="http://imdagger.github.io/author/imdagger.html"><img src="http://upics.yandex.ru/22199227/middle"></a>
        </div>
        <div class="col-sm-11 b-right-col">
            <noindex>
<div class="row tags-row">
    <span class="tag"><a rel="nofollow" class="h-link" href="http://imdagger.github.io/tag/spring.html">spring</a></span>,    <span class="tag"><a rel="nofollow" class="h-link" href="http://imdagger.github.io/tag/hibernate.html">hibernate</a></span>,    <span class="tag"><a rel="nofollow" class="h-link" href="http://imdagger.github.io/tag/annotatsii.html">аннотации</a></span></div>
            </noindex>
            <div class="post-title">
<a class="no-link" href="http://imdagger.github.io/posts/2009/09/26/kak-ia-pokorial-tablichnye-funktsii/">Как я покорял табличные функции</a>            </div>
            <div class="row post-body">
                <div class="b-text">
<p>Во-первых, я хотел постараться проделать всю работу через аннотации
<strong>JPA</strong> и <strong>Hibernate</strong>. Но мне требовалось промэппить пробный класс
<em>HeaderItem</em> не только на таблицу <em>dl2ResultsHeaderItem</em>, но и на
результат функции из базы данных. А функция
<em>dl2ResultsHeaderItemSubTree</em> требует 5 параметров и возвращает таблицу
из 3 параметров, у которой не все названия совпадают с
dl2ResultsHeaderItem.</p>
<p>Поискав во «всемирной паутине» ответ на свой вопрос, как сделать
такую операцию, я нашёл ответ только для хранимых процедур, а мне нужна
была хранимая функция. Причём всё, что я находил похожее для моих нужд,
оно почему-то у меня не работало.</p>
<p>Поэтому я нашёл способ реализовать задуманное через аннотацию
NamedNativeQuery из javax.persistence, я его переделал из примера для
хранимых процедур:</p>
<p class="cut"><a class="h-link reference internal" href="#cut_59107984"data-toggle="collapse">и как оно выглядит?</a></p>
<div class="collapse" id="cut_59107984">
<div class="highlight"><pre><span class="pgcss-kn">package</span> <span class="pgcss-n">results</span><span class="pgcss-o">;</span>
<span class="pgcss-kn">import</span> <span class="pgcss-nn">java.io.Serializable</span><span class="pgcss-o">;</span>
<span class="pgcss-kn">import</span> <span class="pgcss-nn">javax.persistence.*</span><span class="pgcss-o">;</span>
<span class="pgcss-nd">@Entity</span>
<span class="pgcss-nd">@NamedNativeQuery</span> <span class="pgcss-o">(</span><span class="pgcss-n">name</span> <span class="pgcss-o">=</span> <span class="pgcss-s">&quot;headerItem.forSubTree&quot;</span><span class="pgcss-o">,</span>
        <span class="pgcss-n">resultClass</span> <span class="pgcss-o">=</span> <span class="pgcss-n">HeaderItem</span><span class="pgcss-o">.</span><span class="pgcss-na">class</span><span class="pgcss-o">,</span>
        <span class="pgcss-n">query</span> <span class="pgcss-o">=</span> <span class="pgcss-s">&quot;select itemId, itemIndex as childIndex, deep from dl2ResultsHeaderItemSubTree</span>
<span class="pgcss-s">                  (:rootId, :deep, :leavesOnly, :includeRoot, :date)&quot;</span><span class="pgcss-o">,</span>
        <span class="pgcss-n">hints</span> <span class="pgcss-o">=</span> <span class="pgcss-o">{</span><span class="pgcss-nd">@QueryHint</span> <span class="pgcss-o">(</span><span class="pgcss-n">name</span> <span class="pgcss-o">=</span> <span class="pgcss-s">&quot;org.hibernate.callable&quot;</span><span class="pgcss-o">,</span> <span class="pgcss-n">value</span> <span class="pgcss-o">=</span> <span class="pgcss-s">&quot;true&quot;</span><span class="pgcss-o">),</span> <span class="pgcss-o">*</span><span class="pgcss-c1">// Бага!!!*</span>
                 <span class="pgcss-nd">@QueryHint</span> <span class="pgcss-o">(</span><span class="pgcss-n">name</span> <span class="pgcss-o">=</span> <span class="pgcss-s">&quot;org.hibernate.readOnly&quot;</span><span class="pgcss-o">,</span> <span class="pgcss-n">value</span> <span class="pgcss-o">=</span> <span class="pgcss-s">&quot;true&quot;</span><span class="pgcss-o">)</span>
        <span class="pgcss-o">}</span>
<span class="pgcss-o">)</span>
<span class="pgcss-nd">@Table</span> <span class="pgcss-o">(</span><span class="pgcss-n">name</span><span class="pgcss-o">=</span><span class="pgcss-s">&quot;dl2ResultsHeaderItem&quot;</span><span class="pgcss-o">)</span>
<span class="pgcss-kd">public</span> <span class="pgcss-kd">class</span> <span class="pgcss-nc">HeaderItem</span> <span class="pgcss-kd">implements</span> <span class="pgcss-n">Serializable</span> <span class="pgcss-o">{</span>
    <span class="pgcss-kd">private</span> <span class="pgcss-n">Long</span> <span class="pgcss-n">id</span><span class="pgcss-o">;</span>
    <span class="pgcss-kd">private</span> <span class="pgcss-n">Long</span> <span class="pgcss-n">index</span><span class="pgcss-o">;</span>
    <span class="pgcss-kd">private</span> <span class="pgcss-kt">int</span> <span class="pgcss-n">deep</span><span class="pgcss-o">;</span>

    <span class="pgcss-kd">public</span> <span class="pgcss-nf">HeaderItem</span><span class="pgcss-o">()</span> <span class="pgcss-o">{</span>
    <span class="pgcss-o">};</span>

    <span class="pgcss-nd">@Id</span>
    <span class="pgcss-nd">@Column</span><span class="pgcss-o">(</span><span class="pgcss-n">name</span><span class="pgcss-o">=</span><span class="pgcss-s">&quot;itemId&quot;</span><span class="pgcss-o">)</span>
    <span class="pgcss-kd">public</span> <span class="pgcss-n">Long</span> <span class="pgcss-nf">getId</span><span class="pgcss-o">()</span> <span class="pgcss-o">{</span>
        <span class="pgcss-k">return</span> <span class="pgcss-n">id</span><span class="pgcss-o">;</span>
    <span class="pgcss-o">};</span>

    <span class="pgcss-kd">public</span> <span class="pgcss-kt">void</span> <span class="pgcss-nf">setId</span><span class="pgcss-o">(</span><span class="pgcss-n">Long</span> <span class="pgcss-n">id</span><span class="pgcss-o">)</span> <span class="pgcss-o">{</span>
        <span class="pgcss-k">this</span><span class="pgcss-o">.</span><span class="pgcss-na">id</span> <span class="pgcss-o">=</span> <span class="pgcss-n">id</span><span class="pgcss-o">;</span>
    <span class="pgcss-o">};</span>

    <span class="pgcss-nd">@Column</span><span class="pgcss-o">(</span><span class="pgcss-n">name</span><span class="pgcss-o">=</span><span class="pgcss-s">&quot;childIndex&quot;</span><span class="pgcss-o">)</span>
    <span class="pgcss-kd">public</span> <span class="pgcss-n">Long</span> <span class="pgcss-nf">getIndex</span><span class="pgcss-o">()</span> <span class="pgcss-o">{</span>
        <span class="pgcss-k">return</span> <span class="pgcss-n">index</span><span class="pgcss-o">;</span>
    <span class="pgcss-o">};</span>

    <span class="pgcss-kd">public</span> <span class="pgcss-kt">void</span> <span class="pgcss-nf">setIndex</span><span class="pgcss-o">(</span><span class="pgcss-n">Long</span> <span class="pgcss-n">index</span><span class="pgcss-o">)</span> <span class="pgcss-o">{</span>
        <span class="pgcss-k">this</span><span class="pgcss-o">.</span><span class="pgcss-na">index</span> <span class="pgcss-o">=</span> <span class="pgcss-n">index</span><span class="pgcss-o">;</span>
    <span class="pgcss-o">};</span>

    <span class="pgcss-nd">@Column</span><span class="pgcss-o">(</span><span class="pgcss-n">name</span><span class="pgcss-o">=</span><span class="pgcss-s">&quot;deep&quot;</span><span class="pgcss-o">)</span>
    <span class="pgcss-kd">public</span> <span class="pgcss-kt">int</span> <span class="pgcss-nf">getDeep</span><span class="pgcss-o">()</span> <span class="pgcss-o">{</span>
        <span class="pgcss-k">return</span> <span class="pgcss-n">deep</span><span class="pgcss-o">;</span>
    <span class="pgcss-o">};</span>

    <span class="pgcss-kd">public</span> <span class="pgcss-kt">void</span> <span class="pgcss-nf">setDeep</span><span class="pgcss-o">(</span><span class="pgcss-kt">int</span> <span class="pgcss-n">id</span><span class="pgcss-o">)</span> <span class="pgcss-o">{</span>
        <span class="pgcss-k">this</span><span class="pgcss-o">.</span><span class="pgcss-na">deep</span> <span class="pgcss-o">=</span> <span class="pgcss-n">deep</span><span class="pgcss-o">;</span>
    <span class="pgcss-o">};</span>
<span class="pgcss-o">};</span>
</pre></div>
<p>Запрос <em>select itemId, itemIndex as childIndex, deep ...</em> выбирает
данные таким образом, чтобы поля возвращаемой таблицы совпадали с
указанным в классе мэппингом.</p>
<p>Жаль, но таблицу и хранимую функцию делал не я, а за долго до
меня. Поэтому их ломать нельзя (слишком много эксплуатируемого кода на
них висит). Я довольно долго боролся с Hibernate, т.к. выпадало
исколючение в jTDS вида: <code class="code">
11410 [http-8080-1] INFO
org.hibernate.type.CalendarType - could not bind value ‘2009-09-26
16:30:13’ to parameter: 5; Invalid parameter index 5</code>
. Я долго думал, как
так может быть, что параметров вроде 5, передаю 5 такой конструкцией
(<del class="del">
собранной на скорую руку</del>
):</p>
<div class="highlight"><pre><span class="pgcss-n">List</span> <span class="pgcss-n">result</span> <span class="pgcss-o">=</span>
<span class="pgcss-n">getHibernateTemplate</span><span class="pgcss-o">().</span><span class="pgcss-na">findByNamedQueryAndNamedParam</span><span class="pgcss-o">(</span><span class="pgcss-s">&quot;headerItem.forSubTree&quot;</span><span class="pgcss-o">,</span>
    <span class="pgcss-k">new</span> <span class="pgcss-n">String</span><span class="pgcss-o">[]</span> <span class="pgcss-o">{</span><span class="pgcss-s">&quot;rootId&quot;</span><span class="pgcss-o">,</span> <span class="pgcss-s">&quot;deep&quot;</span><span class="pgcss-o">,</span> <span class="pgcss-s">&quot;leavesOnly&quot;</span><span class="pgcss-o">,</span> <span class="pgcss-s">&quot;includeRoot&quot;</span><span class="pgcss-o">,</span> <span class="pgcss-s">&quot;date&quot;</span><span class="pgcss-o">},</span>
    <span class="pgcss-k">new</span> <span class="pgcss-n">Object</span><span class="pgcss-o">[]</span> <span class="pgcss-o">{</span><span class="pgcss-n">rootId</span><span class="pgcss-o">,</span> <span class="pgcss-n">deep</span><span class="pgcss-o">,</span> <span class="pgcss-n">leavesOnly</span><span class="pgcss-o">,</span> <span class="pgcss-o">(</span><span class="pgcss-n">includeRoot</span> <span class="pgcss-o">?</span> <span class="pgcss-mi">1</span> <span class="pgcss-o">:</span> <span class="pgcss-mi">0</span><span class="pgcss-o">),</span> <span class="pgcss-n">date</span><span class="pgcss-o">});</span> <span class="pgcss-c1">// date типа java.util.Calendar</span>
</pre></div>
<p>Но потом до меня дошло, что мешает <code class="code">
&#64;QueryHint(name =
&quot;org.hibernate.callable&quot;, value = &quot;true&quot;)</code>
, который предполагает, что это
процедура и первый параметр забирает под её нужды.</p>
<p>Проблема решилась банально — я убрал эту запись и всё заработало.</p>
</div>
                </div>
            </div>
            <div class="row comments-row">
                <span><a class="pseudo-link b-candy b-comment-shortcut"><i class="b-ico"></i>ответить</a></span>
            </div>
        </div>
    </div>
</div><div class="panel panel-text">
    <div class="panel-heading b-post-type b-post-type-text">
        <b class="b-user">
            <a class="b-user__link" href="http://imdagger.github.io/author/imdagger.html"><b class="b-user__first-letter">I</b>MDagger</a>
        </b>
написал        <span class="pull-right b-date">
            <a class="h-link" href="http://imdagger.github.io/posts/2009/09/23/steny-kreposti-postroeny/" >
                23 сентября 2009 года, 17:20
            </a>
        </span>
    </div>
    <div class="panel-body">
        <div class="col-sm-1 b-post__layout-left">
            <a href="http://imdagger.github.io/author/imdagger.html"><img src="http://upics.yandex.ru/22199227/middle"></a>
        </div>
        <div class="col-sm-11 b-right-col">
            <noindex>
<div class="row tags-row">
    <span class="tag"><a rel="nofollow" class="h-link" href="http://imdagger.github.io/tag/dl.html">dl</a></span>,    <span class="tag"><a rel="nofollow" class="h-link" href="http://imdagger.github.io/tag/java.html">java</a></span>,    <span class="tag"><a rel="nofollow" class="h-link" href="http://imdagger.github.io/tag/spring.html">spring</a></span>,    <span class="tag"><a rel="nofollow" class="h-link" href="http://imdagger.github.io/tag/hibernate.html">hibernate</a></span></div>
            </noindex>
            <div class="post-title">
<a class="no-link" href="http://imdagger.github.io/posts/2009/09/23/steny-kreposti-postroeny/">Стены крепости построены</a>            </div>
            <div class="row post-body">
                <div class="b-text">
<p>Прочитав
<a class="reference external" href="http://samolisov.blogspot.com/2009/06/hibernate-spring.html">блог</a>
сурового челябинского программиста и
<a class="reference external" href="http://maestric.com/doc/java/spring/mvc">туториал</a>, как работать со
<strong>SpringFramework</strong>, я всё же смог настроить тандем Spring+Hibernate.
Т.к. я сначала настраивал <strong>Hibernate</strong> отдельно, а затем прикручивал
Spring, то вышло, что часть настроек из конфигов нужно было перенести в
другое место из-за того, что в связке настройку будет производить
фреймворк, а не ORM. Пришлось убрать файл context.xml из META-INF,
который описывал параметры подключения Hibernate3 к базе данных через
драйвер <strong>jTDS</strong>. Настройки web.xml в WEB-INF стали выглядеть таким
образом:</p>
<p class="cut"><a class="h-link reference internal" href="#cut_61045136"data-toggle="collapse">а как?</a></p>
<div class="collapse" id="cut_61045136">
<div class="highlight"><pre>...
<span class="pgcss-nt">&lt;web-app</span> <span class="pgcss-na">xmlns=</span><span class="pgcss-s">&quot;http://java.sun.com/xml/ns/javaee&quot;</span>
  <span class="pgcss-na">xmlns:xsi=</span><span class="pgcss-s">&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span>
  <span class="pgcss-na">xsi:schemaLocation=</span><span class="pgcss-s">&quot;http://java.sun.com/xml/ns/javaee http://java.sun.com/xml/ns/javaee/web-app_2_5.xsd&quot;</span>
  <span class="pgcss-na">version=</span><span class="pgcss-s">&quot;2.5&quot;</span><span class="pgcss-nt">&gt;</span>
  <span class="pgcss-nt">&lt;servlet&gt;</span>
  <span class="pgcss-nt">&lt;servlet-name&gt;</span>dl<span class="pgcss-nt">&lt;/servlet-name&gt;</span>
  <span class="pgcss-nt">&lt;servlet-class&gt;</span>
      <strong>org.springframework.web.servlet.DispatcherServlet</strong>
  <span class="pgcss-nt">&lt;/servlet-class&gt;</span>
  <span class="pgcss-nt">&lt;load-on-startup&gt;</span>1<span class="pgcss-nt">&lt;/load-on-startup&gt;</span>
  <span class="pgcss-nt">&lt;/servlet&gt;</span>
  <span class="pgcss-nt">&lt;servlet-mapping&gt;</span>
  <span class="pgcss-nt">&lt;servlet-name&gt;</span>dl<span class="pgcss-nt">&lt;/servlet-name&gt;</span>
  <strong><span class="pgcss-nt">&lt;url-pattern&gt;</span>/<span class="pgcss-nt">&lt;/url-pattern&gt;</span></strong>
  <span class="pgcss-nt">&lt;/servlet-mapping&gt;</span>
  <span class="pgcss-nt">&lt;context-param&gt;</span>
  <span class="pgcss-nt">&lt;param-name&gt;</span>contextConfigLocation<span class="pgcss-nt">&lt;/param-name&gt;</span>
  <strong><span class="pgcss-nt">&lt;param-value&gt;</span>/WEB-INF/dl-servlet.xml<span class="pgcss-nt">&lt;/param-value&gt;</span></strong>
  <span class="pgcss-nt">&lt;/context-param&gt;</span>
  <span class="pgcss-nt">&lt;listener&gt;</span>
  <span class="pgcss-nt">&lt;listener-class&gt;</span>
      <strong>org.springframework.web.context.ContextLoaderListener</strong>
  <span class="pgcss-nt">&lt;/listener-class&gt;</span>
  <span class="pgcss-nt">&lt;/listener&gt;</span>
<strong>...</strong>
<span class="pgcss-nt">&lt;/web-app&gt;</span>
</pre></div>
<p>Тег servlet указывает Apache Tomcat, что нужно загрузить сервлет
<strong>org.springframework.web.servlet.DispatcherServlet</strong> для обработки
запросов. В директории WEB-INFнаходится файл dl-servlet.xml, который
описывает настройки сервлета:</p>
<div class="highlight"><pre><span class="pgcss-cp">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;</span>
<span class="pgcss-nt">&lt;beans</span> <span class="pgcss-na">xmlns=</span><span class="pgcss-s">&quot;http://www.springframework.org/schema/beans&quot;</span>
  <span class="pgcss-na">xmlns:xsi=</span><span class="pgcss-s">&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span>
  <span class="pgcss-na">xmlns:aop=</span><span class="pgcss-s">&quot;http://www.springframework.org/schema/aop&quot;</span>
  <span class="pgcss-na">xsi:schemaLocation=</span><span class="pgcss-s">&quot;http://www.springframework.org/schema/beans</span>
<span class="pgcss-s">  http://www.springframework.org/schema/beans/spring-beans-2.0.xsd&quot;</span><span class="pgcss-nt">&gt;</span>
  <strong><span class="pgcss-nt">&lt;import</span> <span class="pgcss-na">resource=</span><span class="pgcss-s">&quot;/dl-context/main-context.xml&quot;</span> <span class="pgcss-nt">/&gt;</span></strong>
<span class="pgcss-nt">&lt;/beans&gt;</span>
</pre></div>
<p>Он подключает из каталога dl-context различные параметры настройки. Пока
у меня всего один файл, но скоро я разобью опции на несколько файлов по
типам. Настройка основного контекста описана в main-context.xml:</p>
<div class="highlight"><pre><span class="pgcss-cp">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;</span>
<span class="pgcss-nt">&lt;beans</span> <span class="pgcss-na">xmlns=</span><span class="pgcss-s">&quot;http://www.springframework.org/schema/beans&quot;</span>
  <span class="pgcss-na">xmlns:xsi=</span><span class="pgcss-s">&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span>
  <span class="pgcss-na">xmlns:aop=</span><span class="pgcss-s">&quot;http://www.springframework.org/schema/aop&quot;</span>
  <span class="pgcss-na">xsi:schemaLocation=</span><span class="pgcss-s">&quot;http://www.springframework.org/schema/beans http://www.springframework.org/schema/beans/spring-beans-2.0.xsd&quot;</span><span class="pgcss-nt">&gt;</span>
<span class="pgcss-c">&lt;!-- This config contains main info about application mappings and view resolvers--&gt;</span>
<span class="pgcss-nt">&lt;bean</span> <span class="pgcss-na">id=</span><span class="pgcss-s">&quot;dataSource&quot;</span> <span class="pgcss-na">class=</span><span class="pgcss-s">&quot;<strong>org.apache.tomcat.dbcp.dbcp.BasicDataSource</strong>&quot;</span> <span class="pgcss-na">destroy-method=</span><span class="pgcss-s">&quot;close&quot;</span><span class="pgcss-nt">&gt;</span>
  <span class="pgcss-nt">&lt;property</span> <span class="pgcss-na">name=</span><span class="pgcss-s">&quot;driverClassName&quot;</span> <span class="pgcss-na">value=</span><span class="pgcss-s">&quot;<strong>net.sourceforge.jtds.jdbc.Driver</strong>&quot;</span> <span class="pgcss-nt">/&gt;</span>
  <span class="pgcss-nt">&lt;property</span> <span class="pgcss-na">name=</span><span class="pgcss-s">&quot;url&quot;</span> <span class="pgcss-na">value=</span><span class="pgcss-s">&quot;<strong>jdbc:jtds:sqlserver://dl-test:1030/dldb</strong>&quot;</span> <span class="pgcss-nt">/&gt;</span>
  <span class="pgcss-nt">&lt;property</span> <span class="pgcss-na">name=</span><span class="pgcss-s">&quot;username&quot;</span> <span class="pgcss-na">value=</span><span class="pgcss-s">&quot;<strong>пользователь-базы</strong>&quot;</span> <span class="pgcss-nt">/&gt;</span>
  <span class="pgcss-nt">&lt;property</span> <span class="pgcss-na">name=</span><span class="pgcss-s">&quot;password&quot;</span> <span class="pgcss-na">value=</span><span class="pgcss-s">&quot;<strong>пароль</strong>&quot;</span> <span class="pgcss-nt">/&gt;</span>
<span class="pgcss-nt">&lt;/bean&gt;</span>
<span class="pgcss-nt">&lt;bean</span> <span class="pgcss-na">id=</span><span class="pgcss-s">&quot;sessionFactory&quot;</span> <span class="pgcss-na">class=</span><span class="pgcss-s">&quot;org.springframework.orm.hibernate3.LocalSessionFactoryBean&quot;</span><span class="pgcss-nt">&gt;</span>
  <span class="pgcss-nt">&lt;property</span> <span class="pgcss-na">name=</span><span class="pgcss-s">&quot;dataSource&quot;</span> <span class="pgcss-na">ref=</span><span class="pgcss-s">&quot;dataSource&quot;</span> <span class="pgcss-nt">/&gt;</span>
  <span class="pgcss-nt">&lt;property</span> <span class="pgcss-na">name=</span><span class="pgcss-s">&quot;configLocation&quot;</span> <span class="pgcss-na">value=</span><span class="pgcss-s">&quot;classpath:/hibernate.cfg.xml&quot;</span> <span class="pgcss-nt">/&gt;</span>
  <span class="pgcss-nt">&lt;property</span> <span class="pgcss-na">name=</span><span class="pgcss-s">&quot;configurationClass&quot;</span> <span class="pgcss-na">value=</span><span class="pgcss-s">&quot;org.hibernate.cfg.AnnotationConfiguration&quot;</span> <span class="pgcss-nt">/&gt;</span>
  <span class="pgcss-nt">&lt;property</span> <span class="pgcss-na">name=</span><span class="pgcss-s">&quot;hibernateProperties&quot;</span><span class="pgcss-nt">&gt;</span>
  <span class="pgcss-nt">&lt;props&gt;</span>
  <span class="pgcss-nt">&lt;prop</span> <span class="pgcss-na">key=</span><span class="pgcss-s">&quot;hibernate.dialect&quot;</span><span class="pgcss-nt">&gt;</span>${hibernate.dialect}<span class="pgcss-nt">&lt;/prop&gt;</span>
  <span class="pgcss-nt">&lt;/props&gt;</span>
  <span class="pgcss-nt">&lt;/property&gt;</span>
<span class="pgcss-nt">&lt;/bean&gt;</span>
<strong><span class="pgcss-nt">&lt;bean</span> <span class="pgcss-na">id=</span><span class="pgcss-s">&quot;cellDAO&quot;</span> <span class="pgcss-na">class=</span><span class="pgcss-s">&quot;results.CellDao&quot;</span><span class="pgcss-nt">&gt;</span>
  <span class="pgcss-nt">&lt;property</span> <span class="pgcss-na">name=</span><span class="pgcss-s">&quot;sessionFactory&quot;</span> <span class="pgcss-na">ref=</span><span class="pgcss-s">&quot;sessionFactory&quot;</span> <span class="pgcss-nt">/&gt;</span>
<span class="pgcss-nt">&lt;/bean&gt;</span>
<span class="pgcss-nt">&lt;bean</span> <span class="pgcss-na">id=</span><span class="pgcss-s">&quot;cellService&quot;</span> <span class="pgcss-na">class=</span><span class="pgcss-s">&quot;results.CellService&quot;</span><span class="pgcss-nt">&gt;</span>
  <span class="pgcss-nt">&lt;property</span> <span class="pgcss-na">name=</span><span class="pgcss-s">&quot;dao&quot;</span> <span class="pgcss-na">ref=</span><span class="pgcss-s">&quot;cellDAO&quot;</span> <span class="pgcss-nt">/&gt;</span>
<span class="pgcss-nt">&lt;/bean&gt;</span>
<span class="pgcss-nt">&lt;bean</span> <span class="pgcss-na">id=</span><span class="pgcss-s">&quot;resultsTableController&quot;</span> <span class="pgcss-na">class=</span><span class="pgcss-s">&quot;results.TableController&quot;</span><span class="pgcss-nt">&gt;</span>
  <span class="pgcss-nt">&lt;property</span> <span class="pgcss-na">name=</span><span class="pgcss-s">&quot;cellService&quot;</span> <span class="pgcss-na">ref=</span><span class="pgcss-s">&quot;cellService&quot;</span><span class="pgcss-nt">/&gt;</span>
<span class="pgcss-nt">&lt;/bean&gt;</span></strong>
<span class="pgcss-nt">&lt;bean</span> <span class="pgcss-na">id=</span><span class="pgcss-s">&quot;simpleUrlHandler&quot;</span> <span class="pgcss-na">class=</span><span class="pgcss-s">&quot;org.springframework.web.servlet.handler.SimpleUrlHandlerMapping&quot;</span><span class="pgcss-nt">&gt;</span>
  <span class="pgcss-nt">&lt;property</span> <span class="pgcss-na">name=</span><span class="pgcss-s">&quot;order&quot;</span><span class="pgcss-nt">&gt;&lt;value&gt;</span>0<span class="pgcss-nt">&lt;/value&gt;&lt;/property&gt;</span>
  <span class="pgcss-nt">&lt;property</span> <span class="pgcss-na">name=</span><span class="pgcss-s">&quot;mappings&quot;</span><span class="pgcss-nt">&gt;</span>
  <span class="pgcss-nt">&lt;props&gt;</span>
  <strong><span class="pgcss-nt">&lt;prop</span> <span class="pgcss-na">key=</span><span class="pgcss-s">&quot;results&quot;</span><span class="pgcss-nt">&gt;</span>resultsTableController<span class="pgcss-nt">&lt;/prop&gt;</span></strong>
  <span class="pgcss-nt">&lt;/props&gt;</span>
  <span class="pgcss-nt">&lt;/property&gt;</span>
<span class="pgcss-nt">&lt;/bean&gt;</span>
<span class="pgcss-nt">&lt;bean</span> <span class="pgcss-na">id=</span><span class="pgcss-s">&quot;viewResolver&quot;</span> <span class="pgcss-na">class=</span><span class="pgcss-s">&quot;org.springframework.web.servlet.view.InternalResourceViewResolver&quot;</span><span class="pgcss-nt">&gt;</span>
  <span class="pgcss-nt">&lt;property</span> <span class="pgcss-na">name=</span><span class="pgcss-s">&quot;cache&quot;</span> <span class="pgcss-na">value=</span><span class="pgcss-s">&quot;false&quot;</span><span class="pgcss-nt">/&gt;</span>
  <span class="pgcss-nt">&lt;property</span> <span class="pgcss-na">name=</span><span class="pgcss-s">&quot;viewClass&quot;</span><span class="pgcss-nt">&gt;&lt;value&gt;</span>org.springframework.web.servlet.view.JstlView<span class="pgcss-nt">&lt;/value&gt;&lt;/property&gt;</span>
  <span class="pgcss-nt">&lt;property</span> <span class="pgcss-na">name=</span><span class="pgcss-s">&quot;prefix&quot;</span><span class="pgcss-nt">&gt;&lt;value&gt;</span>/WEB-INF/pages/jsp/<span class="pgcss-nt">&lt;/value&gt;&lt;/property&gt;</span>
  <span class="pgcss-nt">&lt;property</span> <span class="pgcss-na">name=</span><span class="pgcss-s">&quot;suffix&quot;</span><span class="pgcss-nt">&gt;&lt;value&gt;</span>.jsp<span class="pgcss-nt">&lt;/value&gt;&lt;/property&gt;</span>
<span class="pgcss-nt">&lt;/bean&gt;</span>
<span class="pgcss-nt">&lt;/beans&gt;</span>
</pre></div>
<p>Сервер баз данных у меня внешний MSSQL 2005 Express Edition (к
сожалению у меня нету выбора и приходится работать с этим, т.к. я лишь
рефакторю код существующей большой системы, которую просто так нельзя
сломать). Запускаю же Tomcat у себя на Linux.</p>
<p>В бине (не путать с бинами из Java, это другое понятие бина, оно из
Spring) <strong>dataSource</strong> указываются параметры подключения к серверу БД и
класс драйвера JDBC. В sessionFactory указано, что при создании объекта
из этого бина, нужно создать объект dataSource, для этого написана
ссылка &lt;property name=&quot;dataSource&quot; ref=&quot;dataSource&quot; /&gt;.</p>
<p>CellDao, CellService и ResultsTableController — это мои пробные
классы для работы с ячейками таблицы результатов. Маппинг &lt;prop
key=&quot;results&quot;&gt;resultsTableController&lt;/prop&gt; позволяет, при переходе по
адресу <strong>http://localhost:8080/dl/results</strong>, передавать управление
контроллеру ResultsTableController, котрый в свою очередь создаёт
представление:</p>
<div class="highlight"><pre><span class="pgcss-o">...</span>
<span class="pgcss-o">...</span> <span class="pgcss-k">new</span> <span class="pgcss-nf">ModelAndView</span><span class="pgcss-o">(</span><span class="pgcss-s">&quot;<strong>index</strong>&quot;</span><span class="pgcss-o">)</span>
<span class="pgcss-o">...</span>
</pre></div>
<p>Я сделал это, чтобы проверить мэппинг. Сами JSP-файлы (в частности и
index.jsp) хранятся в WEB-INF/pages/jsp/, эта информация настривается в
бине <strong>viewResolver</strong>. В скором будущем я добавлю класс XsltViewer,
который будет использовать не JSP, а XSLT.Это связано с потребностью в
отображении HTML-данных и XML API-интерфейсе одновременно, но при
отсутствии дублирования кода.</p>
</div>
                </div>
            </div>
            <div class="row comments-row">
                <span><a class="pseudo-link b-candy b-comment-shortcut"><i class="b-ico"></i>ответить</a></span>
            </div>
        </div>
    </div>
</div><div class="panel panel-text">
    <div class="panel-heading b-post-type b-post-type-text">
        <b class="b-user">
            <a class="b-user__link" href="http://imdagger.github.io/author/imdagger.html"><b class="b-user__first-letter">I</b>MDagger</a>
        </b>
написал        <span class="pull-right b-date">
            <a class="h-link" href="http://imdagger.github.io/posts/2009/09/20/magiia-rusalok/" >
                20 сентября 2009 года, 19:44
            </a>
        </span>
    </div>
    <div class="panel-body">
        <div class="col-sm-1 b-post__layout-left">
            <a href="http://imdagger.github.io/author/imdagger.html"><img src="http://upics.yandex.ru/22199227/middle"></a>
        </div>
        <div class="col-sm-11 b-right-col">
            <noindex>
<div class="row tags-row">
    <span class="tag"><a rel="nofollow" class="h-link" href="http://imdagger.github.io/tag/java.html">java</a></span>,    <span class="tag"><a rel="nofollow" class="h-link" href="http://imdagger.github.io/tag/spring.html">spring</a></span></div>
            </noindex>
            <div class="post-title">
<a class="no-link" href="http://imdagger.github.io/posts/2009/09/20/magiia-rusalok/">Магия русалок</a>            </div>
            <div class="row post-body">
                <div class="b-text">
<p>Недавно начал настраивать Spring Framework 3 в связке с Apache
Tomcat 6 и столкнулся с проблемой, что вроде все мэппинги правильно
указал, а страница никак не открывается. И в логе видно предупреждение:
<code class="code">
[http-8080-1] WARN org.springframework.web.servlet.PageNotFound - No
mapping found for HTTP request with URI [/dl/index] in DisptcherServlet
with name ‘dl’</code>
. Порыскав на просторах Великого и Могучего, я нашёл
ответ на свой вопрос на
<a class="reference external" href="http://stackoverflow.com/questions/1266303/no-mapping-found-for-http-request-with-uri-web-inf-pages-apiform-jsp">stackoverflow</a>.
Оказалось, что стоит сменить в моём <strong>web.xml</strong>:</p>
<div class="highlight"><pre>строки с:
<span class="pgcss-nt">&lt;servlet-mapping&gt;</span>
    <span class="pgcss-nt">&lt;servlet-name&gt;</span>dl<span class="pgcss-nt">&lt;/servlet-name&gt;</span>
    <span class="pgcss-nt">&lt;url-pattern&gt;</span>/*<span class="pgcss-nt">&lt;url-pattern&gt;</span>
<span class="pgcss-nt">&lt;/servlet-mapping&gt;</span>
на:
<span class="pgcss-nt">&lt;servlet-mapping&gt;</span>
    <span class="pgcss-nt">&lt;servlet-name&gt;</span>dl<span class="pgcss-nt">&lt;/servlet-name&gt;</span>
    <span class="pgcss-nt">&lt;url-pattern&gt;</span>/<span class="pgcss-nt">&lt;url-pattern&gt;</span>
<span class="pgcss-nt">&lt;/servlet-mapping&gt;</span>
</pre></div>
<p>И ссылка <a class="reference external" href="http://localhost:8080/dl/index">http://localhost:8080/dl/index</a> стала открываться ;).</p>
                </div>
            </div>
            <div class="row comments-row">
                <span><a class="pseudo-link b-candy b-comment-shortcut"><i class="b-ico"></i>ответить</a></span>
            </div>
        </div>
    </div>
</div><div class="panel panel-text">
    <div class="panel-heading b-post-type b-post-type-text">
        <b class="b-user">
            <a class="b-user__link" href="http://imdagger.github.io/author/imdagger.html"><b class="b-user__first-letter">I</b>MDagger</a>
        </b>
написал        <span class="pull-right b-date">
            <a class="h-link" href="http://imdagger.github.io/posts/2009/09/20/spring/" >
                20 сентября 2009 года, 18:07
            </a>
        </span>
    </div>
    <div class="panel-body">
        <div class="col-sm-1 b-post__layout-left">
            <a href="http://imdagger.github.io/author/imdagger.html"><img src="http://upics.yandex.ru/22199227/middle"></a>
        </div>
        <div class="col-sm-11 b-right-col">
            <noindex>
<div class="row tags-row">
    <span class="tag"><a rel="nofollow" class="h-link" href="http://imdagger.github.io/tag/tomcat.html">tomcat</a></span>,    <span class="tag"><a rel="nofollow" class="h-link" href="http://imdagger.github.io/tag/java.html">java</a></span></div>
            </noindex>
            <div class="post-title">
<a class="no-link" href="http://imdagger.github.io/posts/2009/09/20/spring/">Spring</a>            </div>
            <div class="row post-body">
                <div class="b-text">
<p>Мой ущербный мозг забыл, где находится пакет <code class="code">
javax.servlet</code>
. Я
поискал быстренько в гугле, и он мне напомнил про каталог lib в моём
apache-tomcat-6.0.20. Там лежал файл <u class="underline">
servlet-api.jar</u>
, который и
поставлял необходимый функционал.</p>
                </div>
            </div>
            <div class="row comments-row">
                <span><a class="pseudo-link b-candy b-comment-shortcut"><i class="b-ico"></i>ответить</a></span>
            </div>
        </div>
    </div>
</div><div class="panel panel-text">
    <div class="panel-heading b-post-type b-post-type-text">
        <b class="b-user">
            <a class="b-user__link" href="http://imdagger.github.io/author/imdagger.html"><b class="b-user__first-letter">I</b>MDagger</a>
        </b>
написал        <span class="pull-right b-date">
            <a class="h-link" href="http://imdagger.github.io/posts/2009/09/19/sebe-na-zametku/" >
                19 сентября 2009 года, 18:59
            </a>
        </span>
    </div>
    <div class="panel-body">
        <div class="col-sm-1 b-post__layout-left">
            <a href="http://imdagger.github.io/author/imdagger.html"><img src="http://upics.yandex.ru/22199227/middle"></a>
        </div>
        <div class="col-sm-11 b-right-col">
            <noindex>
<div class="row tags-row">
    <span class="tag"><a rel="nofollow" class="h-link" href="http://imdagger.github.io/tag/dl.html">dl</a></span>,    <span class="tag"><a rel="nofollow" class="h-link" href="http://imdagger.github.io/tag/zametka.html">заметка</a></span></div>
            </noindex>
            <div class="post-title">
<a class="no-link" href="http://imdagger.github.io/posts/2009/09/19/sebe-na-zametku/">Себе на заметку</a>            </div>
            <div class="row post-body">
                <div class="b-text">
<p>Если после создания в следующем году новой группы на тестирующей
системе возникнут проблемы, что после перестройки таблицы, результаты в
ней отсутствуют (нет ни суммы, ни посылок и все на одном «общем месте»),
то не забыть установить правильное значение <code class="code">
java.ProcessLogId</code>
 в
таблице <strong>Properties</strong>. Вся проблема в том, что SQL-код обновления
таблиц результатов обновляет только всё до <code class="code">
&#64;ProcessLogId</code>
.</p>
                </div>
            </div>
            <div class="row comments-row">
                <span><a class="pseudo-link b-candy b-comment-shortcut"><i class="b-ico"></i>ответить</a></span>
            </div>
        </div>
    </div>
</div><div class="panel panel-text">
    <div class="panel-heading b-post-type b-post-type-text">
        <b class="b-user">
            <a class="b-user__link" href="http://imdagger.github.io/author/imdagger.html"><b class="b-user__first-letter">I</b>MDagger</a>
        </b>
написал        <span class="pull-right b-date">
            <a class="h-link" href="http://imdagger.github.io/posts/2009/09/17/voina-s-timestamp/" >
                17 сентября 2009 года, 21:17
            </a>
        </span>
    </div>
    <div class="panel-body">
        <div class="col-sm-1 b-post__layout-left">
            <a href="http://imdagger.github.io/author/imdagger.html"><img src="http://upics.yandex.ru/22199227/middle"></a>
        </div>
        <div class="col-sm-11 b-right-col">
            <noindex>
<div class="row tags-row">
    <span class="tag"><a rel="nofollow" class="h-link" href="http://imdagger.github.io/tag/msssql.html">msssql</a></span>,    <span class="tag"><a rel="nofollow" class="h-link" href="http://imdagger.github.io/tag/hibernate.html">hibernate</a></span></div>
            </noindex>
            <div class="post-title">
<a class="no-link" href="http://imdagger.github.io/posts/2009/09/17/voina-s-timestamp/">Война с Timestamp</a>            </div>
            <div class="row post-body">
                <div class="b-text">
<p>В MSSQL 2005 Timestamp он же RowVersion — 16-байтовое поле, которое
отражает «версию изменений» ряда. Но если требуется промэппить это поле
на метод POJO-объекта, то возникает вопрос: «Какой тип выбрать?». Сперва
пришла мысль взять <code class="code">
java.sql.Timestamp</code>
, но… Hibernate выдавал ошибку,
что нельзя преобразовать <code class="code">
[B</code>
 в <code class="code">
Timestamp</code>
. Поэтому пришлось решить
эту проблему, указав тип <code class="code">
byte[]</code>
.</p>
<div class="highlight"><pre><span class="pgcss-nd">@Id</span>
<span class="pgcss-nd">@Column</span><span class="pgcss-o">(</span><span class="pgcss-n">name</span><span class="pgcss-o">=</span><span class="pgcss-s">&quot;ts&quot;</span><span class="pgcss-o">)</span>
<span class="pgcss-kd">public</span> <span class="pgcss-kt">byte</span><span class="pgcss-o">[]</span> <span class="pgcss-nf">getVersion</span><span class="pgcss-o">()</span> <span class="pgcss-o">{</span>
    <span class="pgcss-k">return</span> <span class="pgcss-n">version</span><span class="pgcss-o">;</span>
<span class="pgcss-o">};</span>
<span class="pgcss-kd">public</span> <span class="pgcss-kt">void</span> <span class="pgcss-nf">setVersion</span><span class="pgcss-o">(</span><span class="pgcss-kt">byte</span><span class="pgcss-o">[]</span> <span class="pgcss-n">ts</span><span class="pgcss-o">)</span> <span class="pgcss-o">{</span>
    <span class="pgcss-n">version</span> <span class="pgcss-o">=</span> <span class="pgcss-n">ts</span><span class="pgcss-o">;</span>
<span class="pgcss-o">};</span>
</pre></div>
<p>Не уверен, что мне нужен будет <code class="code">
setVersion</code>
, да и скорее всего я
запрещу обновлять это поле и добавлять, при помощи параметров в
аннотации <code class="code">
&#64;Column</code>
.</p>
                </div>
            </div>
            <div class="row comments-row">
                <span><a class="pseudo-link b-candy b-comment-shortcut"><i class="b-ico"></i>ответить</a></span>
            </div>
        </div>
    </div>
</div><div class="panel panel-text">
    <div class="panel-heading b-post-type b-post-type-text">
        <b class="b-user">
            <a class="b-user__link" href="http://imdagger.github.io/author/imdagger.html"><b class="b-user__first-letter">I</b>MDagger</a>
        </b>
написал        <span class="pull-right b-date">
            <a class="h-link" href="http://imdagger.github.io/posts/2009/09/16/hibernate/" >
                16 сентября 2009 года, 11:13
            </a>
        </span>
    </div>
    <div class="panel-body">
        <div class="col-sm-1 b-post__layout-left">
            <a href="http://imdagger.github.io/author/imdagger.html"><img src="http://upics.yandex.ru/22199227/middle"></a>
        </div>
        <div class="col-sm-11 b-right-col">
            <noindex>
<div class="row tags-row">
    <span class="tag"><a rel="nofollow" class="h-link" href="http://imdagger.github.io/tag/oshibka.html">ошибка</a></span>,    <span class="tag"><a rel="nofollow" class="h-link" href="http://imdagger.github.io/tag/java.html">java</a></span>,    <span class="tag"><a rel="nofollow" class="h-link" href="http://imdagger.github.io/tag/hibernate.html">hibernate</a></span></div>
            </noindex>
            <div class="post-title">
<a class="no-link" href="http://imdagger.github.io/posts/2009/09/16/hibernate/">Hibernate</a>            </div>
            <div class="row post-body">
                <div class="b-text">
<p>Вчера добрался снова до <strong>Hibernate</strong> и <strong>Apache Tomcat</strong>. Решил понять
почему моё Java-приложение соединяется с базой, но при попытке загрузки
объекта через ORM из базы данных выпадает ошибка вида, что не может
найти мой класс <code class="code">
results.Cell</code>
; вот развёртка стека:</p>
<div class="highlight"><pre><span class="pgcss-n">org</span><span class="pgcss-o">.</span><span class="pgcss-na">hibernate</span><span class="pgcss-o">.</span><span class="pgcss-na">MappingException</span><span class="pgcss-o">:</span> <span class="pgcss-n">Unknown</span> <span class="pgcss-n">entity</span><span class="pgcss-o">:</span> <span class="pgcss-n">results</span><span class="pgcss-o">.</span><span class="pgcss-na">Cell</span>
 <span class="pgcss-n">at</span> <span class="pgcss-n">org</span><span class="pgcss-o">.</span><span class="pgcss-na">hibernate</span><span class="pgcss-o">.</span><span class="pgcss-na">impl</span><span class="pgcss-o">.</span><span class="pgcss-na">SessionFactoryImpl</span><span class="pgcss-o">.</span><span class="pgcss-na">getEntityPersister</span><span class="pgcss-o">(</span><span class="pgcss-n">SessionFactoryImpl</span><span class="pgcss-o">.</span><span class="pgcss-na">java</span><span class="pgcss-o">:</span><span class="pgcss-mi">628</span><span class="pgcss-o">)</span>
 <span class="pgcss-n">at</span> <span class="pgcss-n">org</span><span class="pgcss-o">.</span><span class="pgcss-na">hibernate</span><span class="pgcss-o">.</span><span class="pgcss-na">event</span><span class="pgcss-o">.</span><span class="pgcss-na">def</span><span class="pgcss-o">.</span><span class="pgcss-na">DefaultLoadEventListener</span><span class="pgcss-o">.</span><span class="pgcss-na">onLoad</span><span class="pgcss-o">(</span><span class="pgcss-n">DefaultLoadEventListener</span><span class="pgcss-o">.</span><span class="pgcss-na">java</span><span class="pgcss-o">:</span><span class="pgcss-mi">91</span><span class="pgcss-o">)</span>
 <span class="pgcss-n">at</span> <span class="pgcss-n">org</span><span class="pgcss-o">.</span><span class="pgcss-na">hibernate</span><span class="pgcss-o">.</span><span class="pgcss-na">impl</span><span class="pgcss-o">.</span><span class="pgcss-na">SessionImpl</span><span class="pgcss-o">.</span><span class="pgcss-na">fireLoad</span><span class="pgcss-o">(</span><span class="pgcss-n">SessionImpl</span><span class="pgcss-o">.</span><span class="pgcss-na">java</span><span class="pgcss-o">:</span><span class="pgcss-mi">906</span><span class="pgcss-o">)</span>
 <span class="pgcss-n">at</span> <span class="pgcss-n">org</span><span class="pgcss-o">.</span><span class="pgcss-na">hibernate</span><span class="pgcss-o">.</span><span class="pgcss-na">impl</span><span class="pgcss-o">.</span><span class="pgcss-na">SessionImpl</span><span class="pgcss-o">.</span><span class="pgcss-na">load</span><span class="pgcss-o">(</span><span class="pgcss-n">SessionImpl</span><span class="pgcss-o">.</span><span class="pgcss-na">java</span><span class="pgcss-o">:</span><span class="pgcss-mi">823</span><span class="pgcss-o">)</span>
 <span class="pgcss-n">at</span> <span class="pgcss-n">org</span><span class="pgcss-o">.</span><span class="pgcss-na">hibernate</span><span class="pgcss-o">.</span><span class="pgcss-na">impl</span><span class="pgcss-o">.</span><span class="pgcss-na">SessionImpl</span><span class="pgcss-o">.</span><span class="pgcss-na">load</span><span class="pgcss-o">(</span><span class="pgcss-n">SessionImpl</span><span class="pgcss-o">.</span><span class="pgcss-na">java</span><span class="pgcss-o">:</span><span class="pgcss-mi">816</span><span class="pgcss-o">)</span>
 <span class="pgcss-n">at</span> <span class="pgcss-n">sun</span><span class="pgcss-o">.</span><span class="pgcss-na">reflect</span><span class="pgcss-o">.</span><span class="pgcss-na">NativeMethodAccessorImpl</span><span class="pgcss-o">.</span><span class="pgcss-na">invoke0</span><span class="pgcss-o">(</span><span class="pgcss-n">Native</span> <span class="pgcss-n">Method</span><span class="pgcss-o">)</span>
 <span class="pgcss-n">at</span> <span class="pgcss-n">sun</span><span class="pgcss-o">.</span><span class="pgcss-na">reflect</span><span class="pgcss-o">.</span><span class="pgcss-na">NativeMethodAccessorImpl</span><span class="pgcss-o">.</span><span class="pgcss-na">invoke</span><span class="pgcss-o">(</span><span class="pgcss-n">NativeMethodAccessorImpl</span><span class="pgcss-o">.</span><span class="pgcss-na">java</span><span class="pgcss-o">:</span><span class="pgcss-mi">39</span><span class="pgcss-o">)</span>
 <span class="pgcss-n">at</span> <span class="pgcss-n">sun</span><span class="pgcss-o">.</span><span class="pgcss-na">reflect</span><span class="pgcss-o">.</span><span class="pgcss-na">DelegatingMethodAccessorImpl</span><span class="pgcss-o">.</span><span class="pgcss-na">invoke</span><span class="pgcss-o">(</span><span class="pgcss-n">DelegatingMethodAccessorImpl</span><span class="pgcss-o">.</span><span class="pgcss-na">java</span><span class="pgcss-o">:</span><span class="pgcss-mi">25</span><span class="pgcss-o">)</span>
 <span class="pgcss-n">at</span> <span class="pgcss-n">java</span><span class="pgcss-o">.</span><span class="pgcss-na">lang</span><span class="pgcss-o">.</span><span class="pgcss-na">reflect</span><span class="pgcss-o">.</span><span class="pgcss-na">Method</span><span class="pgcss-o">.</span><span class="pgcss-na">invoke</span><span class="pgcss-o">(</span><span class="pgcss-n">Method</span><span class="pgcss-o">.</span><span class="pgcss-na">java</span><span class="pgcss-o">:</span><span class="pgcss-mi">597</span><span class="pgcss-o">)</span>
 <span class="pgcss-n">at</span> <span class="pgcss-n">org</span><span class="pgcss-o">.</span><span class="pgcss-na">hibernate</span><span class="pgcss-o">.</span><span class="pgcss-na">context</span><span class="pgcss-o">.</span><span class="pgcss-na">ThreadLocalSessionContext$TransactionProtectionWrapper</span><span class="pgcss-o">.</span><span class="pgcss-na">invoke</span><span class="pgcss-o">(</span><span class="pgcss-n">ThreadLocalSessionContext</span><span class="pgcss-o">.</span><span class="pgcss-na">java</span><span class="pgcss-o">:</span><span class="pgcss-mi">342</span><span class="pgcss-o">)</span>
 <span class="pgcss-n">at</span> <span class="pgcss-n">$Proxy0</span><span class="pgcss-o">.</span><span class="pgcss-na">load</span><span class="pgcss-o">(</span><span class="pgcss-n">Unknown</span> <span class="pgcss-n">Source</span><span class="pgcss-o">)</span>
 <span class="pgcss-n">at</span> <span class="pgcss-n">org</span><span class="pgcss-o">.</span><span class="pgcss-na">apache</span><span class="pgcss-o">.</span><span class="pgcss-na">jsp</span><span class="pgcss-o">.</span><span class="pgcss-na">index_jsp</span><span class="pgcss-o">.</span><span class="pgcss-na">_jspService</span><span class="pgcss-o">(</span><span class="pgcss-n">index_jsp</span><span class="pgcss-o">.</span><span class="pgcss-na">java</span><span class="pgcss-o">:</span><span class="pgcss-mi">63</span><span class="pgcss-o">)</span>
 <span class="pgcss-n">at</span> <span class="pgcss-n">org</span><span class="pgcss-o">.</span><span class="pgcss-na">apache</span><span class="pgcss-o">.</span><span class="pgcss-na">jasper</span><span class="pgcss-o">.</span><span class="pgcss-na">runtime</span><span class="pgcss-o">.</span><span class="pgcss-na">HttpJspBase</span><span class="pgcss-o">.</span><span class="pgcss-na">service</span><span class="pgcss-o">(</span><span class="pgcss-n">HttpJspBase</span><span class="pgcss-o">.</span><span class="pgcss-na">java</span><span class="pgcss-o">:</span><span class="pgcss-mi">70</span><span class="pgcss-o">)</span>
 <span class="pgcss-n">at</span> <span class="pgcss-n">javax</span><span class="pgcss-o">.</span><span class="pgcss-na">servlet</span><span class="pgcss-o">.</span><span class="pgcss-na">http</span><span class="pgcss-o">.</span><span class="pgcss-na">HttpServlet</span><span class="pgcss-o">.</span><span class="pgcss-na">service</span><span class="pgcss-o">(</span><span class="pgcss-n">HttpServlet</span><span class="pgcss-o">.</span><span class="pgcss-na">java</span><span class="pgcss-o">:</span><span class="pgcss-mi">717</span><span class="pgcss-o">)</span>
 <span class="pgcss-n">at</span> <span class="pgcss-n">org</span><span class="pgcss-o">.</span><span class="pgcss-na">apache</span><span class="pgcss-o">.</span><span class="pgcss-na">jasper</span><span class="pgcss-o">.</span><span class="pgcss-na">servlet</span><span class="pgcss-o">.</span><span class="pgcss-na">JspServletWrapper</span><span class="pgcss-o">.</span><span class="pgcss-na">service</span><span class="pgcss-o">(</span><span class="pgcss-n">JspServletWrapper</span><span class="pgcss-o">.</span><span class="pgcss-na">java</span><span class="pgcss-o">:</span><span class="pgcss-mi">374</span><span class="pgcss-o">)</span>
 <span class="pgcss-n">at</span> <span class="pgcss-n">org</span><span class="pgcss-o">.</span><span class="pgcss-na">apache</span><span class="pgcss-o">.</span><span class="pgcss-na">jasper</span><span class="pgcss-o">.</span><span class="pgcss-na">servlet</span><span class="pgcss-o">.</span><span class="pgcss-na">JspServlet</span><span class="pgcss-o">.</span><span class="pgcss-na">serviceJspFile</span><span class="pgcss-o">(</span><span class="pgcss-n">JspServlet</span><span class="pgcss-o">.</span><span class="pgcss-na">java</span><span class="pgcss-o">:</span><span class="pgcss-mi">342</span><span class="pgcss-o">)</span>
 <span class="pgcss-n">at</span> <span class="pgcss-n">org</span><span class="pgcss-o">.</span><span class="pgcss-na">apache</span><span class="pgcss-o">.</span><span class="pgcss-na">jasper</span><span class="pgcss-o">.</span><span class="pgcss-na">servlet</span><span class="pgcss-o">.</span><span class="pgcss-na">JspServlet</span><span class="pgcss-o">.</span><span class="pgcss-na">service</span><span class="pgcss-o">(</span><span class="pgcss-n">JspServlet</span><span class="pgcss-o">.</span><span class="pgcss-na">java</span><span class="pgcss-o">:</span><span class="pgcss-mi">267</span><span class="pgcss-o">)</span>
 <span class="pgcss-n">at</span> <span class="pgcss-n">javax</span><span class="pgcss-o">.</span><span class="pgcss-na">servlet</span><span class="pgcss-o">.</span><span class="pgcss-na">http</span><span class="pgcss-o">.</span><span class="pgcss-na">HttpServlet</span><span class="pgcss-o">.</span><span class="pgcss-na">service</span><span class="pgcss-o">(</span><span class="pgcss-n">HttpServlet</span><span class="pgcss-o">.</span><span class="pgcss-na">java</span><span class="pgcss-o">:</span><span class="pgcss-mi">717</span><span class="pgcss-o">)</span>
 <span class="pgcss-n">at</span> <span class="pgcss-n">org</span><span class="pgcss-o">.</span><span class="pgcss-na">apache</span><span class="pgcss-o">.</span><span class="pgcss-na">catalina</span><span class="pgcss-o">.</span><span class="pgcss-na">core</span><span class="pgcss-o">.</span><span class="pgcss-na">ApplicationFilterChain</span><span class="pgcss-o">.</span><span class="pgcss-na">internalDoFilter</span><span class="pgcss-o">(</span><span class="pgcss-n">ApplicationFilterChain</span><span class="pgcss-o">.</span><span class="pgcss-na">java</span><span class="pgcss-o">:</span><span class="pgcss-mi">290</span><span class="pgcss-o">)</span>
 <span class="pgcss-n">at</span> <span class="pgcss-n">org</span><span class="pgcss-o">.</span><span class="pgcss-na">apache</span><span class="pgcss-o">.</span><span class="pgcss-na">catalina</span><span class="pgcss-o">.</span><span class="pgcss-na">core</span><span class="pgcss-o">.</span><span class="pgcss-na">ApplicationFilterChain</span><span class="pgcss-o">.</span><span class="pgcss-na">doFilter</span><span class="pgcss-o">(</span><span class="pgcss-n">ApplicationFilterChain</span><span class="pgcss-o">.</span><span class="pgcss-na">java</span><span class="pgcss-o">:</span><span class="pgcss-mi">206</span><span class="pgcss-o">)</span>
 <span class="pgcss-n">at</span> <span class="pgcss-n">org</span><span class="pgcss-o">.</span><span class="pgcss-na">apache</span><span class="pgcss-o">.</span><span class="pgcss-na">catalina</span><span class="pgcss-o">.</span><span class="pgcss-na">core</span><span class="pgcss-o">.</span><span class="pgcss-na">StandardWrapperValve</span><span class="pgcss-o">.</span><span class="pgcss-na">invoke</span><span class="pgcss-o">(</span><span class="pgcss-n">StandardWrapperValve</span><span class="pgcss-o">.</span><span class="pgcss-na">java</span><span class="pgcss-o">:</span><span class="pgcss-mi">233</span><span class="pgcss-o">)</span>
 <span class="pgcss-n">at</span> <span class="pgcss-n">org</span><span class="pgcss-o">.</span><span class="pgcss-na">apache</span><span class="pgcss-o">.</span><span class="pgcss-na">catalina</span><span class="pgcss-o">.</span><span class="pgcss-na">core</span><span class="pgcss-o">.</span><span class="pgcss-na">StandardContextValve</span><span class="pgcss-o">.</span><span class="pgcss-na">invoke</span><span class="pgcss-o">(</span><span class="pgcss-n">StandardContextValve</span><span class="pgcss-o">.</span><span class="pgcss-na">java</span><span class="pgcss-o">:</span><span class="pgcss-mi">191</span><span class="pgcss-o">)</span>
 <span class="pgcss-n">at</span> <span class="pgcss-n">org</span><span class="pgcss-o">.</span><span class="pgcss-na">apache</span><span class="pgcss-o">.</span><span class="pgcss-na">catalina</span><span class="pgcss-o">.</span><span class="pgcss-na">core</span><span class="pgcss-o">.</span><span class="pgcss-na">StandardHostValve</span><span class="pgcss-o">.</span><span class="pgcss-na">invoke</span><span class="pgcss-o">(</span><span class="pgcss-n">StandardHostValve</span><span class="pgcss-o">.</span><span class="pgcss-na">java</span><span class="pgcss-o">:</span><span class="pgcss-mi">128</span><span class="pgcss-o">)</span>
 <span class="pgcss-n">at</span> <span class="pgcss-n">org</span><span class="pgcss-o">.</span><span class="pgcss-na">apache</span><span class="pgcss-o">.</span><span class="pgcss-na">catalina</span><span class="pgcss-o">.</span><span class="pgcss-na">valves</span><span class="pgcss-o">.</span><span class="pgcss-na">ErrorReportValve</span><span class="pgcss-o">.</span><span class="pgcss-na">invoke</span><span class="pgcss-o">(</span><span class="pgcss-n">ErrorReportValve</span><span class="pgcss-o">.</span><span class="pgcss-na">java</span><span class="pgcss-o">:</span><span class="pgcss-mi">102</span><span class="pgcss-o">)</span>
 <span class="pgcss-n">at</span> <span class="pgcss-n">org</span><span class="pgcss-o">.</span><span class="pgcss-na">apache</span><span class="pgcss-o">.</span><span class="pgcss-na">catalina</span><span class="pgcss-o">.</span><span class="pgcss-na">core</span><span class="pgcss-o">.</span><span class="pgcss-na">StandardEngineValve</span><span class="pgcss-o">.</span><span class="pgcss-na">invoke</span><span class="pgcss-o">(</span><span class="pgcss-n">StandardEngineValve</span><span class="pgcss-o">.</span><span class="pgcss-na">java</span><span class="pgcss-o">:</span><span class="pgcss-mi">109</span><span class="pgcss-o">)</span>
 <span class="pgcss-n">at</span> <span class="pgcss-n">org</span><span class="pgcss-o">.</span><span class="pgcss-na">apache</span><span class="pgcss-o">.</span><span class="pgcss-na">catalina</span><span class="pgcss-o">.</span><span class="pgcss-na">connector</span><span class="pgcss-o">.</span><span class="pgcss-na">CoyoteAdapter</span><span class="pgcss-o">.</span><span class="pgcss-na">service</span><span class="pgcss-o">(</span><span class="pgcss-n">CoyoteAdapter</span><span class="pgcss-o">.</span><span class="pgcss-na">java</span><span class="pgcss-o">:</span><span class="pgcss-mi">293</span><span class="pgcss-o">)</span>
 <span class="pgcss-n">at</span> <span class="pgcss-n">org</span><span class="pgcss-o">.</span><span class="pgcss-na">apache</span><span class="pgcss-o">.</span><span class="pgcss-na">coyote</span><span class="pgcss-o">.</span><span class="pgcss-na">http11</span><span class="pgcss-o">.</span><span class="pgcss-na">Http11Processor</span><span class="pgcss-o">.</span><span class="pgcss-na">process</span><span class="pgcss-o">(</span><span class="pgcss-n">Http11Processor</span><span class="pgcss-o">.</span><span class="pgcss-na">java</span><span class="pgcss-o">:</span><span class="pgcss-mi">849</span><span class="pgcss-o">)</span>
 <span class="pgcss-n">at</span> <span class="pgcss-n">org</span><span class="pgcss-o">.</span><span class="pgcss-na">apache</span><span class="pgcss-o">.</span><span class="pgcss-na">coyote</span><span class="pgcss-o">.</span><span class="pgcss-na">http11</span><span class="pgcss-o">.</span><span class="pgcss-na">Http11Protocol$Http11ConnectionHandler</span><span class="pgcss-o">.</span><span class="pgcss-na">process</span><span class="pgcss-o">(</span><span class="pgcss-n">Http11Protocol</span><span class="pgcss-o">.</span><span class="pgcss-na">java</span><span class="pgcss-o">:</span><span class="pgcss-mi">583</span><span class="pgcss-o">)</span>
 <span class="pgcss-n">at</span> <span class="pgcss-n">org</span><span class="pgcss-o">.</span><span class="pgcss-na">apache</span><span class="pgcss-o">.</span><span class="pgcss-na">tomcat</span><span class="pgcss-o">.</span><span class="pgcss-na">util</span><span class="pgcss-o">.</span><span class="pgcss-na">net</span><span class="pgcss-o">.</span><span class="pgcss-na">JIoEndpoint$Worker</span><span class="pgcss-o">.</span><span class="pgcss-na">run</span><span class="pgcss-o">(</span><span class="pgcss-n">JIoEndpoint</span><span class="pgcss-o">.</span><span class="pgcss-na">java</span><span class="pgcss-o">:</span><span class="pgcss-mi">454</span><span class="pgcss-o">)</span>
 <span class="pgcss-n">at</span> <span class="pgcss-n">java</span><span class="pgcss-o">.</span><span class="pgcss-na">lang</span><span class="pgcss-o">.</span><span class="pgcss-na">Thread</span><span class="pgcss-o">.</span><span class="pgcss-na">run</span><span class="pgcss-o">(</span><span class="pgcss-n">Thread</span><span class="pgcss-o">.</span><span class="pgcss-na">java</span><span class="pgcss-o">:</span><span class="pgcss-mi">619</span><span class="pgcss-o">)</span>
</pre></div>
<p class="cut"><a class="h-link reference internal" href="#cut_57979920"data-toggle="collapse">а что было дальше?</a></p>
<div class="collapse" id="cut_57979920">
<p>Класс Cell у меня очень простой и лежит как и положено в classes в
пакете results. Единственное, что маппинг сделан не через XML, а через
аннотации Java. Т.к. я не хотел делать через XML, то решил посмотреть,
где выпадает это исключение (благо у меня есть исходники Hibernate).
Нашёл эту строчку и понял, что всё дело в отсутсвии описания класса в
XML-файле. Я не мог понять как же его описать, если в
<strong>hibernate.cfg.xml</strong> описываются только ссылки на XML-мэппинги. Но
погуглив и почитав документацию, я обратил внимание, что можно вместо
названия XML-файла указывать название класса и Hibernate сам разберётся,
что к чему. Поэтому я добавил строку между <code class="code">
&lt;session-factory&gt;</code>
 и
<code class="code">
&lt;/session-factory&gt;</code>
:</p>
<div class="highlight"><pre><span class="pgcss-nt">&lt;mapping</span> <span class="pgcss-na">class=</span><span class="pgcss-s">&quot;results.Cell&quot;</span><span class="pgcss-nt">&gt;</span>
</pre></div>
<p>И всё почти заработало :). Только вот выпала снова ошибка, что оно не
может произвести мэппинг класса:</p>
<div class="highlight"><pre><span class="pgcss-n">org</span><span class="pgcss-o">.</span><span class="pgcss-na">hibernate</span><span class="pgcss-o">.</span><span class="pgcss-na">MappingException</span><span class="pgcss-o">:</span> <span class="pgcss-n">An</span> <span class="pgcss-n">AnnotationConfiguration</span> <span class="pgcss-n">instance</span> <span class="pgcss-n">is</span> <span class="pgcss-n">required</span> <span class="pgcss-n">to</span> <span class="pgcss-n">use</span> <span class="pgcss-o">&lt;</span><span class="pgcss-n">mapping</span> <span class="pgcss-n">class</span><span class="pgcss-o">=</span><span class="pgcss-s">&quot;results.Cell&quot;</span><span class="pgcss-o">/&gt;</span>
 <span class="pgcss-n">at</span> <span class="pgcss-n">org</span><span class="pgcss-o">.</span><span class="pgcss-na">hibernate</span><span class="pgcss-o">.</span><span class="pgcss-na">cfg</span><span class="pgcss-o">.</span><span class="pgcss-na">Configuration</span><span class="pgcss-o">.</span><span class="pgcss-na">parseMappingElement</span><span class="pgcss-o">(</span><span class="pgcss-n">Configuration</span><span class="pgcss-o">.</span><span class="pgcss-na">java</span><span class="pgcss-o">:</span><span class="pgcss-mi">1648</span><span class="pgcss-o">)</span>
 <span class="pgcss-n">at</span> <span class="pgcss-n">org</span><span class="pgcss-o">.</span><span class="pgcss-na">hibernate</span><span class="pgcss-o">.</span><span class="pgcss-na">cfg</span><span class="pgcss-o">.</span><span class="pgcss-na">Configuration</span><span class="pgcss-o">.</span><span class="pgcss-na">parseSessionFactory</span><span class="pgcss-o">(</span><span class="pgcss-n">Configuration</span><span class="pgcss-o">.</span><span class="pgcss-na">java</span><span class="pgcss-o">:</span><span class="pgcss-mi">1603</span><span class="pgcss-o">)</span>
 <span class="pgcss-n">at</span> <span class="pgcss-n">org</span><span class="pgcss-o">.</span><span class="pgcss-na">hibernate</span><span class="pgcss-o">.</span><span class="pgcss-na">cfg</span><span class="pgcss-o">.</span><span class="pgcss-na">Configuration</span><span class="pgcss-o">.</span><span class="pgcss-na">doConfigure</span><span class="pgcss-o">(</span><span class="pgcss-n">Configuration</span><span class="pgcss-o">.</span><span class="pgcss-na">java</span><span class="pgcss-o">:</span><span class="pgcss-mi">1582</span><span class="pgcss-o">)</span>
 <span class="pgcss-n">at</span> <span class="pgcss-n">org</span><span class="pgcss-o">.</span><span class="pgcss-na">hibernate</span><span class="pgcss-o">.</span><span class="pgcss-na">cfg</span><span class="pgcss-o">.</span><span class="pgcss-na">Configuration</span><span class="pgcss-o">.</span><span class="pgcss-na">doConfigure</span><span class="pgcss-o">(</span><span class="pgcss-n">Configuration</span><span class="pgcss-o">.</span><span class="pgcss-na">java</span><span class="pgcss-o">:</span><span class="pgcss-mi">1556</span><span class="pgcss-o">)</span>
 <span class="pgcss-n">at</span> <span class="pgcss-n">org</span><span class="pgcss-o">.</span><span class="pgcss-na">hibernate</span><span class="pgcss-o">.</span><span class="pgcss-na">cfg</span><span class="pgcss-o">.</span><span class="pgcss-na">Configuration</span><span class="pgcss-o">.</span><span class="pgcss-na">configure</span><span class="pgcss-o">(</span><span class="pgcss-n">Configuration</span><span class="pgcss-o">.</span><span class="pgcss-na">java</span><span class="pgcss-o">:</span><span class="pgcss-mi">1476</span><span class="pgcss-o">)</span>
 <span class="pgcss-n">at</span> <span class="pgcss-n">org</span><span class="pgcss-o">.</span><span class="pgcss-na">hibernate</span><span class="pgcss-o">.</span><span class="pgcss-na">cfg</span><span class="pgcss-o">.</span><span class="pgcss-na">Configuration</span><span class="pgcss-o">.</span><span class="pgcss-na">configure</span><span class="pgcss-o">(</span><span class="pgcss-n">Configuration</span><span class="pgcss-o">.</span><span class="pgcss-na">java</span><span class="pgcss-o">:</span><span class="pgcss-mi">1462</span><span class="pgcss-o">)</span>
 <span class="pgcss-n">at</span> <span class="pgcss-n">org</span><span class="pgcss-o">.</span><span class="pgcss-na">apache</span><span class="pgcss-o">.</span><span class="pgcss-na">jsp</span><span class="pgcss-o">.</span><span class="pgcss-na">index_jsp</span><span class="pgcss-o">.</span><span class="pgcss-na">_jspService</span><span class="pgcss-o">(</span><span class="pgcss-n">index_jsp</span><span class="pgcss-o">.</span><span class="pgcss-na">java</span><span class="pgcss-o">:</span><span class="pgcss-mi">64</span><span class="pgcss-o">)</span>
 <span class="pgcss-n">at</span> <span class="pgcss-n">org</span><span class="pgcss-o">.</span><span class="pgcss-na">apache</span><span class="pgcss-o">.</span><span class="pgcss-na">jasper</span><span class="pgcss-o">.</span><span class="pgcss-na">runtime</span><span class="pgcss-o">.</span><span class="pgcss-na">HttpJspBase</span><span class="pgcss-o">.</span><span class="pgcss-na">service</span><span class="pgcss-o">(</span><span class="pgcss-n">HttpJspBase</span><span class="pgcss-o">.</span><span class="pgcss-na">java</span><span class="pgcss-o">:</span><span class="pgcss-mi">70</span><span class="pgcss-o">)</span>
 <span class="pgcss-n">at</span> <span class="pgcss-n">javax</span><span class="pgcss-o">.</span><span class="pgcss-na">servlet</span><span class="pgcss-o">.</span><span class="pgcss-na">http</span><span class="pgcss-o">.</span><span class="pgcss-na">HttpServlet</span><span class="pgcss-o">.</span><span class="pgcss-na">service</span><span class="pgcss-o">(</span><span class="pgcss-n">HttpServlet</span><span class="pgcss-o">.</span><span class="pgcss-na">java</span><span class="pgcss-o">:</span><span class="pgcss-mi">717</span><span class="pgcss-o">)</span>
 <span class="pgcss-n">at</span> <span class="pgcss-n">org</span><span class="pgcss-o">.</span><span class="pgcss-na">apache</span><span class="pgcss-o">.</span><span class="pgcss-na">jasper</span><span class="pgcss-o">.</span><span class="pgcss-na">servlet</span><span class="pgcss-o">.</span><span class="pgcss-na">JspServletWrapper</span><span class="pgcss-o">.</span><span class="pgcss-na">service</span><span class="pgcss-o">(</span><span class="pgcss-n">JspServletWrapper</span><span class="pgcss-o">.</span><span class="pgcss-na">java</span><span class="pgcss-o">:</span><span class="pgcss-mi">374</span><span class="pgcss-o">)</span>
 <span class="pgcss-n">at</span> <span class="pgcss-n">org</span><span class="pgcss-o">.</span><span class="pgcss-na">apache</span><span class="pgcss-o">.</span><span class="pgcss-na">jasper</span><span class="pgcss-o">.</span><span class="pgcss-na">servlet</span><span class="pgcss-o">.</span><span class="pgcss-na">JspServlet</span><span class="pgcss-o">.</span><span class="pgcss-na">serviceJspFile</span><span class="pgcss-o">(</span><span class="pgcss-n">JspServlet</span><span class="pgcss-o">.</span><span class="pgcss-na">java</span><span class="pgcss-o">:</span><span class="pgcss-mi">342</span><span class="pgcss-o">)</span>
 <span class="pgcss-n">at</span> <span class="pgcss-n">org</span><span class="pgcss-o">.</span><span class="pgcss-na">apache</span><span class="pgcss-o">.</span><span class="pgcss-na">jasper</span><span class="pgcss-o">.</span><span class="pgcss-na">servlet</span><span class="pgcss-o">.</span><span class="pgcss-na">JspServlet</span><span class="pgcss-o">.</span><span class="pgcss-na">service</span><span class="pgcss-o">(</span><span class="pgcss-n">JspServlet</span><span class="pgcss-o">.</span><span class="pgcss-na">java</span><span class="pgcss-o">:</span><span class="pgcss-mi">267</span><span class="pgcss-o">)</span>
 <span class="pgcss-n">at</span> <span class="pgcss-n">javax</span><span class="pgcss-o">.</span><span class="pgcss-na">servlet</span><span class="pgcss-o">.</span><span class="pgcss-na">http</span><span class="pgcss-o">.</span><span class="pgcss-na">HttpServlet</span><span class="pgcss-o">.</span><span class="pgcss-na">service</span><span class="pgcss-o">(</span><span class="pgcss-n">HttpServlet</span><span class="pgcss-o">.</span><span class="pgcss-na">java</span><span class="pgcss-o">:</span><span class="pgcss-mi">717</span><span class="pgcss-o">)</span>
 <span class="pgcss-n">at</span> <span class="pgcss-n">org</span><span class="pgcss-o">.</span><span class="pgcss-na">apache</span><span class="pgcss-o">.</span><span class="pgcss-na">catalina</span><span class="pgcss-o">.</span><span class="pgcss-na">core</span><span class="pgcss-o">.</span><span class="pgcss-na">ApplicationFilterChain</span><span class="pgcss-o">.</span><span class="pgcss-na">internalDoFilter</span><span class="pgcss-o">(</span><span class="pgcss-n">ApplicationFilterChain</span><span class="pgcss-o">.</span><span class="pgcss-na">java</span><span class="pgcss-o">:</span><span class="pgcss-mi">290</span><span class="pgcss-o">)</span>
 <span class="pgcss-n">at</span> <span class="pgcss-n">org</span><span class="pgcss-o">.</span><span class="pgcss-na">apache</span><span class="pgcss-o">.</span><span class="pgcss-na">catalina</span><span class="pgcss-o">.</span><span class="pgcss-na">core</span><span class="pgcss-o">.</span><span class="pgcss-na">ApplicationFilterChain</span><span class="pgcss-o">.</span><span class="pgcss-na">doFilter</span><span class="pgcss-o">(</span><span class="pgcss-n">ApplicationFilterChain</span><span class="pgcss-o">.</span><span class="pgcss-na">java</span><span class="pgcss-o">:</span><span class="pgcss-mi">206</span><span class="pgcss-o">)</span>
 <span class="pgcss-n">at</span> <span class="pgcss-n">org</span><span class="pgcss-o">.</span><span class="pgcss-na">apache</span><span class="pgcss-o">.</span><span class="pgcss-na">catalina</span><span class="pgcss-o">.</span><span class="pgcss-na">core</span><span class="pgcss-o">.</span><span class="pgcss-na">StandardWrapperValve</span><span class="pgcss-o">.</span><span class="pgcss-na">invoke</span><span class="pgcss-o">(</span><span class="pgcss-n">StandardWrapperValve</span><span class="pgcss-o">.</span><span class="pgcss-na">java</span><span class="pgcss-o">:</span><span class="pgcss-mi">233</span><span class="pgcss-o">)</span>
 <span class="pgcss-n">at</span> <span class="pgcss-n">org</span><span class="pgcss-o">.</span><span class="pgcss-na">apache</span><span class="pgcss-o">.</span><span class="pgcss-na">catalina</span><span class="pgcss-o">.</span><span class="pgcss-na">core</span><span class="pgcss-o">.</span><span class="pgcss-na">StandardContextValve</span><span class="pgcss-o">.</span><span class="pgcss-na">invoke</span><span class="pgcss-o">(</span><span class="pgcss-n">StandardContextValve</span><span class="pgcss-o">.</span><span class="pgcss-na">java</span><span class="pgcss-o">:</span><span class="pgcss-mi">191</span><span class="pgcss-o">)</span>
 <span class="pgcss-n">at</span> <span class="pgcss-n">org</span><span class="pgcss-o">.</span><span class="pgcss-na">apache</span><span class="pgcss-o">.</span><span class="pgcss-na">catalina</span><span class="pgcss-o">.</span><span class="pgcss-na">core</span><span class="pgcss-o">.</span><span class="pgcss-na">StandardHostValve</span><span class="pgcss-o">.</span><span class="pgcss-na">invoke</span><span class="pgcss-o">(</span><span class="pgcss-n">StandardHostValve</span><span class="pgcss-o">.</span><span class="pgcss-na">java</span><span class="pgcss-o">:</span><span class="pgcss-mi">128</span><span class="pgcss-o">)</span>
 <span class="pgcss-n">at</span> <span class="pgcss-n">org</span><span class="pgcss-o">.</span><span class="pgcss-na">apache</span><span class="pgcss-o">.</span><span class="pgcss-na">catalina</span><span class="pgcss-o">.</span><span class="pgcss-na">valves</span><span class="pgcss-o">.</span><span class="pgcss-na">ErrorReportValve</span><span class="pgcss-o">.</span><span class="pgcss-na">invoke</span><span class="pgcss-o">(</span><span class="pgcss-n">ErrorReportValve</span><span class="pgcss-o">.</span><span class="pgcss-na">java</span><span class="pgcss-o">:</span><span class="pgcss-mi">102</span><span class="pgcss-o">)</span>
 <span class="pgcss-n">at</span> <span class="pgcss-n">org</span><span class="pgcss-o">.</span><span class="pgcss-na">apache</span><span class="pgcss-o">.</span><span class="pgcss-na">catalina</span><span class="pgcss-o">.</span><span class="pgcss-na">core</span><span class="pgcss-o">.</span><span class="pgcss-na">StandardEngineValve</span><span class="pgcss-o">.</span><span class="pgcss-na">invoke</span><span class="pgcss-o">(</span><span class="pgcss-n">StandardEngineValve</span><span class="pgcss-o">.</span><span class="pgcss-na">java</span><span class="pgcss-o">:</span><span class="pgcss-mi">109</span><span class="pgcss-o">)</span>
 <span class="pgcss-n">at</span> <span class="pgcss-n">org</span><span class="pgcss-o">.</span><span class="pgcss-na">apache</span><span class="pgcss-o">.</span><span class="pgcss-na">catalina</span><span class="pgcss-o">.</span><span class="pgcss-na">connector</span><span class="pgcss-o">.</span><span class="pgcss-na">CoyoteAdapter</span><span class="pgcss-o">.</span><span class="pgcss-na">service</span><span class="pgcss-o">(</span><span class="pgcss-n">CoyoteAdapter</span><span class="pgcss-o">.</span><span class="pgcss-na">java</span><span class="pgcss-o">:</span><span class="pgcss-mi">293</span><span class="pgcss-o">)</span>
 <span class="pgcss-n">at</span> <span class="pgcss-n">org</span><span class="pgcss-o">.</span><span class="pgcss-na">apache</span><span class="pgcss-o">.</span><span class="pgcss-na">coyote</span><span class="pgcss-o">.</span><span class="pgcss-na">http11</span><span class="pgcss-o">.</span><span class="pgcss-na">Http11Processor</span><span class="pgcss-o">.</span><span class="pgcss-na">process</span><span class="pgcss-o">(</span><span class="pgcss-n">Http11Processor</span><span class="pgcss-o">.</span><span class="pgcss-na">java</span><span class="pgcss-o">:</span><span class="pgcss-mi">849</span><span class="pgcss-o">)</span>
 <span class="pgcss-n">at</span> <span class="pgcss-n">org</span><span class="pgcss-o">.</span><span class="pgcss-na">apache</span><span class="pgcss-o">.</span><span class="pgcss-na">coyote</span><span class="pgcss-o">.</span><span class="pgcss-na">http11</span><span class="pgcss-o">.</span><span class="pgcss-na">Http11Protocol$Http11ConnectionHandler</span><span class="pgcss-o">.</span><span class="pgcss-na">process</span><span class="pgcss-o">(</span><span class="pgcss-n">Http11Protocol</span><span class="pgcss-o">.</span><span class="pgcss-na">java</span><span class="pgcss-o">:</span><span class="pgcss-mi">583</span><span class="pgcss-o">)</span>
 <span class="pgcss-n">at</span> <span class="pgcss-n">org</span><span class="pgcss-o">.</span><span class="pgcss-na">apache</span><span class="pgcss-o">.</span><span class="pgcss-na">tomcat</span><span class="pgcss-o">.</span><span class="pgcss-na">util</span><span class="pgcss-o">.</span><span class="pgcss-na">net</span><span class="pgcss-o">.</span><span class="pgcss-na">JIoEndpoint$Worker</span><span class="pgcss-o">.</span><span class="pgcss-na">run</span><span class="pgcss-o">(</span><span class="pgcss-n">JIoEndpoint</span><span class="pgcss-o">.</span><span class="pgcss-na">java</span><span class="pgcss-o">:</span><span class="pgcss-mi">454</span><span class="pgcss-o">)</span>
 <span class="pgcss-n">at</span> <span class="pgcss-n">java</span><span class="pgcss-o">.</span><span class="pgcss-na">lang</span><span class="pgcss-o">.</span><span class="pgcss-na">Thread</span><span class="pgcss-o">.</span><span class="pgcss-na">run</span><span class="pgcss-o">(</span><span class="pgcss-n">Thread</span><span class="pgcss-o">.</span><span class="pgcss-na">java</span><span class="pgcss-o">:</span><span class="pgcss-mi">619</span><span class="pgcss-o">)</span>
</pre></div>
<p>И снова я заглянул в код функции <code class="code">
parseMappingElement</code>
. И что же я
увидел? Увидел то, что эта функция ничего не умеет кроме, как вызывать
throw и гадить выбрасывать исключения. Тут-то до меня и дошло, что я
создаю объект класса Configuration, а нужно AnnotationConfiguration (о
чём оно мне гордо заявляло), потому что Configuration - это что-то типа
базового «класса-пустышки». Поэтому я сделал:</p>
<div class="highlight"><pre><span class="pgcss-c1">// было:</span>
<span class="pgcss-n">SessionFactory</span> <span class="pgcss-n">sess</span> <span class="pgcss-o">=</span> <span class="pgcss-k">new</span> <span class="pgcss-nf">AnnotationConfiguration</span><span class="pgcss-o">().</span><span class="pgcss-na">configure</span><span class="pgcss-o">().</span><span class="pgcss-na">buildSessionFactory</span><span class="pgcss-o">();</span>
<span class="pgcss-c1">// стало:</span>
<span class="pgcss-n"><strong>SessionFactory</span> <span class="pgcss-n">sess</span> <span class="pgcss-o">=</span> <span class="pgcss-k">new</span> <span class="pgcss-nf">Configuration</span><span class="pgcss-o">().</span><span class="pgcss-na">configure</span><span class="pgcss-o">().</span><span class="pgcss-na">buildSessionFactory</span><span class="pgcss-o">();</span><span class="pgcss-n">$$</span><span class="pgcss-o">/</span><span class="pgcss-n">strong$$</span>
</pre></div>
<p>После чего мой код заработал :) и я возрадовался.</p>
</div>
                </div>
            </div>
            <div class="row comments-row">
                <span><a class="pseudo-link b-candy b-comment-shortcut"><i class="b-ico"></i>ответить</a></span>
            </div>
        </div>
    </div>
</div><div class="panel panel-text">
    <div class="panel-heading b-post-type b-post-type-text">
        <b class="b-user">
            <a class="b-user__link" href="http://imdagger.github.io/author/imdagger.html"><b class="b-user__first-letter">I</b>MDagger</a>
        </b>
написал        <span class="pull-right b-date">
            <a class="h-link" href="http://imdagger.github.io/posts/2009/09/15/ru_comicstrip/" >
                15 сентября 2009 года, 16:16
            </a>
        </span>
    </div>
    <div class="panel-body">
        <div class="col-sm-1 b-post__layout-left">
            <a href="http://imdagger.github.io/author/imdagger.html"><img src="http://upics.yandex.ru/22199227/middle"></a>
        </div>
        <div class="col-sm-11 b-right-col">
            <noindex>
<div class="row tags-row">
    <span class="tag"><a rel="nofollow" class="h-link" href="http://imdagger.github.io/tag/komiksy.html">комиксы</a></span></div>
            </noindex>
            <div class="post-title">
<a class="no-link" href="http://imdagger.github.io/posts/2009/09/15/ru_comicstrip/">ru_comicstrip</a>            </div>
            <div class="row post-body">
                <div class="b-text">
<p>Понравился переведённый комикс <strong>x-D</strong></p>
<p><img alt="image0" src="http://media.trafficgods.ws/c/1555492274/09-08-07.gif" title="image0"/></p>
<p>оригинал перевода
<a class="reference external" href="http://community.livejournal.com/ru_comicstrip/469410.html">здесь</a></p>                </div>
            </div>
            <div class="row comments-row">
                <span><a class="pseudo-link b-candy b-comment-shortcut"><i class="b-ico"></i>ответить</a></span>
            </div>
        </div>
    </div>
</div><div class="panel panel-text">
    <div class="panel-heading b-post-type b-post-type-text">
        <b class="b-user">
            <a class="b-user__link" href="http://imdagger.github.io/author/imdagger.html"><b class="b-user__first-letter">I</b>MDagger</a>
        </b>
написал        <span class="pull-right b-date">
            <a class="h-link" href="http://imdagger.github.io/posts/2009/09/15/moi-otvet/" >
                15 сентября 2009 года, 07:25
            </a>
        </span>
    </div>
    <div class="panel-body">
        <div class="col-sm-1 b-post__layout-left">
            <a href="http://imdagger.github.io/author/imdagger.html"><img src="http://upics.yandex.ru/22199227/middle"></a>
        </div>
        <div class="col-sm-11 b-right-col">
            <noindex>
<div class="row tags-row">
    <span class="tag"><a rel="nofollow" class="h-link" href="http://imdagger.github.io/tag/rasskaz.html">рассказ</a></span>,    <span class="tag"><a rel="nofollow" class="h-link" href="http://imdagger.github.io/tag/otvet.html">ответ</a></span>,    <span class="tag"><a rel="nofollow" class="h-link" href="http://imdagger.github.io/tag/bredni.html">бредни</a></span></div>
            </noindex>
            <div class="post-title">
<a class="no-link" href="http://imdagger.github.io/posts/2009/09/15/moi-otvet/">Мой ответ</a>            </div>
            <div class="row post-body">
                <div class="b-text">
<p>Я ж сказал, что напишу зарисовку, где он чего-нибудь отчебучит. Вот
дружеский шарж на
<a class="reference external" href="http://loukat.ya.ru/replies.xml?item_no=56">запись</a> от <a class="reference external" href="http://loukat.ya.ru/">Леська Lou~kat(ze)</a>:</p>
<div class="alert  alert-danger compound">
<p><strong>Внимание!</strong> Следующий текст является просто троллингом созданным по мотивам
другого текста, но может всё равно вызывать повреждения мозга.</p>
</div>
<p>Она стояла одиноко на остановке, ждала последний автобус. Ветер
завывал, словно злобное создание насмехается рядом над её горем. В
пальцах слегка покалывало, и снежинки медленно опадали у умирали на её
руках. Но ей было уже всё равно потому, что больше никто не понимает её
в этом мире. Только одна мысль пронзала голову, как тысяча иголок:
«Зачем? зачем?…». Иногда она тихо угасала и казалось, что она не где-то
тут, тут… на этой заброшенной остановке, где старая обветшалая лавочка,
где деревья, которые видели тысячу печальных и счастливых лиц. И вот..
вот… ещё одно… но оно не печальное, оно .. просто остывшее, будто это не
снег падает на него, ложится на ресницы, губы; а может весь этот холод и
вьюга исходят из её стеклянных глаз?</p>
<p>Но когда сознание вновь возвращалось, то она вспоминала, как им было
хорошо, что он был таким нежным. Но вдруг загоралась искорка ярости и
растапливала снежинки на руках: «Зачем?! зачем он это сделал?». Теперь
ей казалось, что этот мир жесток и несправедлив, а она готова его
разрушить. Но лунное сияние возвращало спокойствие в душу, охлаждало, и
она была похожа на снежную королеву. И приходили другие, печальные
мысли… апатия, полная апатия, ей ничего не нужно, ведь всё, что она
могла отдать ему — она отдала. Самое дорогое, что было, протянула в
тогда ещё тёплых ладонях, она отдала ему сердце! Такое горячее, которое
согрело бы их двоих, но … он предпочёл другое:</p>
<p>«Как он мог? Съесть моё сердце!! Изверг…», — думала она.</p>
<p>А он в этот момент наслаждался ароматом жареного мяса, вкусом
подливки. А может он был просто жестоким коллекционером сердец? И это
пополнило его меню?</p>
<p><strong>От меня:</strong> «Да-да-да и ещё раз да!!! Я же обещал шарж про
поедателя сердец и жестокого коллекционера x-D, раз кто-то в своём блоге
не захотел добавить мои правки из комментариев, а ещё выдвинул
претензии, мол “сам пиши, раз такой умный”, то вот нате… кушать подано,
садитесь жрать :)».</p>
                </div>
            </div>
            <div class="row comments-row">
                <span><a class="pseudo-link b-candy b-comment-shortcut"><i class="b-ico"></i>ответить</a></span>
            </div>
        </div>
    </div>
</div><div class="panel panel-text">
    <div class="panel-heading b-post-type b-post-type-text">
        <b class="b-user">
            <a class="b-user__link" href="http://imdagger.github.io/author/imdagger.html"><b class="b-user__first-letter">I</b>MDagger</a>
        </b>
написал        <span class="pull-right b-date">
            <a class="h-link" href="http://imdagger.github.io/posts/2009/09/14/emacs-i-uvedomleniia-v-tree/" >
                14 сентября 2009 года, 18:06
            </a>
        </span>
    </div>
    <div class="panel-body">
        <div class="col-sm-1 b-post__layout-left">
            <a href="http://imdagger.github.io/author/imdagger.html"><img src="http://upics.yandex.ru/22199227/middle"></a>
        </div>
        <div class="col-sm-11 b-right-col">
            <noindex>
<div class="row tags-row">
    <span class="tag"><a rel="nofollow" class="h-link" href="http://imdagger.github.io/tag/emacs.html">emacs</a></span>,    <span class="tag"><a rel="nofollow" class="h-link" href="http://imdagger.github.io/tag/trei.html">трей</a></span></div>
            </noindex>
            <div class="post-title">
<a class="no-link" href="http://imdagger.github.io/posts/2009/09/14/emacs-i-uvedomleniia-v-tree/">Emacs и уведомления в трее</a>            </div>
            <div class="row post-body">
                <div class="b-text">
<p>Т.к. <strong>Emacs</strong> не поддерживает загрузку динамических библиотек (а
оно ему и не нужно), то иконку в трее и изменение её статуса будет
отображать отдельное небольшое приложение, которое соединяется пайпами с
Emacs. Я модифицировал существующее такое приложение (описывал его
раньше),
<a class="reference external" href="https://yadi.sk/d/lAg5SLN8UmdLG">tray_daemon.c</a> - это
версия, которая умеет:</p>
<ul class="simple">
<li>Отложенное создание иконки (полезно, если иконка нужна только по
время соединения)</li>
<li>Скрытие/показ и мерцание в трее</li>
<li>Установка изображения иконки (чтобы можно было передавать из файла
конфигурации Emacs’а, а не была вшита намертво)</li>
<li>Уничтожение иконки</li>
<li>Возможность отдельной иконки для каждого процесса Emacs, или
множество различных иконок для одного процесса Emacs, т.к. работает
через пайпы и только со своим родительским процессом</li>
</ul>
<p>Вот так оно выглядит:</p>
<p><a class="reference external" href="http://fotki.yandex.ru/users/imdagger/view/80430/"><img alt="Панель" src="http://img-fotki.yandex.ru/get/3707/imdagger.3/0_13a2e_da2dfe6b_L" title="Панель"/></a></p>
<p class="cut"><a class="h-link reference internal" data-toggle="collapse" href="#cut_54509072">дальше много текста и пояснений</a></p>
<div class="collapse" id="cut_54509072">
<p>Процесс, отображающий иконку в трее:</p>
<ol class="arabic simple">
<li>Дублирует при помощи dup стандартный поток ввода (stdin)</li>
<li>Устанавливает значение названия файла иконки по умолчанию равное
<strong>“icon.png”</strong></li>
<li>Переходит к считыванию команд</li>
<li>Т.к. <strong>stdin</strong> находится в режиме блокировки, то <strong>read</strong> будет
ожидать хотя бы одного символа на входном потоке</li>
<li>Ожидает символы либо <strong>‘I’</strong>, либо <strong>‘s’</strong></li>
<li>Если пришло сообщение <strong>‘s’</strong>, то следующие за ним символы — название
файла с изображением (эту команду возможно вызывать только до
инициализации и сколько угодно раз)</li>
<li>Если пришла команда-символ <strong>‘I’</strong>, то вызывается инициализация
<strong>Gtk</strong> и разблокировка потока (добавляется <em>O_NONBLOCK</em>)</li>
<li>Если инициализация уже была произведена ранее, то в режиме
неблокирующего потока приложение ожидает команды <strong>‘b’</strong>, <strong>‘B’</strong>,
<strong>‘v’</strong>, <strong>‘V’</strong>, <strong>‘Q’</strong>, которыми и управляется</li>
</ol>
<p>Описание команд:</p>
<ul class="simple">
<li><strong>‘I’</strong> — инициализация gtk и показ в трее</li>
<li><strong>‘s’ символы_однобайтные</strong> — установка исходного изображения, название
не обязательно завершать терминирующим нулём</li>
<li><strong>‘b’</strong> — выключить мерцание</li>
<li><strong>‘B’</strong> — включить мерцание</li>
<li><strong>‘v’</strong> — спрятать иконку</li>
<li><strong>‘V’</strong> — показать иконку</li>
<li><strong>‘Q’</strong>  — завершение процесса, уничтожение иконки</li>
</ul>
<p>Затем для этого приложения был написан на Elisp’е код, который связал
<strong>ejabber.el</strong> и «демона трея». Разберём по порядку. Функция
<code class="code">
my-tray-icon-send-command</code>
 умеет отправлять набор символов дочернему
процессу tray_daemon.</p>
<div class="highlight"><pre><span class="pgcss-p">(</span><span class="pgcss-nb">defun</span> <span class="pgcss-nv">my-tray-icon-send-command</span> <span class="pgcss-p">(</span><span class="pgcss-nv">command</span><span class="pgcss-p">)</span>
  <span class="pgcss-p">(</span><span class="pgcss-nv">process-send-string</span> <span class="pgcss-nv">my-tray-icon-process</span> <span class="pgcss-nv">command</span><span class="pgcss-p">)</span>
  <span class="pgcss-p">(</span><span class="pgcss-nv">process-send-eof</span> <span class="pgcss-nv">my-tray-icon-process</span><span class="pgcss-p">))</span>
</pre></div>
<p>Функция <code class="code">
process-send-string</code>
 отправляет строку command процессу
<code class="code">
my-tray-icon-process</code>
, она встроенная в Emacs. А функция
<code class="code">
process-senf-eof</code>
 отправляет сигнал <strong>EOF</strong> во входной поток процесса,
что позволяет процирующему потоку понять, что запись
завершена. <code class="code">
my-tray-icon-send-command</code>
 будет использована, как
базовая для всех функций управления.</p>
<div class="highlight"><pre><span class="pgcss-p">(</span><span class="pgcss-nb">defun</span> <span class="pgcss-nv">my-tray-icon-set</span> <span class="pgcss-p">(</span><span class="pgcss-nv">icon-path</span><span class="pgcss-p">)</span>
  <span class="pgcss-p">(</span><span class="pgcss-nv">my-tray-icon-send-command</span> <span class="pgcss-s">"s"</span><span class="pgcss-p">)</span>
  <span class="pgcss-p">(</span><span class="pgcss-nv">my-tray-icon-send-command</span> <span class="pgcss-nv">icon-path</span><span class="pgcss-p">))</span>
</pre></div>
<p>Функция <em>my-tray-icon-set</em> устанавливает путь к изображению иконки.
Для этого сначала посылается байт ‘s’, а затем строка байтов из
icon-path.</p>
<p>Далее показан код функций для управления демоном в трее и смысл их
аналогичен посылаемому символьному коду:</p>
<div class="highlight"><pre><span class="pgcss-p">(</span><span class="pgcss-nb">defun</span> <span class="pgcss-nv">my-tray-icon-init</span> <span class="pgcss-p">()</span>
  <span class="pgcss-p">(</span><span class="pgcss-nv">my-tray-icon-send-command</span> <span class="pgcss-s">"I"</span><span class="pgcss-p">))</span>

<span class="pgcss-p">(</span><span class="pgcss-nb">defun</span> <span class="pgcss-nv">my-tray-icon-destroy</span> <span class="pgcss-p">()</span>
  <span class="pgcss-p">(</span><span class="pgcss-nv">my-tray-icon-send-command</span> <span class="pgcss-s">"Q"</span><span class="pgcss-p">))</span>

<span class="pgcss-p">(</span><span class="pgcss-nb">defun</span> <span class="pgcss-nv">my-tray-icon-show</span> <span class="pgcss-p">()</span>
  <span class="pgcss-p">(</span><span class="pgcss-nv">my-tray-icon-send-command</span> <span class="pgcss-s">"V"</span><span class="pgcss-p">))</span>

<span class="pgcss-p">(</span><span class="pgcss-nb">defun</span> <span class="pgcss-nv">my-tray-icon-hide</span> <span class="pgcss-p">()</span>
  <span class="pgcss-p">(</span><span class="pgcss-nv">my-tray-icon-send-command</span> <span class="pgcss-s">"v"</span><span class="pgcss-p">))</span>

<span class="pgcss-p">(</span><span class="pgcss-nb">defun</span> <span class="pgcss-nv">my-tray-icon-blink</span> <span class="pgcss-p">()</span>
  <span class="pgcss-p">(</span><span class="pgcss-nv">my-tray-icon-send-command</span> <span class="pgcss-s">"B"</span><span class="pgcss-p">))</span>

<span class="pgcss-p">(</span><span class="pgcss-nb">defun</span> <span class="pgcss-nv">my-tray-icon-no-blink</span> <span class="pgcss-p">()</span>
  <span class="pgcss-p">(</span><span class="pgcss-nv">my-tray-icon-send-command</span> <span class="pgcss-s">"b"</span><span class="pgcss-p">))</span>
</pre></div>
<p>Теперь потребуется описать функцию, которая создаст дочерний
процесс, инициализирует и сконфигурирует демона и установит переменную
<em>my-tray-icon-process</em> с названием процесса:</p>
<div class="highlight"><pre><span class="pgcss-p">(</span><span class="pgcss-nb">defun</span> <span class="pgcss-nv">my-tray-icon-start</span> <span class="pgcss-p">()</span>
  <span class="pgcss-p">(</span><span class="pgcss-k">setq</span> <span class="pgcss-nv">my-tray-icon-process</span> <span class="pgcss-s">"*tray_icon*"</span><span class="pgcss-p">)</span>
  <span class="pgcss-p">(</span><span class="pgcss-k">if</span> <span class="pgcss-p">(</span><span class="pgcss-nv">get-process</span> <span class="pgcss-nv">my-tray-icon-process</span><span class="pgcss-p">)</span>
      <span class="pgcss-p">()</span>
     <span class="pgcss-p">(</span><span class="pgcss-nv">start-process</span> <span class="pgcss-nv">my-tray-icon-process</span> <span class="pgcss-no">nil</span> <span class="pgcss-s">"~/.emacs.d/tray_daemon"</span><span class="pgcss-p">)))</span>
</pre></div>
<p>Демон будет иметь уникальное имя *tray_icon* в Emacs, а при
помощи <em>get-process</em> проверяется, чтобы процесс не был уже запущен, т.к.
нет смысла в двух одинаковых. Но если <strong>*tray_icon*</strong> отсутствует, то
при помощи встроенной функции <em>start-process</em> он запускается. Формат
вызова <em>start-process</em>:</p>
<div class="highlight"><pre><span class="pgcss-p">(</span><span class="pgcss-nv">start-process</span> <span class="pgcss-err">имя</span><span class="pgcss-nb">-</span><span class="pgcss-err">процесса</span><span class="pgcss-nb">-</span><span class="pgcss-err">в</span><span class="pgcss-nv">-Emacs</span> <span class="pgcss-err">буфер</span><span class="pgcss-nb">-</span><span class="pgcss-err">обмена</span> <span class="pgcss-s">"путь_к_файлу_на_диске"</span><span class="pgcss-p">)</span>
</pre></div>
<p>Т.к. обмен с процессом будет происходить последством каналов, то
буфер нужно установить равным nil.</p>
<p>Для того, чтобы обрабатывать прочитанные сообщения и выключать
мерцание иконки в трее я создал функцию <em>my-tray-icon-mesagge-handler</em>:</p>
<div class="highlight"><pre><span class="pgcss-p">(</span><span class="pgcss-nb">defun</span> <span class="pgcss-nv">my-tray-icon-mesagge-handler</span> <span class="pgcss-p">()</span>
  <span class="pgcss-p">(</span><span class="pgcss-nb">when</span> <span class="pgcss-p">(</span><span class="pgcss-nb">and</span> <span class="pgcss-p">(</span><span class="pgcss-nv">get-process</span> <span class="pgcss-nv">my-tray-icon-process</span><span class="pgcss-p">)</span>
  <span class="pgcss-p">(</span><span class="pgcss-nb">equal</span> <span class="pgcss-nv">jabber-activity-count-string</span> <span class="pgcss-s">"0"</span><span class="pgcss-p">))</span>
  <span class="pgcss-p">(</span><span class="pgcss-nv">my-tray-icon-no-blink</span><span class="pgcss-p">)))</span>
</pre></div>
<p>В jabber.el написано, что переменная <code class="code">
jabber-activity-count-string</code>

содержит строковое значение текущего количества пользователей, сообщения
которых ещё не прочитаны. Поэтому нужно её проверить на равество “0” и,
если это так, то убрать мерцание. Этот обработчик вешается как хук на
обновление активности:</p>
<div class="highlight"><pre><span class="pgcss-p">(</span><span class="pgcss-nv">add-hook</span> <span class="pgcss-ss">'jabber-activity-update-hook</span>
  <span class="pgcss-ss">'my-tray-icon-mesagge-handler</span><span class="pgcss-p">)</span>
</pre></div>
<p>Функция обновления активности вызывается в случае, если число
непрочитанных сообщений изменилось. Теперь как только наше приложение
смогло не мерцать, то следует его научить мерцать:</p>
<div class="highlight"><pre><span class="pgcss-p">(</span><span class="pgcss-nb">defun</span> <span class="pgcss-nv">my-show-notification</span> <span class="pgcss-p">(</span><span class="pgcss-nv">from</span> <span class="pgcss-nv">buffer</span> <span class="pgcss-nv">text</span> <span class="pgcss-nv">proposed-alert</span><span class="pgcss-p">)</span>
  <span class="pgcss-p">(</span><span class="pgcss-nb">when</span> <span class="pgcss-p">(</span><span class="pgcss-nb">not</span> <span class="pgcss-p">(</span><span class="pgcss-nb">equal</span> <span class="pgcss-p">(</span><span class="pgcss-nv">get-buffer-window</span> <span class="pgcss-nv">buffer</span> <span class="pgcss-ss">'visible</span><span class="pgcss-p">)</span>
  <span class="pgcss-p">(</span><span class="pgcss-nv">selected-window</span><span class="pgcss-p">)))</span>
  <span class="pgcss-p">(</span><span class="pgcss-nv">jabber-message-osd</span> <span class="pgcss-nv">from</span> <span class="pgcss-nv">buffer</span> <span class="pgcss-nv">text</span> <span class="pgcss-nv">proposed-alert</span><span class="pgcss-p">)</span>
  <span class="pgcss-p">(</span><span class="pgcss-nv">my-tray-icon-blink</span><span class="pgcss-p">)))</span>

<span class="pgcss-p">(</span><span class="pgcss-nv">add-hook</span> <span class="pgcss-ss">'jabber-alert-message-hooks</span>
  <span class="pgcss-ss">'my-show-notification</span><span class="pgcss-p">)</span>
</pre></div>
<p>Обязательно нужно, чтобы функция-обработчик пришедшего сообщения,
которая применяется как хук к <code class="code">
jabber-alert-message-hooks</code>
, принимала 4
параметра: от кого, буфер для общения с этим человеком, текст сообщения,
тип сообщения (отошёл, текст, отключён и т.д.). Чтобы иконка не начинала
мерцать в тот момент, когда пользователь и так видит окно чата с
человеком, то вызывается <code class="code">
(get-buffer-window buffer 'visible)</code>
, с
параметром visible она проверяет виден ли буфер (учитывает даже факт,
что окно свёрнуто, но не учитывает множество рабочих
столов). <code class="code">
(jabber-message-osd from buffer text proposed-alert)</code>
 я
использую, чтобы xosd (треубется скачать osd.el) отображал от кого
пришло сообщение на экране:</p>
<p class="text-center"><a class="reference external" href="http://fotki.yandex.ru/users/imdagger/view/80432/"><img alt="Новое сообщение" src="http://img-fotki.yandex.ru/get/3711/imdagger.3/0_13a30_8fd4035a_L" title="Новое сообщение"/></a></p>
<p>Ну и на закуску мой полный jabber_cfg.el:</p>
<div class="highlight"><pre><span class="pgcss-c1">;; а пароль вводить ручками при к каждом коннекте</span>
<span class="pgcss-c1">;; ну не доверяю я хранить его в открытов виде тут</span>
<span class="pgcss-p">(</span><span class="pgcss-k">setq</span> <span class="pgcss-nv">jabber-account-list</span>
 <span class="pgcss-o">'</span><span class="pgcss-p">((</span><span class="pgcss-s">"имя@ya.ru/emacs"</span>
  <span class="pgcss-p">(</span><span class="pgcss-ss">:network-server</span> <span class="pgcss-o">.</span> <span class="pgcss-s">"сервер"</span><span class="pgcss-p">)</span>
  <span class="pgcss-p">(</span><span class="pgcss-ss">:connection-type</span> <span class="pgcss-o">.</span> <span class="pgcss-nv">ssl</span><span class="pgcss-p">))))</span>

<span class="pgcss-c1">;; раскомментировать, если будет говорить, что переменная</span>
<span class="pgcss-c1">;; my-tray-icon-process не объявлена</span>
<span class="pgcss-c1">;; (setq my-tray-icon-process "*tray_icon*")</span>

<span class="pgcss-p">(</span><span class="pgcss-nb">defun</span> <span class="pgcss-nv">my-tray-icon-send-command</span> <span class="pgcss-p">(</span><span class="pgcss-nv">command</span><span class="pgcss-p">)</span>
  <span class="pgcss-p">(</span><span class="pgcss-nv">process-send-string</span> <span class="pgcss-nv">my-tray-icon-process</span> <span class="pgcss-nv">command</span><span class="pgcss-p">)</span>
  <span class="pgcss-p">(</span><span class="pgcss-nv">process-send-eof</span> <span class="pgcss-nv">my-tray-icon-process</span><span class="pgcss-p">))</span>

<span class="pgcss-p">(</span><span class="pgcss-nb">defun</span> <span class="pgcss-nv">my-tray-icon-set</span> <span class="pgcss-p">(</span><span class="pgcss-nv">icon-path</span><span class="pgcss-p">)</span>
  <span class="pgcss-p">(</span><span class="pgcss-nv">my-tray-icon-send-command</span> <span class="pgcss-s">"s"</span><span class="pgcss-p">)</span>
  <span class="pgcss-p">(</span><span class="pgcss-nv">my-tray-icon-send-command</span> <span class="pgcss-nv">icon-path</span><span class="pgcss-p">))</span>

<span class="pgcss-p">(</span><span class="pgcss-nb">defun</span> <span class="pgcss-nv">my-tray-icon-init</span> <span class="pgcss-p">()</span>
  <span class="pgcss-p">(</span><span class="pgcss-nv">my-tray-icon-send-command</span> <span class="pgcss-s">"I"</span><span class="pgcss-p">))</span>

<span class="pgcss-p">(</span><span class="pgcss-nb">defun</span> <span class="pgcss-nv">my-tray-icon-destroy</span> <span class="pgcss-p">()</span>
  <span class="pgcss-p">(</span><span class="pgcss-nv">my-tray-icon-send-command</span> <span class="pgcss-s">"Q"</span><span class="pgcss-p">))</span>

<span class="pgcss-p">(</span><span class="pgcss-nb">defun</span> <span class="pgcss-nv">my-tray-icon-show</span> <span class="pgcss-p">()</span>
  <span class="pgcss-p">(</span><span class="pgcss-nv">my-tray-icon-send-command</span> <span class="pgcss-s">"V"</span><span class="pgcss-p">))</span>

<span class="pgcss-p">(</span><span class="pgcss-nb">defun</span> <span class="pgcss-nv">my-tray-icon-hide</span> <span class="pgcss-p">()</span>
  <span class="pgcss-p">(</span><span class="pgcss-nv">my-tray-icon-send-command</span> <span class="pgcss-s">"v"</span><span class="pgcss-p">))</span>

<span class="pgcss-p">(</span><span class="pgcss-nb">defun</span> <span class="pgcss-nv">my-tray-icon-blink</span> <span class="pgcss-p">()</span>
  <span class="pgcss-p">(</span><span class="pgcss-nv">my-tray-icon-send-command</span> <span class="pgcss-s">"B"</span><span class="pgcss-p">))</span>

<span class="pgcss-p">(</span><span class="pgcss-nb">defun</span> <span class="pgcss-nv">my-tray-icon-no-blink</span> <span class="pgcss-p">()</span>
  <span class="pgcss-p">(</span><span class="pgcss-nv">my-tray-icon-send-command</span> <span class="pgcss-s">"b"</span><span class="pgcss-p">))</span>

<span class="pgcss-p">(</span><span class="pgcss-nb">defun</span> <span class="pgcss-nv">my-tray-icon-start</span> <span class="pgcss-p">()</span>
  <span class="pgcss-p">(</span><span class="pgcss-k">setq</span> <span class="pgcss-nv">my-tray-icon-process</span> <span class="pgcss-s">"*tray_icon*"</span><span class="pgcss-p">)</span>
  <span class="pgcss-p">(</span><span class="pgcss-k">if</span> <span class="pgcss-p">(</span><span class="pgcss-nv">get-process</span> <span class="pgcss-nv">my-tray-icon-process</span><span class="pgcss-p">)</span>
      <span class="pgcss-p">()</span>
    <span class="pgcss-p">(</span><span class="pgcss-nv">start-process</span> <span class="pgcss-nv">my-tray-icon-process</span> <span class="pgcss-no">nil</span> <span class="pgcss-s">"~/.emacs.d/tray_daemon"</span><span class="pgcss-p">)))</span>

<span class="pgcss-c1">;; подключение скачанной библиотеки</span>
<span class="pgcss-p">(</span><span class="pgcss-nb">require</span> <span class="pgcss-ss">'osd</span><span class="pgcss-p">)</span>

<span class="pgcss-c1">;; настройки для xosd</span>
<span class="pgcss-p">(</span><span class="pgcss-k">setq</span> <span class="pgcss-nv">osd-program-args</span>
  <span class="pgcss-o">'</span><span class="pgcss-p">(</span><span class="pgcss-s">"--pos"</span> <span class="pgcss-s">"bottom"</span>
  <span class="pgcss-s">"--offset"</span> <span class="pgcss-s">"7"</span>
  <span class="pgcss-s">"--align"</span> <span class="pgcss-s">"left"</span>
  <span class="pgcss-s">"--indent"</span> <span class="pgcss-s">"18"</span>
  <span class="pgcss-s">"--delay"</span> <span class="pgcss-s">"3"</span>
  <span class="pgcss-s">"--color"</span> <span class="pgcss-s">"red"</span>
  <span class="pgcss-s">"--shadow"</span> <span class="pgcss-s">"2"</span>
  <span class="pgcss-s">"--shadowcolour"</span> <span class="pgcss-s">"#1e2320"</span>
  <span class="pgcss-s">"--lines"</span> <span class="pgcss-s">"3"</span>
  <span class="pgcss-s">"--font"</span>
  <span class="pgcss-s">"-*-times new roman-medium-r-*-*-24-*-*-*-*-*-*-*"</span><span class="pgcss-p">))</span>

<span class="pgcss-p">(</span><span class="pgcss-nb">require</span> <span class="pgcss-ss">'jabber-autoloads</span><span class="pgcss-p">)</span>

<span class="pgcss-p">(</span><span class="pgcss-nb">defun</span> <span class="pgcss-nv">my-tray-icon-mesagge-handler</span> <span class="pgcss-p">()</span>
  <span class="pgcss-p">(</span><span class="pgcss-nb">when</span> <span class="pgcss-p">(</span><span class="pgcss-nb">and</span> <span class="pgcss-p">(</span><span class="pgcss-nv">get-process</span> <span class="pgcss-nv">my-tray-icon-process</span><span class="pgcss-p">)</span>
  <span class="pgcss-p">(</span><span class="pgcss-nb">equal</span> <span class="pgcss-nv">jabber-activity-count-string</span> <span class="pgcss-s">"0"</span><span class="pgcss-p">))</span>
  <span class="pgcss-p">(</span><span class="pgcss-nv">my-tray-icon-no-blink</span><span class="pgcss-p">)))</span>

<span class="pgcss-p">(</span><span class="pgcss-nv">add-hook</span> <span class="pgcss-ss">'jabber-activity-update-hook</span>
  <span class="pgcss-ss">'my-tray-icon-mesagge-handler</span><span class="pgcss-p">)</span>

<span class="pgcss-p">(</span><span class="pgcss-nv">add-hook</span> <span class="pgcss-ss">'jabber-post-connect-hooks</span>
  <span class="pgcss-p">(</span><span class="pgcss-k">lambda</span> <span class="pgcss-p">(</span><span class="pgcss-nv">connection</span><span class="pgcss-p">)</span>
  <span class="pgcss-p">(</span><span class="pgcss-nv">my-tray-icon-start</span><span class="pgcss-p">)</span>
  <span class="pgcss-p">(</span><span class="pgcss-nv">my-tray-icon-set</span> <span class="pgcss-s">"/home/imdagger/.emacs.d/icon.png"</span><span class="pgcss-p">)</span>
  <span class="pgcss-p">(</span><span class="pgcss-nv">my-tray-icon-init</span><span class="pgcss-p">)</span>
  <span class="pgcss-p">(</span><span class="pgcss-nv">my-tray-icon-show</span><span class="pgcss-p">)))</span>

<span class="pgcss-p">(</span><span class="pgcss-nv">add-hook</span> <span class="pgcss-ss">'jabber-post-disconnect-hook</span>
  <span class="pgcss-p">(</span><span class="pgcss-k">lambda</span> <span class="pgcss-p">()</span>
  <span class="pgcss-p">(</span><span class="pgcss-nv">my-tray-icon-hide</span><span class="pgcss-p">)</span>
  <span class="pgcss-p">(</span><span class="pgcss-nv">my-tray-icon-destroy</span><span class="pgcss-p">)))</span>

<span class="pgcss-p">(</span><span class="pgcss-nb">defun</span> <span class="pgcss-nv">my-show-notification</span> <span class="pgcss-p">(</span><span class="pgcss-nv">from</span> <span class="pgcss-nv">buffer</span> <span class="pgcss-nv">text</span> <span class="pgcss-nv">proposed-alert</span><span class="pgcss-p">)</span>
  <span class="pgcss-p">(</span><span class="pgcss-nb">when</span> <span class="pgcss-p">(</span><span class="pgcss-nb">not</span> <span class="pgcss-p">(</span><span class="pgcss-nb">equal</span> <span class="pgcss-p">(</span><span class="pgcss-nv">get-buffer-window</span> <span class="pgcss-nv">buffer</span> <span class="pgcss-ss">'visible</span><span class="pgcss-p">)</span>
  <span class="pgcss-p">(</span><span class="pgcss-nv">selected-window</span><span class="pgcss-p">)))</span>
  <span class="pgcss-p">(</span><span class="pgcss-nv">jabber-message-osd</span> <span class="pgcss-nv">from</span> <span class="pgcss-nv">buffer</span> <span class="pgcss-nv">text</span> <span class="pgcss-nv">proposed-alert</span><span class="pgcss-p">)</span>
  <span class="pgcss-p">(</span><span class="pgcss-nv">my-tray-icon-blink</span><span class="pgcss-p">)))</span>

<span class="pgcss-p">(</span><span class="pgcss-nv">add-hook</span> <span class="pgcss-ss">'jabber-alert-message-hooks</span>
  <span class="pgcss-ss">'my-show-notification</span><span class="pgcss-p">)</span>

<span class="pgcss-c1">;; хуки на изменение статуса и отображение через xosd</span>
<span class="pgcss-p">(</span><span class="pgcss-nv">add-hook</span> <span class="pgcss-ss">'jabber-alert-muc-hooks</span> <span class="pgcss-ss">'jabber-muc-osd</span><span class="pgcss-p">)</span>
<span class="pgcss-p">(</span><span class="pgcss-nv">add-hook</span> <span class="pgcss-ss">'jabber-alert-presence-hooks</span> <span class="pgcss-ss">'jabber-presence-osd</span><span class="pgcss-p">)</span>

<span class="pgcss-c1">;; нам не нужная отладочная информация</span>
<span class="pgcss-c1">;; включим, когда будем что-то дорабатывать в jabber.el</span>
<span class="pgcss-p">(</span><span class="pgcss-k">setq</span> <span class="pgcss-nv">fsm-debug</span> <span class="pgcss-no">nil</span><span class="pgcss-p">)</span>

<span class="pgcss-c1">;; параметры для истории, вида и др.</span>
<span class="pgcss-p">(</span><span class="pgcss-k">setq</span> <span class="pgcss-nv">jabber-history-enabled</span> <span class="pgcss-no">t</span>
  <span class="pgcss-nv">jabber-use-global-history</span> <span class="pgcss-no">nil</span>
  <span class="pgcss-nv">jabber-history-dir</span> <span class="pgcss-s">"~/.emacs.d/jabber/"</span>
  <span class="pgcss-nv">jabber-chatstates-confirm</span> <span class="pgcss-no">t</span>
  <span class="pgcss-nv">jabber-events-confirm-composing</span> <span class="pgcss-no">t</span>
  <span class="pgcss-nv">jabber-chat-time-format</span> <span class="pgcss-s">"%a %d %b %H:%M:%S"</span>
  <span class="pgcss-nv">jabber-backlog-number</span> <span class="pgcss-mi">50</span><span class="pgcss-p">)</span>

<span class="pgcss-c1">;; быстрое переключение к буфферу с сообщением</span>
<span class="pgcss-p">(</span><span class="pgcss-nv">global-set-key</span> <span class="pgcss-nv">[S-f12]</span> <span class="pgcss-ss">'jabber-activity-switch-to</span><span class="pgcss-p">)</span>
</pre></div>
</div>                </div>
            </div>
            <div class="row comments-row">
                <span><a class="pseudo-link b-candy b-comment-shortcut"><i class="b-ico"></i>ответить</a></span>
            </div>
        </div>
    </div>
</div>        <div class="panel panel-default">
            <div class="panel-body more">
                <span class="less-prev"><a class="h-link" href="http://imdagger.github.io/category/text68.html">Назад</a></span>
                <span class="more-next"><a class="h-link" href="http://imdagger.github.io/category/text70.html">Ещё записи</a></span>
            </div>
        </div>
    </div>
</div>
        </div>
    </body>
</html>